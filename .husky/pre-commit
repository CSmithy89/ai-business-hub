#!/bin/sh

echo "üîç Running pre-commit checks..."

# Exit on first error
set -e

# 1. TypeScript type checking
echo ""
echo "üìò Running TypeScript type check..."
pnpm type-check
echo "‚úÖ TypeScript check passed"

# 2. ESLint via lint-staged (only staged files)
echo ""
echo "üîß Running ESLint on staged files..."
pnpm exec lint-staged
echo "‚úÖ Lint check passed"

# 3. Semgrep security scan (on staged files only)
echo ""
echo "üîí Running Semgrep security scan..."

# Get list of staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    # Run Semgrep on staged files with auto config
    echo "$STAGED_FILES" | xargs semgrep scan --config auto --error --quiet 2>/dev/null || {
        echo "‚ùå Semgrep found security issues. Please fix them before committing."
        exit 1
    }
    echo "‚úÖ Security scan passed"
else
    echo "‚è≠Ô∏è  No JS/TS files to scan"
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
