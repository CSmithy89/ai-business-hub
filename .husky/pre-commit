#!/bin/sh

echo "üîç Running pre-commit checks..."

# Exit on first error
set -e

# 1. TypeScript type checking
echo ""
echo "üìò Running TypeScript type check..."
pnpm type-check
echo "‚úÖ TypeScript check passed"

# 2. ESLint via lint-staged (only staged files)
echo ""
echo "üîß Running ESLint on staged files..."
pnpm exec lint-staged
echo "‚úÖ Lint check passed"

# 3. Semgrep security scan (on staged files only)
echo ""
echo "üîí Running Semgrep security scan..."

# Check if Semgrep is installed
if ! command -v semgrep &> /dev/null; then
    echo "‚ö†Ô∏è  Semgrep not installed. Skipping security scan."
    echo "   Install with: pip install semgrep"
else
    # Get list of staged TypeScript/JavaScript files (including renamed files)
    # Use null-terminated strings for safe handling of filenames with spaces/special chars
    STAGED_FILES=$(git diff --cached --name-only -z --diff-filter=ACMR | tr '\0' '\n' | grep -E '\.(ts|tsx|js|jsx)$' || true)

    if [ -n "$STAGED_FILES" ]; then
        # Run Semgrep on staged files with auto config
        # Use -z and xargs -0 for safe filename handling, -r to skip if no files
        git diff --cached --name-only -z --diff-filter=ACMR | grep -zE '\.(ts|tsx|js|jsx)$' | xargs -0 -r semgrep scan --config auto --error --quiet || {
            echo "‚ùå Semgrep found security issues. Please fix them before committing."
            exit 1
        }
        echo "‚úÖ Security scan passed"
    else
        echo "‚è≠Ô∏è  No JS/TS files to scan"
    fi
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
