#!/bin/sh

echo "ğŸ” Running pre-commit checks..."

# Exit on first error
set -e

# 1. TypeScript type checking
echo ""
echo "ğŸ“˜ Running TypeScript type check..."
pnpm type-check
echo "âœ… TypeScript check passed"

# 2. ESLint via lint-staged (only staged files)
echo ""
echo "ğŸ”§ Running ESLint on staged files..."
pnpm exec lint-staged
echo "âœ… Lint check passed"

# 3. Semgrep security scan (on staged files only)
echo ""
echo "ğŸ”’ Running Semgrep security scan..."

# Get list of staged TypeScript/JavaScript files (including renamed files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    # Run Semgrep on staged files with auto config
    # Note: -- separates options from file paths to prevent files starting with - from being treated as flags
    echo "$STAGED_FILES" | xargs semgrep scan --config auto --error --quiet -- || {
        echo "âŒ Semgrep found security issues. Please fix them before committing."
        exit 1
    }
    echo "âœ… Security scan passed"
else
    echo "â­ï¸  No JS/TS files to scan"
fi

echo ""
echo "âœ… All pre-commit checks passed!"
