{
  "testModules": [
    {
      "moduleId": "tests/test_rate_limit.py",
      "tests": [
        {
          "name": "test_rate_limit_blocks_after_threshold",
          "fullName": "tests/test_rate_limit.py::test_rate_limit_blocks_after_threshold",
          "state": "failed",
          "errors": [
            {
              "message": "+ Exception Group Traceback (most recent call last):\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 79, in collapse_excgroups\n  |     yield\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 192, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/_backends/_asyncio.py\", line 783, in __aexit__\n  |     raise BaseExceptionGroup(\n  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 344, in from_call\n    |     result: TResult | None = func()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 246, in <lambda>\n    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/logging.py\", line 850, in pytest_runtest_call\n    |     yield\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/capture.py\", line 900, in pytest_runtest_call\n    |     return (yield)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/skipping.py\", line 263, in pytest_runtest_call\n    |     return (yield)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 178, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/python.py\", line 1671, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/python.py\", line 157, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |   File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 42, in test_rate_limit_blocks_after_threshold\n    |     assert client.post(\"/agents/test\", headers=headers).status_code == 200\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 546, in post\n    |     return super().post(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1144, in post\n    |     return self.request(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 445, in request\n    |     return super().request(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 825, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 914, in send\n    |     response = self._send_handling_auth(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 942, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 979, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1014, in _send_single_request\n    |     response = transport.handle_request(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 348, in handle_request\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 345, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 326, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |   File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 458, in result\n    |     return self.__get_result()\n    |   File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    |     raise self._exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 257, in _call_func\n    |     retval = await retval_or_awaitable\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py\", line 1135, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py\", line 107, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     with recv_stream, send_stream, collapse_excgroups():\n    |   File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    |     self.gen.throw(typ, value, traceback)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py\", line 128, in dispatch\n    |     return await call_next(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    |     raise app_exc from app_exc.__cause__ or app_exc.__context__\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     with recv_stream, send_stream, collapse_excgroups():\n    |   File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    |     self.gen.throw(typ, value, traceback)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |   File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 21, in dispatch\n    |     return await call_next(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    |     raise app_exc from app_exc.__cause__ or app_exc.__context__\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 716, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 736, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 290, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 115, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 101, in app\n    |     response = await f(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 355, in app\n    |     raw_response = await run_endpoint_function(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 732, in async_wrapper\n    |     self._check_request_limit(request, func, False)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 630, in _check_request_limit\n    |     self.__evaluate_limits(request, _endpoint_key, all_limits)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 499, in __evaluate_limits\n    |     limit_key = lim.key_func()\n    | TypeError: _rate_limit_key() missing 1 required positional argument: 'req'\n    +------------------------------------\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 42, in test_rate_limit_blocks_after_threshold\n    assert client.post(\"/agents/test\", headers=headers).status_code == 200\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 546, in post\n    return super().post(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1144, in post\n    return self.request(\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 445, in request\n    return super().request(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 914, in send\n    response = self._send_handling_auth(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 348, in handle_request\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 345, in handle_request\n    portal.call(self.app, scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 326, in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n  File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 458, in result\n    return self.__get_result()\n  File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    raise self._exception\n  File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 257, in _call_func\n    retval = await retval_or_awaitable\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py\", line 1135, in __call__\n    await super().__call__(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py\", line 107, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n  File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    self.gen.throw(typ, value, traceback)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py\", line 128, in dispatch\n    return await call_next(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n  File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    self.gen.throw(typ, value, traceback)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n  File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 21, in dispatch\n    return await call_next(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 732, in async_wrapper\n    self._check_request_limit(request, func, False)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 630, in _check_request_limit\n    self.__evaluate_limits(request, _endpoint_key, all_limits)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 499, in __evaluate_limits\n    limit_key = lim.key_func()\nTypeError: _rate_limit_key() missing 1 required positional argument: 'req'\n\nThe above exception was the direct cause of the following exception:\ntests/test_rate_limit.py:42: in test_rate_limit_blocks_after_threshold\n    assert client.post(\"/agents/test\", headers=headers).status_code == 200\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:546: in post\n    return super().post(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:1144: in post\n    return self.request(\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:445: in request\n    return super().request(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:825: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:914: in send\n    response = self._send_handling_auth(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:942: in _send_handling_auth\n    response = self._send_handling_redirects(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:979: in _send_handling_redirects\n    response = self._send_single_request(request)\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:1014: in _send_single_request\n    response = transport.handle_request(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:348: in handle_request\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:345: in handle_request\n    portal.call(self.app, scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py:326: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/usr/lib/python3.10/concurrent/futures/_base.py:458: in result\n    return self.__get_result()\n/usr/lib/python3.10/concurrent/futures/_base.py:403: in __get_result\n    raise self._exception\n/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py:257: in _call_func\n    retval = await retval_or_awaitable\n/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py:1135: in __call__\n    await super().__call__(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py:107: in __call__\n    await self.middleware_stack(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:191: in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n/usr/lib/python3.10/contextlib.py:153: in __exit__\n    self.gen.throw(typ, value, traceback)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py:85: in collapse_excgroups\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:193: in __call__\n    response = await self.dispatch_func(request, call_next)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py:128: in dispatch\n    return await call_next(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:168: in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:144: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:191: in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n/usr/lib/python3.10/contextlib.py:153: in __exit__\n    self.gen.throw(typ, value, traceback)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py:85: in collapse_excgroups\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:193: in __call__\n    response = await self.dispatch_func(request, call_next)\ntests/test_rate_limit.py:21: in dispatch\n    return await call_next(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:168: in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:144: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py:63: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:42: in wrapped_app\n    await app(scope, receive, sender)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__\n    await self.app(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:716: in __call__\n    await self.middleware_stack(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:736: in app\n    await route.handle(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:290: in handle\n    await self.app(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:115: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:42: in wrapped_app\n    await app(scope, receive, sender)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:101: in app\n    response = await f(request)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:355: in app\n    raw_response = await run_endpoint_function(\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:243: in run_endpoint_function\n    return await dependant.call(**values)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:732: in async_wrapper\n    self._check_request_limit(request, func, False)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:630: in _check_request_limit\n    self.__evaluate_limits(request, _endpoint_key, all_limits)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:499: in __evaluate_limits\n    limit_key = lim.key_func()\nE   TypeError: _rate_limit_key() missing 1 required positional argument: 'req'"
            }
          ]
        },
        {
          "name": "test_rate_limit_keys_by_identity_not_ip",
          "fullName": "tests/test_rate_limit.py::test_rate_limit_keys_by_identity_not_ip",
          "state": "failed",
          "errors": [
            {
              "message": "+ Exception Group Traceback (most recent call last):\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 79, in collapse_excgroups\n  |     yield\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 192, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/_backends/_asyncio.py\", line 783, in __aexit__\n  |     raise BaseExceptionGroup(\n  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 344, in from_call\n    |     result: TResult | None = func()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 246, in <lambda>\n    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/logging.py\", line 850, in pytest_runtest_call\n    |     yield\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/capture.py\", line 900, in pytest_runtest_call\n    |     return (yield)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/skipping.py\", line 263, in pytest_runtest_call\n    |     return (yield)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/runner.py\", line 178, in pytest_runtest_call\n    |     item.runtest()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/python.py\", line 1671, in runtest\n    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_hooks.py\", line 512, in __call__\n    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_manager.py\", line 120, in _hookexec\n    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 167, in _multicall\n    |     raise exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 139, in _multicall\n    |     teardown.throw(exception)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 53, in run_old_style_hookwrapper\n    |     return result.get_result()\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_result.py\", line 103, in get_result\n    |     raise exc.with_traceback(tb)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 38, in run_old_style_hookwrapper\n    |     res = yield\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/pluggy/_callers.py\", line 121, in _multicall\n    |     res = hook_impl.function(*args)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/_pytest/python.py\", line 157, in pytest_pyfunc_call\n    |     result = testfunction(**testargs)\n    |   File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 56, in test_rate_limit_keys_by_identity_not_ip\n    |     assert client.post(\"/agents/test\", headers=headers_user1).status_code == 200\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 546, in post\n    |     return super().post(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1144, in post\n    |     return self.request(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 445, in request\n    |     return super().request(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 825, in request\n    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 914, in send\n    |     response = self._send_handling_auth(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 942, in _send_handling_auth\n    |     response = self._send_handling_redirects(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 979, in _send_handling_redirects\n    |     response = self._send_single_request(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1014, in _send_single_request\n    |     response = transport.handle_request(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 348, in handle_request\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 345, in handle_request\n    |     portal.call(self.app, scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 326, in call\n    |     return cast(T_Retval, self.start_task_soon(func, *args).result())\n    |   File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 458, in result\n    |     return self.__get_result()\n    |   File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    |     raise self._exception\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 257, in _call_func\n    |     retval = await retval_or_awaitable\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py\", line 1135, in __call__\n    |     await super().__call__(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py\", line 107, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     with recv_stream, send_stream, collapse_excgroups():\n    |   File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    |     self.gen.throw(typ, value, traceback)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py\", line 128, in dispatch\n    |     return await call_next(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    |     raise app_exc from app_exc.__cause__ or app_exc.__context__\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    |     with recv_stream, send_stream, collapse_excgroups():\n    |   File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    |     self.gen.throw(typ, value, traceback)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    |     response = await self.dispatch_func(request, call_next)\n    |   File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 21, in dispatch\n    |     return await call_next(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    |     raise app_exc from app_exc.__cause__ or app_exc.__context__\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 716, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 736, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 290, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 115, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 101, in app\n    |     response = await f(request)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 355, in app\n    |     raw_response = await run_endpoint_function(\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    |     return await dependant.call(**values)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 732, in async_wrapper\n    |     self._check_request_limit(request, func, False)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 630, in _check_request_limit\n    |     self.__evaluate_limits(request, _endpoint_key, all_limits)\n    |   File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 499, in __evaluate_limits\n    |     limit_key = lim.key_func()\n    | TypeError: _rate_limit_key() missing 1 required positional argument: 'req'\n    +------------------------------------\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 56, in test_rate_limit_keys_by_identity_not_ip\n    assert client.post(\"/agents/test\", headers=headers_user1).status_code == 200\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 546, in post\n    return super().post(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1144, in post\n    return self.request(\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 445, in request\n    return super().request(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 825, in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 914, in send\n    response = self._send_handling_auth(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 942, in _send_handling_auth\n    response = self._send_handling_redirects(\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 979, in _send_handling_redirects\n    response = self._send_single_request(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py\", line 1014, in _send_single_request\n    response = transport.handle_request(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 348, in handle_request\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py\", line 345, in handle_request\n    portal.call(self.app, scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 326, in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n  File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 458, in result\n    return self.__get_result()\n  File \"/usr/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    raise self._exception\n  File \"/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py\", line 257, in _call_func\n    retval = await retval_or_awaitable\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py\", line 1135, in __call__\n    await super().__call__(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py\", line 107, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 186, in __call__\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n  File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    self.gen.throw(typ, value, traceback)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py\", line 128, in dispatch\n    return await call_next(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 191, in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n  File \"/usr/lib/python3.10/contextlib.py\", line 153, in __exit__\n    self.gen.throw(typ, value, traceback)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 193, in __call__\n    response = await self.dispatch_func(request, call_next)\n  File \"/home/chris/projects/work/Ai Bussiness Hub/agents/tests/test_rate_limit.py\", line 21, in dispatch\n    return await call_next(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 168, in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 115, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 101, in app\n    response = await f(request)\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 355, in app\n    raw_response = await run_endpoint_function(\n  File \"/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py\", line 243, in run_endpoint_function\n    return await dependant.call(**values)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 732, in async_wrapper\n    self._check_request_limit(request, func, False)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 630, in _check_request_limit\n    self.__evaluate_limits(request, _endpoint_key, all_limits)\n  File \"/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py\", line 499, in __evaluate_limits\n    limit_key = lim.key_func()\nTypeError: _rate_limit_key() missing 1 required positional argument: 'req'\n\nThe above exception was the direct cause of the following exception:\ntests/test_rate_limit.py:56: in test_rate_limit_keys_by_identity_not_ip\n    assert client.post(\"/agents/test\", headers=headers_user1).status_code == 200\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:546: in post\n    return super().post(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:1144: in post\n    return self.request(\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:445: in request\n    return super().request(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:825: in request\n    return self.send(request, auth=auth, follow_redirects=follow_redirects)\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:914: in send\n    response = self._send_handling_auth(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:942: in _send_handling_auth\n    response = self._send_handling_redirects(\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:979: in _send_handling_redirects\n    response = self._send_single_request(request)\n/home/chris/.local/lib/python3.10/site-packages/httpx/_client.py:1014: in _send_single_request\n    response = transport.handle_request(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:348: in handle_request\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/testclient.py:345: in handle_request\n    portal.call(self.app, scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py:326: in call\n    return cast(T_Retval, self.start_task_soon(func, *args).result())\n/usr/lib/python3.10/concurrent/futures/_base.py:458: in result\n    return self.__get_result()\n/usr/lib/python3.10/concurrent/futures/_base.py:403: in __get_result\n    raise self._exception\n/home/chris/.local/lib/python3.10/site-packages/anyio/from_thread.py:257: in _call_func\n    retval = await retval_or_awaitable\n/home/chris/.local/lib/python3.10/site-packages/fastapi/applications.py:1135: in __call__\n    await super().__call__(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/applications.py:107: in __call__\n    await self.middleware_stack(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py:186: in __call__\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/errors.py:164: in __call__\n    await self.app(scope, receive, _send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:191: in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n/usr/lib/python3.10/contextlib.py:153: in __exit__\n    self.gen.throw(typ, value, traceback)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py:85: in collapse_excgroups\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:193: in __call__\n    response = await self.dispatch_func(request, call_next)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/middleware.py:128: in dispatch\n    return await call_next(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:168: in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:144: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:191: in __call__\n    with recv_stream, send_stream, collapse_excgroups():\n/usr/lib/python3.10/contextlib.py:153: in __exit__\n    self.gen.throw(typ, value, traceback)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_utils.py:85: in collapse_excgroups\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:193: in __call__\n    response = await self.dispatch_func(request, call_next)\ntests/test_rate_limit.py:21: in dispatch\n    return await call_next(request)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:168: in call_next\n    raise app_exc from app_exc.__cause__ or app_exc.__context__\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/base.py:144: in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n/home/chris/.local/lib/python3.10/site-packages/starlette/middleware/exceptions.py:63: in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:42: in wrapped_app\n    await app(scope, receive, sender)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__\n    await self.app(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:716: in __call__\n    await self.middleware_stack(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:736: in app\n    await route.handle(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/routing.py:290: in handle\n    await self.app(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:115: in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:53: in wrapped_app\n    raise exc\n/home/chris/.local/lib/python3.10/site-packages/starlette/_exception_handler.py:42: in wrapped_app\n    await app(scope, receive, sender)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:101: in app\n    response = await f(request)\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:355: in app\n    raw_response = await run_endpoint_function(\n/home/chris/.local/lib/python3.10/site-packages/fastapi/routing.py:243: in run_endpoint_function\n    return await dependant.call(**values)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:732: in async_wrapper\n    self._check_request_limit(request, func, False)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:630: in _check_request_limit\n    self.__evaluate_limits(request, _endpoint_key, all_limits)\n/home/chris/.local/lib/python3.10/site-packages/slowapi/extension.py:499: in __evaluate_limits\n    limit_key = lim.key_func()\nE   TypeError: _rate_limit_key() missing 1 required positional argument: 'req'"
            }
          ]
        }
      ]
    }
  ]
}