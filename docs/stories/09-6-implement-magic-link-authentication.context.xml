<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>09-6-implement-magic-link-authentication</story-id>
    <epic>EPIC-09: UI &amp; Authentication Enhancements</epic>
    <title>Implement Magic Link Authentication</title>
    <points>3</points>
    <priority>P3</priority>
    <status>ready-for-dev</status>
    <generated>2025-12-05</generated>
  </metadata>

  <objectives>
    <primary>
      Implement passwordless magic link authentication using better-auth magicLink plugin
    </primary>
    <secondary>
      - Allow users to sign in via email link (no password required)
      - Support both existing users and new user registration
      - Send branded magic link emails via Resend
      - Implement secure token generation and verification
      - Handle token expiry and single-use invalidation
    </secondary>
  </objectives>

  <acceptance-criteria>
    <criterion id="1" status="pending">
      Add "Email me a login link" option on sign-in page
    </criterion>
    <criterion id="2" status="pending">
      Generate secure magic link token (15 min expiry)
    </criterion>
    <criterion id="3" status="pending">
      Send magic link email via Resend
    </criterion>
    <criterion id="4" status="pending">
      Create magic link verification page
    </criterion>
    <criterion id="5" status="pending">
      Auto-sign in user when link clicked
    </criterion>
    <criterion id="6" status="pending">
      Invalidate token after use
    </criterion>
  </acceptance-criteria>

  <implementation-guide>
    <section title="1. Server Configuration (better-auth)">
      <file path="apps/web/src/lib/auth.ts">
        <action>Add magicLink plugin to better-auth configuration</action>
        <code-example language="typescript"><![CDATA[
import { betterAuth } from 'better-auth'
import { prismaAdapter } from 'better-auth/adapters/prisma'
import { organization, twoFactor, magicLink } from 'better-auth/plugins'
import { prisma } from '@hyvve/db'
import { sendVerificationEmail, sendPasswordResetEmail, sendMagicLinkEmail } from './email'

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: 'postgresql',
  }),

  session: {
    expiresIn: 60 * 60 * 24 * 7,      // 7 days (default)
    updateAge: 60 * 60 * 24,          // Refresh daily
    cookieCache: {
      enabled: true,
      maxAge: 60 * 15,                // 15 minutes
    },
  },

  secret: process.env.BETTER_AUTH_SECRET!,
  baseURL: process.env.BETTER_AUTH_URL!,

  plugins: [
    organization({
      allowUserToCreateOrganization: true,
    }),
    twoFactor({
      issuer: 'HYVVE',
    }),
    // NEW: Magic Link Plugin
    magicLink({
      sendMagicLink: async ({ email, token, url }, ctx) => {
        await sendMagicLinkEmail(email, url, token)
      },
      expiresIn: 900, // 15 minutes (900 seconds)
      disableSignUp: false, // Allow new users to sign up via magic link
    }),
  ],

  emailAndPassword: {
    enabled: true,
    requireEmailVerification: false,
    sendVerificationEmail: async ({ user, token }: { user: any; url: string; token: string }) => {
      await sendVerificationEmail(user.email, token, user.name)
    },
    sendResetPassword: async ({ user, token }: { user: any; token: string; url: string }) => {
      await sendPasswordResetEmail(user.email, token)
    },
    resetPasswordExpiresIn: 3600,
  },

  advanced: {
    cookiePrefix: 'hyvve',
    crossSubDomainCookies: {
      enabled: false,
    },
  },

  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      redirectURI: `${process.env.BETTER_AUTH_URL}/api/auth/callback/google`,
    },
    microsoft: {
      clientId: process.env.MICROSOFT_CLIENT_ID!,
      clientSecret: process.env.MICROSOFT_CLIENT_SECRET!,
      redirectURI: `${process.env.BETTER_AUTH_URL}/api/auth/callback/microsoft`,
    },
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      redirectURI: `${process.env.BETTER_AUTH_URL}/api/auth/callback/github`,
    },
  },
})

export type Auth = typeof auth
]]></code-example>
      </file>
    </section>

    <section title="2. Email Service Extension">
      <file path="apps/web/src/lib/email.ts">
        <action>Add sendMagicLinkEmail function to email service</action>
        <code-example language="typescript"><![CDATA[
/**
 * Send magic link email
 *
 * @param to - Recipient email address
 * @param url - Full magic link URL with token
 * @param token - Raw token for logging in dev mode
 * @returns Promise that resolves when email is sent
 */
export async function sendMagicLinkEmail(
  to: string,
  url: string,
  token: string
): Promise<void> {
  // For local development
  if (!process.env.RESEND_API_KEY || process.env.RESEND_API_KEY === 'test') {
    console.log('\nüìß Magic Link Email (Local Dev Mode)')
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    console.log(`To: ${to}`)
    console.log(`Subject: Your Sign-In Link for HYVVE`)
    console.log(`Magic Link URL: ${url}`)
    console.log(`Token: ${token}`)
    console.log(`Expires: 15 minutes`)
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n')
    return
  }

  try {
    const { data, error } = await resend.emails.send({
      from: EMAIL_CONFIG.from,
      to,
      replyTo: EMAIL_CONFIG.replyTo,
      subject: 'Your Sign-In Link for HYVVE',
      html: `
        <div style="font-family: system-ui, -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 40px 20px;">
          <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="color: #111827; font-size: 24px; margin: 0;">Sign in to HYVVE</h1>
          </div>

          <div style="background-color: #f9fafb; border-radius: 12px; padding: 32px; margin-bottom: 32px;">
            <p style="color: #374151; font-size: 16px; line-height: 1.6; margin: 0 0 24px 0;">
              Hello,
            </p>
            <p style="color: #374151; font-size: 16px; line-height: 1.6; margin: 0 0 24px 0;">
              Click the button below to sign in to your HYVVE account:
            </p>

            <div style="text-align: center; margin: 32px 0;">
              <a href="${url}"
                 style="display: inline-block; background-color: #FF6B6B; color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                Sign In to HYVVE
              </a>
            </div>

            <p style="color: #6b7280; font-size: 14px; line-height: 1.6; margin: 0;">
              Or copy and paste this link into your browser:
            </p>
            <p style="color: #4f46e5; font-size: 14px; word-break: break-all; margin: 8px 0 0 0;">
              ${url}
            </p>
          </div>

          <div style="background-color: #fef2f2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 32px; border-radius: 4px;">
            <p style="color: #991b1b; font-size: 14px; line-height: 1.6; margin: 0; font-weight: 600;">
              ‚è±Ô∏è This link expires in 15 minutes
            </p>
          </div>

          <div style="border-top: 1px solid #e5e7eb; padding-top: 24px;">
            <p style="color: #9ca3af; font-size: 12px; line-height: 1.6; margin: 0;">
              If you didn't request this sign-in link, you can safely ignore this email.
              The link will expire automatically.
            </p>
            <p style="color: #9ca3af; font-size: 12px; margin: 16px 0 0 0;">
              This is an automated message from HYVVE. Please do not reply to this email.
            </p>
          </div>
        </div>
      `,
    })

    if (error) {
      console.error('Failed to send magic link email:', error)
      throw new Error(`Email sending failed: ${error.message}`)
    }

    console.log('Magic link email sent successfully:', data?.id)
  } catch (error) {
    console.error('Error sending magic link email:', error)
    throw error
  }
}
]]></code-example>
      </file>
    </section>

    <section title="3. Client Configuration">
      <file path="apps/web/src/lib/auth-client.ts">
        <action>Add magicLinkClient plugin to auth client</action>
        <code-example language="typescript"><![CDATA[
'use client'

import { createAuthClient } from 'better-auth/react'
import { magicLinkClient } from 'better-auth/client/plugins'

export const authClient = createAuthClient({
  baseURL: typeof window !== 'undefined' ? window.location.origin : 'http://localhost:3000',
  plugins: [
    magicLinkClient(),
  ],
})

// ... existing functions (signUp, signIn, signOut, etc.)

/**
 * Request magic link to be sent to email
 *
 * @param email - Email address to send magic link
 * @param callbackURL - URL to redirect after successful sign-in (default: /dashboard)
 * @returns Promise with success/error status
 */
export async function sendMagicLink(data: {
  email: string
  callbackURL?: string
}) {
  return authClient.signIn.magicLink({
    email: data.email,
    callbackURL: data.callbackURL || '/dashboard',
  })
}
]]></code-example>
      </file>
    </section>

    <section title="4. Magic Link Request Form Component">
      <file path="apps/web/src/components/auth/magic-link-form.tsx">
        <action>Create new component for requesting magic link</action>
        <code-example language="typescript"><![CDATA[
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { standardSchemaResolver } from '@hookform/resolvers/standard-schema'
import { z } from 'zod'
import { sendMagicLink } from '@/lib/auth-client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Loader2, AlertCircle, CheckCircle2, Mail } from 'lucide-react'
import Link from 'next/link'

// Validation schema
const magicLinkSchema = z.object({
  email: z.string().email('Please enter a valid email address'),
})

type MagicLinkFormData = z.infer<typeof magicLinkSchema>

export function MagicLinkForm() {
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)
  const [emailSent, setEmailSent] = useState('')

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<MagicLinkFormData>({
    resolver: standardSchemaResolver(magicLinkSchema),
    mode: 'onBlur',
  })

  const onSubmit = async (data: MagicLinkFormData) => {
    setIsSubmitting(true)
    setError(null)
    setSuccess(false)

    try {
      const result = await sendMagicLink({
        email: data.email,
        callbackURL: '/dashboard',
      })

      if (result.error) {
        const errorMessage = result.error.message?.toLowerCase() || ''
        if (errorMessage.includes('rate limit') || errorMessage.includes('too many')) {
          setError('Too many requests. Please try again in a few minutes.')
        } else {
          setError('Failed to send magic link. Please try again.')
        }
      } else {
        setSuccess(true)
        setEmailSent(data.email)
      }
    } catch (err) {
      console.error('Magic link error:', err)
      setError('Unable to send magic link. Please check your connection and try again.')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div className="space-y-2 text-center">
        <div className="mx-auto w-12 h-12 bg-[#FF6B6B]/10 rounded-full flex items-center justify-center mb-4">
          <Mail className="w-6 h-6 text-[#FF6B6B]" />
        </div>
        <h1 className="text-3xl font-bold text-gray-900">Sign in with Magic Link</h1>
        <p className="text-gray-600">
          We&apos;ll email you a link to sign in instantly
        </p>
      </div>

      {success ? (
        /* Success State */
        <div className="space-y-4">
          <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex items-start gap-3">
              <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
              <div className="flex-1">
                <h3 className="text-sm font-semibold text-green-900 mb-1">
                  Check your email
                </h3>
                <p className="text-sm text-green-700">
                  We&apos;ve sent a sign-in link to <strong>{emailSent}</strong>
                </p>
                <p className="text-sm text-green-700 mt-2">
                  The link will expire in 15 minutes. Check your spam folder if you don&apos;t see it.
                </p>
              </div>
            </div>
          </div>

          <div className="text-center text-sm text-gray-600">
            <button
              onClick={() => {
                setSuccess(false)
                setEmailSent('')
              }}
              className="text-[#FF6B6B] hover:underline font-medium"
            >
              Send to a different email
            </button>
          </div>
        </div>
      ) : (
        /* Form */
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Error Banner */}
          {error && (
            <div className="p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
              <p className="text-sm text-red-600">{error}</p>
            </div>
          )}

          {/* Email Field */}
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              type="email"
              placeholder="you@company.com"
              {...register('email')}
              disabled={isSubmitting}
              aria-invalid={errors.email ? 'true' : 'false'}
            />
            {errors.email && (
              <p className="text-sm text-red-600">{errors.email.message}</p>
            )}
          </div>

          {/* Submit Button */}
          <Button
            type="submit"
            className="w-full bg-[#FF6B6B] hover:bg-[#FF6B6B]/90"
            disabled={isSubmitting}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Sending Magic Link...
              </>
            ) : (
              'Send Magic Link'
            )}
          </Button>
        </form>
      )}

      {/* Divider */}
      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-white px-2 text-gray-500">Or</span>
        </div>
      </div>

      {/* Navigation Links */}
      <div className="space-y-3 text-center text-sm">
        <p className="text-gray-600">
          <Link href="/sign-in" className="text-[#FF6B6B] hover:underline font-medium">
            Sign in with password
          </Link>
        </p>
        <p className="text-gray-600">
          Don&apos;t have an account?{' '}
          <Link href="/sign-up" className="text-[#FF6B6B] hover:underline font-medium">
            Sign up
          </Link>
        </p>
      </div>
    </div>
  )
}
]]></code-example>
      </file>
    </section>

    <section title="5. Magic Link Request Page">
      <file path="apps/web/src/app/(auth)/magic-link/page.tsx">
        <action>Create page for magic link request</action>
        <code-example language="typescript"><![CDATA[
import { MagicLinkForm } from '@/components/auth/magic-link-form'

export const metadata = {
  title: 'Sign in with Magic Link | HYVVE',
  description: 'Sign in to your HYVVE account with a magic link',
}

export default function MagicLinkPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12">
      <div className="w-full max-w-md">
        <div className="bg-white shadow-lg rounded-lg px-8 py-10">
          <MagicLinkForm />
        </div>
      </div>
    </div>
  )
}
]]></code-example>
      </file>
    </section>

    <section title="6. Magic Link Verification Page">
      <file path="apps/web/src/app/(auth)/magic-link/verify/page.tsx">
        <action>Create page that auto-verifies magic link token</action>
        <code-example language="typescript"><![CDATA[
'use client'

import { useEffect, useState, Suspense } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Loader2, AlertCircle, CheckCircle2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import Link from 'next/link'

function VerifyContent() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const [status, setStatus] = useState<'verifying' | 'success' | 'error'>('verifying')
  const [errorMessage, setErrorMessage] = useState('')

  useEffect(() => {
    const verifyToken = async () => {
      const token = searchParams.get('token')

      if (!token) {
        setStatus('error')
        setErrorMessage('No verification token provided')
        return
      }

      try {
        // Call the verification endpoint
        // better-auth handles this automatically via GET /api/auth/magic-link/verify
        const response = await fetch(
          `/api/auth/magic-link/verify?token=${encodeURIComponent(token)}`,
          {
            method: 'GET',
            credentials: 'include',
          }
        )

        if (response.ok) {
          setStatus('success')
          // Redirect to dashboard after 2 seconds
          setTimeout(() => {
            router.push('/dashboard')
          }, 2000)
        } else {
          const data = await response.json()
          setStatus('error')

          // Parse error message
          const errorMsg = data.error?.message?.toLowerCase() || ''
          if (errorMsg.includes('expired')) {
            setErrorMessage('This magic link has expired. Please request a new one.')
          } else if (errorMsg.includes('invalid') || errorMsg.includes('not found')) {
            setErrorMessage('This magic link is invalid or has already been used.')
          } else {
            setErrorMessage('Unable to verify magic link. Please try again.')
          }
        }
      } catch (err) {
        console.error('Verification error:', err)
        setStatus('error')
        setErrorMessage('Network error. Please check your connection and try again.')
      }
    }

    verifyToken()
  }, [searchParams, router])

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12">
      <div className="w-full max-w-md">
        <div className="bg-white shadow-lg rounded-lg px-8 py-10">
          <div className="space-y-6">
            {status === 'verifying' && (
              <div className="text-center space-y-4">
                <div className="mx-auto w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center">
                  <Loader2 className="w-6 h-6 text-blue-600 animate-spin" />
                </div>
                <h1 className="text-2xl font-bold text-gray-900">
                  Verifying your magic link...
                </h1>
                <p className="text-gray-600">
                  Please wait while we sign you in
                </p>
              </div>
            )}

            {status === 'success' && (
              <div className="text-center space-y-4">
                <div className="mx-auto w-12 h-12 bg-green-50 rounded-full flex items-center justify-center">
                  <CheckCircle2 className="w-6 h-6 text-green-600" />
                </div>
                <h1 className="text-2xl font-bold text-gray-900">
                  Successfully signed in!
                </h1>
                <p className="text-gray-600">
                  Redirecting you to your dashboard...
                </p>
              </div>
            )}

            {status === 'error' && (
              <div className="space-y-4">
                <div className="text-center">
                  <div className="mx-auto w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mb-4">
                    <AlertCircle className="w-6 h-6 text-red-600" />
                  </div>
                  <h1 className="text-2xl font-bold text-gray-900 mb-2">
                    Verification Failed
                  </h1>
                </div>

                <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-sm text-red-600 text-center">
                    {errorMessage}
                  </p>
                </div>

                <div className="space-y-3">
                  <Button
                    asChild
                    className="w-full bg-[#FF6B6B] hover:bg-[#FF6B6B]/90"
                  >
                    <Link href="/magic-link">Request New Magic Link</Link>
                  </Button>
                  <Button
                    asChild
                    variant="outline"
                    className="w-full"
                  >
                    <Link href="/sign-in">Sign In with Password</Link>
                  </Button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}

export default function MagicLinkVerifyPage() {
  return (
    <Suspense fallback={
      <div className="flex min-h-screen items-center justify-center bg-gray-50">
        <Loader2 className="w-8 h-8 animate-spin text-gray-400" />
      </div>
    }>
      <VerifyContent />
    </Suspense>
  )
}
]]></code-example>
      </file>
    </section>

    <section title="7. Add Magic Link Option to Sign-In Page">
      <file path="apps/web/src/components/auth/sign-in-form.tsx">
        <action>Add magic link navigation link after sign-up link</action>
        <code-example language="typescript"><![CDATA[
// Add after the sign-up link (around line 427-432)

{/* Sign-Up Link */}
<p className="text-center text-sm text-gray-600">
  Don&apos;t have an account?{' '}
  <Link href="/sign-up" className="text-[#FF6B6B] hover:underline font-medium">
    Sign up
  </Link>
</p>

{/* NEW: Magic Link Option */}
<p className="text-center text-sm text-gray-600">
  Prefer passwordless sign-in?{' '}
  <Link href="/magic-link" className="text-[#FF6B6B] hover:underline font-medium">
    Email me a login link
  </Link>
</p>
]]></code-example>
      </file>
    </section>
  </implementation-guide>

  <technical-details>
    <section title="better-auth Magic Link Plugin">
      <detail>
        <name>Plugin Configuration</name>
        <description>
          The magicLink plugin is configured on the server with:
          - sendMagicLink: Callback function to send email
          - expiresIn: Token expiry in seconds (900 = 15 minutes)
          - disableSignUp: false (allow new user registration)
        </description>
      </detail>

      <detail>
        <name>API Endpoints</name>
        <description>
          better-auth automatically provides:
          - POST /api/auth/sign-in/magic-link - Request magic link
          - GET /api/auth/magic-link/verify?token=TOKEN - Verify token
        </description>
      </detail>

      <detail>
        <name>Token Security</name>
        <description>
          - Tokens are cryptographically secure random strings
          - Stored in database (better-auth handles this)
          - Single-use: invalidated after verification
          - Time-limited: 15-minute expiry
        </description>
      </detail>

      <detail>
        <name>Client Plugin</name>
        <description>
          The magicLinkClient plugin adds:
          - authClient.signIn.magicLink() method
          - Type-safe API calls
          - Automatic error handling
        </description>
      </detail>
    </section>

    <section title="Email Integration">
      <detail>
        <name>Resend Service</name>
        <description>
          Uses existing Resend integration from apps/web/src/lib/email.ts
          - From: "HYVVE &lt;onboarding@hyvve.app&gt;"
          - Reply-To: "support@hyvve.app"
          - HTML template with branded button
          - Fallback to console logging in dev mode
        </description>
      </detail>

      <detail>
        <name>Email Template</name>
        <description>
          HTML email with:
          - Clear call-to-action button
          - Plain text link fallback
          - 15-minute expiry notice
          - Security disclaimer
          - HYVVE branding (FF6B6B red)
        </description>
      </detail>
    </section>

    <section title="User Flow">
      <detail>
        <name>Request Flow</name>
        <steps>
          1. User visits /magic-link
          2. Enters email address
          3. Submits form
          4. Client calls authClient.signIn.magicLink()
          5. Server generates token and sends email
          6. User sees success message
        </steps>
      </detail>

      <detail>
        <name>Verification Flow</name>
        <steps>
          1. User clicks link in email
          2. Browser opens /magic-link/verify?token=TOKEN
          3. Page auto-calls /api/auth/magic-link/verify
          4. Server validates token
          5. Server creates session and sets cookie
          6. Client redirects to /dashboard
        </steps>
      </detail>

      <detail>
        <name>Error Handling</name>
        <scenarios>
          - Expired token: Show "request new link" message
          - Invalid token: Show "invalid or already used" message
          - Network error: Show "check connection" message
          - Rate limiting: Show "too many requests" message
        </scenarios>
      </detail>
    </section>

    <section title="Database Schema">
      <detail>
        <name>Token Storage</name>
        <description>
          better-auth handles token storage automatically using the existing
          Prisma adapter. No schema changes required - the plugin uses
          better-auth's internal token management.
        </description>
      </detail>
    </section>
  </technical-details>

  <testing-checklist>
    <test-case id="1" type="manual">
      <description>Magic link request sends email</description>
      <steps>
        1. Navigate to /magic-link
        2. Enter valid email address
        3. Click "Send Magic Link"
        4. Check email inbox (or console in dev mode)
        5. Verify email received with correct link
      </steps>
      <expected>Email sent with magic link that expires in 15 minutes</expected>
    </test-case>

    <test-case id="2" type="manual">
      <description>Valid magic link signs in user</description>
      <steps>
        1. Request magic link
        2. Click link in email within 15 minutes
        3. Verify redirect to /magic-link/verify
        4. Wait for automatic verification
      </steps>
      <expected>User signed in and redirected to /dashboard with active session</expected>
    </test-case>

    <test-case id="3" type="manual">
      <description>Expired link shows appropriate error</description>
      <steps>
        1. Request magic link
        2. Wait more than 15 minutes
        3. Click link in email
      </steps>
      <expected>Error message: "This magic link has expired. Please request a new one."</expected>
    </test-case>

    <test-case id="4" type="manual">
      <description>Used link shows appropriate error</description>
      <steps>
        1. Request magic link
        2. Click link and sign in successfully
        3. Try clicking the same link again
      </steps>
      <expected>Error message: "This magic link is invalid or has already been used."</expected>
    </test-case>

    <test-case id="5" type="manual">
      <description>Works for new users (auto sign-up)</description>
      <steps>
        1. Use email address that doesn't exist in system
        2. Request magic link
        3. Click link in email
      </steps>
      <expected>New user account created and signed in automatically</expected>
    </test-case>

    <test-case id="6" type="manual">
      <description>Works for existing users</description>
      <steps>
        1. Use email address of existing user
        2. Request magic link
        3. Click link in email
      </steps>
      <expected>Existing user signed in (no duplicate account created)</expected>
    </test-case>

    <test-case id="7" type="manual">
      <description>Email has correct branding and formatting</description>
      <steps>
        1. Request magic link
        2. Open email in email client
        3. Verify button, text, and branding
      </steps>
      <expected>
        - HYVVE branding with FF6B6B color
        - "Sign In to HYVVE" button
        - Plain text link fallback
        - 15-minute expiry notice
        - Security disclaimer
      </expected>
    </test-case>

    <test-case id="8" type="manual">
      <description>Rate limiting prevents abuse</description>
      <steps>
        1. Request magic link multiple times rapidly
        2. Check for rate limit error
      </steps>
      <expected>Error message after too many requests</expected>
    </test-case>

    <test-case id="9" type="manual">
      <description>Link from sign-in page works</description>
      <steps>
        1. Navigate to /sign-in
        2. Click "Email me a login link"
        3. Verify redirect to /magic-link
      </steps>
      <expected>User taken to magic link request page</expected>
    </test-case>

    <test-case id="10" type="e2e">
      <description>Complete magic link flow E2E test</description>
      <code-example language="typescript"><![CDATA[
// apps/web/tests/e2e/magic-link.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Magic Link Authentication', () => {
  test('complete magic link flow', async ({ page }) => {
    // Go to magic link page
    await page.goto('/magic-link')
    await expect(page.locator('h1')).toContainText('Sign in with Magic Link')

    // Enter email
    await page.fill('input[type="email"]', 'test@example.com')
    await page.click('button:has-text("Send Magic Link")')

    // Should show success message
    await expect(page.locator('text=Check your email')).toBeVisible()
    await expect(page.locator('text=test@example.com')).toBeVisible()

    // In real test, would:
    // 1. Check email service mock for sent email
    // 2. Extract token from email
    // 3. Navigate to /magic-link/verify?token=TOKEN
    // 4. Verify redirect to /dashboard
  })

  test('expired magic link shows error', async ({ page }) => {
    // Navigate with expired token
    await page.goto('/magic-link/verify?token=EXPIRED_TOKEN')

    // Should show error
    await expect(page.locator('h1')).toContainText('Verification Failed')
    await expect(page.locator('text=expired')).toBeVisible()

    // Should have option to request new link
    await expect(page.locator('a:has-text("Request New Magic Link")')).toBeVisible()
  })

  test('invalid magic link shows error', async ({ page }) => {
    // Navigate with invalid token
    await page.goto('/magic-link/verify?token=INVALID_TOKEN')

    // Should show error
    await expect(page.locator('text=invalid')).toBeVisible()
  })

  test('navigation from sign-in page', async ({ page }) => {
    // Go to sign-in page
    await page.goto('/sign-in')

    // Click magic link option
    await page.click('a:has-text("Email me a login link")')

    // Should navigate to magic link page
    await expect(page.url()).toContain('/magic-link')
    await expect(page.locator('h1')).toContainText('Sign in with Magic Link')
  })
})
]]></code-example>
    </test-case>
  </testing-checklist>

  <security-considerations>
    <consideration>
      <title>Token Security</title>
      <description>
        better-auth generates cryptographically secure random tokens using
        crypto.randomBytes(). Tokens are long and unpredictable.
      </description>
    </consideration>

    <consideration>
      <title>Token Expiration</title>
      <description>
        Tokens expire after 15 minutes to limit attack window. Expired tokens
        are rejected by the verification endpoint.
      </description>
    </consideration>

    <consideration>
      <title>Single-Use Tokens</title>
      <description>
        Tokens are invalidated immediately after use. Attempting to use the
        same token twice will fail.
      </description>
    </consideration>

    <consideration>
      <title>Rate Limiting</title>
      <description>
        Implement rate limiting on magic link requests (3 requests per hour
        per email recommended) to prevent abuse and email bombing.
      </description>
    </consideration>

    <consideration>
      <title>CSRF Protection</title>
      <description>
        better-auth includes CSRF protection. Verification requests must
        include valid CSRF tokens.
      </description>
    </consideration>

    <consideration>
      <title>Email Verification</title>
      <description>
        Magic links inherently verify email ownership. User clicking the link
        proves they control the email address.
      </description>
    </consideration>

    <consideration>
      <title>HTTPS Required</title>
      <description>
        Magic links must be sent over HTTPS in production to prevent
        man-in-the-middle attacks.
      </description>
    </consideration>
  </security-considerations>

  <environment-variables>
    <variable>
      <name>BETTER_AUTH_SECRET</name>
      <description>Secret key for better-auth (already configured)</description>
      <required>true</required>
    </variable>
    <variable>
      <name>BETTER_AUTH_URL</name>
      <description>Base URL for better-auth (already configured)</description>
      <required>true</required>
    </variable>
    <variable>
      <name>RESEND_API_KEY</name>
      <description>Resend API key for sending emails (already configured)</description>
      <required>true</required>
    </variable>
    <variable>
      <name>NEXT_PUBLIC_URL</name>
      <description>Public base URL for the application (already configured)</description>
      <required>true</required>
    </variable>
  </environment-variables>

  <dependencies>
    <dependency>
      <name>better-auth</name>
      <status>installed</status>
      <version>Already in use</version>
      <notes>magicLink plugin is part of better-auth/plugins</notes>
    </dependency>
    <dependency>
      <name>resend</name>
      <status>installed</status>
      <version>Already in use</version>
      <notes>Already configured for email sending</notes>
    </dependency>
  </dependencies>

  <related-documentation>
    <document>
      <title>Tech Spec - Epic 09</title>
      <path>docs/sprint-artifacts/tech-spec-epic-09.md</path>
      <section>ADR-009-01: Use better-auth Plugins for 2FA and Magic Links</section>
    </document>
    <document>
      <title>Epic 09 - UI &amp; Authentication Enhancements</title>
      <path>docs/epics/EPIC-09-ui-auth-enhancements.md</path>
      <section>Story 09.6</section>
    </document>
    <document>
      <title>PRD - Authentication Section</title>
      <path>docs/prd.md</path>
      <section>Future Enhancements - Magic Link Authentication</section>
    </document>
    <document>
      <title>Architecture - ADR-005</title>
      <path>docs/architecture.md</path>
      <section>ADR-005: better-auth for Authentication</section>
    </document>
    <document>
      <title>better-auth Magic Link Plugin Documentation</title>
      <path>https://www.better-auth.com/docs/plugins/magic-link</path>
      <section>Official documentation</section>
    </document>
  </related-documentation>

  <implementation-notes>
    <note priority="high">
      better-auth magicLink plugin handles all token generation, storage,
      and verification automatically. We only need to provide the email
      sending function.
    </note>
    <note priority="high">
      The verification page must handle the query parameter and call the
      better-auth verification endpoint. The plugin provides the API endpoint.
    </note>
    <note priority="medium">
      Magic links work for both sign-in and sign-up. If disableSignUp is false
      (default), new users are automatically registered.
    </note>
    <note priority="medium">
      Email template should match HYVVE branding (FF6B6B red) and include
      clear security messaging about expiry and ignoring unsolicited emails.
    </note>
    <note priority="low">
      Consider adding analytics tracking for magic link usage to measure
      adoption vs traditional password sign-in.
    </note>
    <note priority="low">
      Future enhancement: Add magic link option directly on sign-in form
      as a tab or toggle instead of separate page.
    </note>
  </implementation-notes>

  <definition-of-done>
    <item>‚úì better-auth magicLink plugin configured in apps/web/src/lib/auth.ts</item>
    <item>‚úì magicLinkClient plugin added to apps/web/src/lib/auth-client.ts</item>
    <item>‚úì sendMagicLinkEmail function implemented in apps/web/src/lib/email.ts</item>
    <item>‚úì MagicLinkForm component created in apps/web/src/components/auth/magic-link-form.tsx</item>
    <item>‚úì Magic link request page created at apps/web/src/app/(auth)/magic-link/page.tsx</item>
    <item>‚úì Magic link verification page created at apps/web/src/app/(auth)/magic-link/verify/page.tsx</item>
    <item>‚úì Link added to sign-in page for "Email me a login link"</item>
    <item>‚úì Email template formatted with HYVVE branding and security notices</item>
    <item>‚úì All manual test cases pass</item>
    <item>‚úì E2E tests written and passing</item>
    <item>‚úì Error states handled gracefully (expired, invalid, network errors)</item>
    <item>‚úì Dev mode console logging works for testing without Resend API key</item>
    <item>‚úì TypeScript compilation successful with no errors</item>
    <item>‚úì ESLint passes with no warnings</item>
    <item>‚úì Code follows existing patterns in apps/web/src/components/auth/</item>
  </definition-of-done>
</story-context>
