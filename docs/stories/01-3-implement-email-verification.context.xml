<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>01-3</story-id>
    <title>Implement Email Verification</title>
    <epic>EPIC-01 - Authentication System</epic>
    <priority>P0</priority>
    <points>2</points>
    <status>ready-for-dev</status>
    <generated-date>2025-12-02</generated-date>
    <generated-by>BMM story-context workflow</generated-by>
  </metadata>

  <story-summary>
    <user-story>
      As a new user, I want to verify my email address so that I can activate my account
    </user-story>
    <description>
      Implement complete email verification flow including secure token generation/validation,
      verification page UI with multiple states (pending, success, error), resend functionality
      with rate limiting, and integration with better-auth email verification plugin.
    </description>
    <business-value>
      Email verification ensures users have valid email addresses, reduces spam accounts,
      and enables secure password recovery. This is a critical security foundation for the platform.
    </business-value>
  </story-summary>

  <acceptance-criteria>
    <criterion id="AC-1" priority="must">
      <description>Generate secure verification token (24hr expiry)</description>
      <test-approach>Verify token format is base64url, 32 bytes, and expires in 24 hours</test-approach>
    </criterion>
    <criterion id="AC-2" priority="must">
      <description>Send verification email via Resend</description>
      <test-approach>Verify email sent with correct verification link and token</test-approach>
    </criterion>
    <criterion id="AC-3" priority="must">
      <description>Create verification page at /verify-email</description>
      <test-approach>Navigate to /verify-email?token=xxx and verify page loads</test-approach>
    </criterion>
    <criterion id="AC-4" priority="must">
      <description>Update user emailVerified on success</description>
      <test-approach>After verification, check database for emailVerified=true</test-approach>
    </criterion>
    <criterion id="AC-5" priority="must">
      <description>Handle expired/invalid tokens gracefully</description>
      <test-approach>Test with expired and invalid tokens, verify error messages</test-approach>
    </criterion>
    <criterion id="AC-6" priority="must">
      <description>Allow resend of verification email (rate limited)</description>
      <test-approach>Test resend functionality and verify 3/hour rate limit enforced</test-approach>
    </criterion>
    <criterion id="AC-7" priority="must">
      <description>Display verification pending state with email address</description>
      <test-approach>Verify pending UI shows user's email and resend option</test-approach>
    </criterion>
    <criterion id="AC-8" priority="must">
      <description>Show success message after successful verification</description>
      <test-approach>Verify success UI with auto-redirect countdown</test-approach>
    </criterion>
    <criterion id="AC-9" priority="must">
      <description>Show error message for expired/invalid tokens</description>
      <test-approach>Verify error UI with resend option</test-approach>
    </criterion>
    <criterion id="AC-10" priority="must">
      <description>Provide "Open Gmail" and "Open Outlook" quick links</description>
      <test-approach>Verify buttons exist and open correct email client URLs</test-approach>
    </criterion>
  </acceptance-criteria>

  <technical-context>
    <architecture>
      <component name="better-auth Email Verification">
        <description>
          better-auth provides built-in email verification through the emailAndPassword plugin.
          Token generation, storage, and validation are handled automatically.
        </description>
        <location>apps/web/src/lib/auth.ts</location>
        <current-config>
          <![CDATA[
emailAndPassword: {
  enabled: true,
  requireEmailVerification: false, // Currently disabled for testing
  sendVerificationEmail: async ({ user, token }) => {
    await sendVerificationEmail(user.email, token, user.name)
  }
}
          ]]>
        </current-config>
        <notes>
          - Token generation/storage is automatic via better-auth
          - We need to implement the verification page UI
          - Resend endpoint is custom (not provided by better-auth)
        </notes>
      </component>

      <component name="Email Service">
        <description>
          Resend integration for transactional emails with console fallback for local dev.
        </description>
        <location>apps/web/src/lib/email.ts</location>
        <current-implementation>
          <![CDATA[
export async function sendVerificationEmail(
  to: string,
  token: string,
  userName?: string
): Promise<void> {
  const verificationUrl = `${baseUrl}/verify-email?token=${token}`
  // Console logging for local dev if RESEND_API_KEY === 'test'
  // Otherwise sends via Resend API
}
          ]]>
        </current-implementation>
        <notes>
          - Already implemented in Story 01.2
          - Supports React Email templates
          - Graceful error handling (doesn't throw)
        </notes>
      </component>

      <component name="Verification Page">
        <description>
          New page at /verify-email that handles token verification and displays appropriate states.
        </description>
        <location>apps/web/src/app/(auth)/verify-email/page.tsx (to be created)</location>
        <requirements>
          - Extract token from query params
          - Auto-verify on page load if token present
          - Display pending/success/error states
          - Auto-redirect after successful verification
          - Provide resend functionality
        </requirements>
      </component>

      <component name="Resend Verification Endpoint">
        <description>
          Custom API endpoint for resending verification emails with rate limiting.
        </description>
        <location>apps/web/src/app/api/auth/resend-verification/route.ts (to be created)</location>
        <requirements>
          - Rate limit: 3 attempts per hour per email
          - Don't reveal if email exists (security)
          - Generate new token via better-auth
          - Return retryAfter if rate limited
        </requirements>
      </component>
    </architecture>

    <data-models>
      <model name="User">
        <description>User account with email verification status</description>
        <schema>
          <![CDATA[
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false) @map("email_verified")
  name          String?
  passwordHash  String?   @map("password_hash")
  // ... other fields
}
          ]]>
        </schema>
        <operations>
          <operation name="Update emailVerified">
            <code>
              <![CDATA[
await prisma.user.update({
  where: { id: userId },
  data: { emailVerified: true }
});
              ]]>
            </code>
          </operation>
        </operations>
      </model>

      <model name="VerificationToken">
        <description>Secure tokens for email verification (24hr expiry)</description>
        <schema>
          <![CDATA[
model VerificationToken {
  id         String   @id @default(uuid())
  identifier String   // User email
  token      String   @unique
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([identifier, token])
}
          ]]>
        </schema>
        <notes>
          - Managed automatically by better-auth
          - Token deleted after successful verification
          - Expiry enforced on validation
        </notes>
      </model>
    </data-models>

    <apis>
      <endpoint method="POST" path="/api/auth/verify-email">
        <description>Verify email address using token (provided by better-auth)</description>
        <request>
          <![CDATA[
{
  "token": "string" // base64url encoded token
}
          ]]>
        </request>
        <response-success>
          <![CDATA[
{
  "success": true,
  "message": "Email verified successfully",
  "user": {
    "id": "string",
    "email": "string",
    "emailVerified": true
  }
}
          ]]>
        </response-success>
        <response-error>
          <![CDATA[
{
  "success": false,
  "error": "INVALID_TOKEN" | "EXPIRED_TOKEN" | "USER_NOT_FOUND",
  "message": "Error description"
}
          ]]>
        </response-error>
        <notes>
          - This endpoint is automatically provided by better-auth
          - We may need to wrap it for custom UI responses
        </notes>
      </endpoint>

      <endpoint method="POST" path="/api/auth/resend-verification">
        <description>Resend verification email (custom endpoint)</description>
        <request>
          <![CDATA[
{
  "email": "string"
}
          ]]>
        </request>
        <response-success>
          <![CDATA[
{
  "success": true,
  "message": "Verification email sent",
  "expiresIn": 86400 // seconds
}
          ]]>
        </response-success>
        <response-rate-limited>
          <![CDATA[
{
  "success": false,
  "error": "RATE_LIMITED",
  "retryAfter": 3600 // seconds
}
          ]]>
        </response-rate-limited>
        <implementation-notes>
          - Rate limit: 3 attempts/hour per email
          - Don't reveal user existence (always return success for non-existent emails)
          - Use Redis or in-memory store for rate limiting
        </implementation-notes>
      </endpoint>
    </apis>

    <security>
      <requirement id="SEC-1">
        <description>Token Security</description>
        <details>
          - Cryptographically secure random generation (crypto.randomBytes)
          - One-time use only (deleted after verification)
          - 24-hour expiry enforced
          - base64url encoding for URL safety
        </details>
      </requirement>
      <requirement id="SEC-2">
        <description>Rate Limiting</description>
        <details>
          - Resend endpoint: 3 attempts per hour per email
          - Implementation: Redis-backed or in-memory store
          - Return retryAfter timestamp in response
        </details>
      </requirement>
      <requirement id="SEC-3">
        <description>User Enumeration Prevention</description>
        <details>
          - Don't reveal if email exists in resend endpoint
          - Always return success for non-existent emails
          - Same response time for existing/non-existing emails
        </details>
      </requirement>
      <requirement id="SEC-4">
        <description>Token Validation</description>
        <details>
          - Format validation (base64url, correct length)
          - User existence check before verification
          - Expiry check before processing
          - Transaction safety (atomic operations)
        </details>
      </requirement>
    </security>
  </technical-context>

  <existing-code>
    <file path="apps/web/src/lib/auth.ts">
      <purpose>better-auth configuration with email verification</purpose>
      <relevant-sections>
        <section name="Email Verification Plugin">
          <code>
            <![CDATA[
emailAndPassword: {
  enabled: true,
  requireEmailVerification: false, // Set to false for easier testing
  sendVerificationEmail: async ({ user, token }) => {
    await sendVerificationEmail(user.email, token, user.name)
  }
}
            ]]>
          </code>
          <notes>
            - Currently disabled for testing (requireEmailVerification: false)
            - Can be enabled by changing to true
            - Token generation handled automatically
          </notes>
        </section>
      </relevant-sections>
    </file>

    <file path="apps/web/src/lib/email.ts">
      <purpose>Email service with Resend integration</purpose>
      <relevant-sections>
        <section name="sendVerificationEmail">
          <code>
            <![CDATA[
export async function sendVerificationEmail(
  to: string,
  token: string,
  userName?: string
): Promise<void> {
  const verificationUrl = `${baseUrl}/verify-email?token=${token}`

  // Console logging for local dev
  if (!process.env.RESEND_API_KEY || process.env.RESEND_API_KEY === 'test') {
    console.log(`\nðŸ“§ Verification Email (Local Dev Mode)`)
    console.log(`To: ${to}`)
    console.log(`Verification Link: ${verificationUrl}`)
    return
  }

  // Send via Resend
  await resend.emails.send({
    from: 'HYVVE <onboarding@hyvve.app>',
    to,
    subject: 'Verify your email address for HYVVE',
    react: VerificationEmail({ verificationUrl, userName })
  })
}
            ]]>
          </code>
          <notes>
            - Already implemented in Story 01.2
            - Supports console logging for local dev
            - Uses React Email template
            - Graceful error handling
          </notes>
        </section>
      </relevant-sections>
    </file>

    <file path="apps/web/src/emails/verification-email.tsx">
      <purpose>React Email template for verification emails</purpose>
      <notes>
        - Already created in Story 01.2
        - Uses HYVVE branding
        - Includes verification link button
        - Can be enhanced with expiry notice
      </notes>
    </file>

    <file path="apps/web/src/components/auth/auth-layout.tsx">
      <purpose>Shared auth page layout</purpose>
      <notes>
        - Two-column layout with branding
        - Can be reused for verification page
        - Responsive design included
      </notes>
    </file>

    <file path="apps/web/src/app/api/auth/[...all]/route.ts">
      <purpose>better-auth API route handler (catch-all)</purpose>
      <notes>
        - Handles all /api/auth/* endpoints via better-auth
        - Includes /api/auth/verify-email automatically
        - Custom resend endpoint needs separate route file
      </notes>
    </file>
  </existing-code>

  <ui-design>
    <wireframe name="AU-05 Email Verification">
      <location>docs/design/wireframes/Finished wireframes and html files/au-05_email_verification/</location>
      <assets>
        <asset type="html">code.html</asset>
        <asset type="png">screen.png</asset>
      </assets>

      <states>
        <state name="Verification Pending">
          <description>Initial state when no token in URL or awaiting email click</description>
          <elements>
            - HYVVE logo at top
            - Mail icon in circular badge (primary color background)
            - Heading: "Verify your email"
            - User email address displayed (bold)
            - Instructions: "Click the link in the email to verify your account"
            - Quick action buttons:
              * "Open Gmail" (opens https://mail.google.com)
              * "Open Outlook" (opens https://outlook.com)
            - Help section:
              * "Didn't receive the email?"
              * Check spam folder
              * Verify email address is correct
            - Resend button (with countdown timer - 45 seconds)
            - "Wrong email?" link to change email (placeholder)
          </elements>
          <design-notes>
            - Centered card layout (max-w-md)
            - Material Symbols "mail" icon
            - Primary color (#FF6B6B) for interactive elements
            - Gray background around card
          </design-notes>
        </state>

        <state name="Verification Success">
          <description>After successful token verification</description>
          <elements>
            - HYVVE logo
            - Success icon (green check in circle)
            - Heading: "Email verified!"
            - Message: "Your email has been verified successfully. Your account is now ready to use."
            - "Get Started" button (redirects to dashboard)
            - Auto-redirect countdown: "Redirecting to your dashboard in 3..."
          </elements>
          <design-notes>
            - Success green color (#10B981) for icon
            - Auto-redirect after 3 seconds
            - Manual "Get Started" button for immediate action
          </design-notes>
        </state>

        <state name="Verification Error - Expired Token">
          <description>When token is older than 24 hours</description>
          <elements>
            - HYVVE logo
            - Error icon (red error circle)
            - Heading: "Verification link expired"
            - Message: "This verification link has expired. Please request a new verification email."
            - "Resend Verification Email" button
            - Divider
            - "Need help? Contact Support" link
          </elements>
          <design-notes>
            - Error red color (#EF4444) for icon
            - Clear call-to-action to resend
            - Support link for additional help
          </design-notes>
        </state>

        <state name="Verification Error - Invalid Token">
          <description>When token is malformed or already used</description>
          <elements>
            - Similar to expired state
            - Heading: "Invalid verification link"
            - Message: "This verification link is invalid or has already been used."
            - Same resend and support options
          </elements>
        </state>

        <state name="In-App Banner (Optional)">
          <description>Top banner for unverified users navigating the app</description>
          <elements>
            - Warning icon
            - Message: "Please verify your email address to unlock all features. Check [email] for a verification link."
            - "Resend" button
            - Close button
            - Yellow/amber background (#FEF3C7)
          </elements>
          <design-notes>
            - Full-width banner at top of page
            - Can be dismissed
            - Sticky positioning
            - Optional for this story (can defer to Story 01.8)
          </design-notes>
        </state>
      </states>

      <design-system>
        <colors>
          <color name="primary">#FF6B6B</color>
          <color name="success">#10B981</color>
          <color name="error">#EF4444</color>
          <color name="warning">#F59E0B</color>
          <color name="text-secondary">#6B7280</color>
        </colors>
        <fonts>
          <font name="display">Inter</font>
        </fonts>
        <icons>
          <library>Material Symbols Outlined</library>
          <icons-used>mail, check_circle, error, warning, close</icons-used>
        </icons>
        <spacing>
          - Card max-width: max-w-md (28rem)
          - Icon badge size: w-16 h-16
          - Icon size: text-4xl
          - Padding: p-8
          - Gap between elements: gap-4 to gap-6
        </spacing>
      </design-system>
    </wireframe>
  </ui-design>

  <implementation-plan>
    <phase number="1" name="Core Token Validation">
      <tasks>
        <task id="1.1">Create verification utilities (lib/utils/email-verification.ts)</task>
        <task id="1.2">Create rate limiting helper (lib/utils/rate-limit.ts)</task>
        <task id="1.3">Test token validation logic (unit tests)</task>
      </tasks>
    </phase>

    <phase number="2" name="API Endpoints">
      <tasks>
        <task id="2.1">Create resend verification endpoint (app/api/auth/resend-verification/route.ts)</task>
        <task id="2.2">Implement rate limiting middleware</task>
        <task id="2.3">Test resend endpoint (integration tests)</task>
      </tasks>
    </phase>

    <phase number="3" name="UI Components">
      <tasks>
        <task id="3.1">Create verification-pending component</task>
        <task id="3.2">Create verification-success component</task>
        <task id="3.3">Create verification-error component</task>
        <task id="3.4">Create countdown-button component (for resend)</task>
        <task id="3.5">Optionally create verification-banner component</task>
      </tasks>
    </phase>

    <phase number="4" name="Verification Page">
      <tasks>
        <task id="4.1">Create /verify-email page</task>
        <task id="4.2">Implement token extraction from query params</task>
        <task id="4.3">Implement auto-verification on page load</task>
        <task id="4.4">Implement state management (pending/success/error)</task>
        <task id="4.5">Implement auto-redirect after success</task>
      </tasks>
    </phase>

    <phase number="5" name="Testing and Polish">
      <tasks>
        <task id="5.1">E2E test: Complete verification flow</task>
        <task id="5.2">E2E test: Expired token handling</task>
        <task id="5.3">E2E test: Resend with rate limiting</task>
        <task id="5.4">E2E test: Email client quick links</task>
        <task id="5.5">Manual testing in all states</task>
        <task id="5.6">Update auth.ts to enable requireEmailVerification (optional)</task>
      </tasks>
    </phase>
  </implementation-plan>

  <files-to-create>
    <file path="apps/web/src/app/(auth)/verify-email/page.tsx">
      <description>Verification page with token handling and state management</description>
      <dependencies>
        - components/auth/verification-pending
        - components/auth/verification-success
        - components/auth/verification-error
        - lib/auth-client (for verification API call)
      </dependencies>
    </file>

    <file path="apps/web/src/components/auth/verification-pending.tsx">
      <description>Pending state UI component</description>
      <features>
        - Display user email
        - Gmail/Outlook quick links
        - Resend button with countdown
        - Help text and instructions
      </features>
    </file>

    <file path="apps/web/src/components/auth/verification-success.tsx">
      <description>Success state UI component</description>
      <features>
        - Success icon and message
        - "Get Started" button
        - Auto-redirect countdown
      </features>
    </file>

    <file path="apps/web/src/components/auth/verification-error.tsx">
      <description>Error state UI component</description>
      <features>
        - Error icon and message
        - Different messages for expired/invalid
        - Resend button
        - Support link
      </features>
    </file>

    <file path="apps/web/src/components/ui/countdown-button.tsx">
      <description>Button with countdown timer for resend functionality</description>
      <features>
        - Countdown from 45 seconds
        - Disabled state during countdown
        - Loading state during API call
        - Re-enable after countdown
      </features>
    </file>

    <file path="apps/web/src/components/auth/verification-banner.tsx">
      <description>Optional in-app banner for unverified users</description>
      <features>
        - Warning message with user email
        - Resend button
        - Close/dismiss functionality
        - Sticky positioning
      </features>
      <notes>Optional - can be deferred to Story 01.8</notes>
    </file>

    <file path="apps/web/src/lib/utils/email-verification.ts">
      <description>Utility functions for token validation</description>
      <functions>
        - validateTokenFormat(token: string): boolean
        - isTokenExpired(expiresAt: Date): boolean
        - generateVerificationUrl(token: string): string
      </functions>
    </file>

    <file path="apps/web/src/lib/utils/rate-limit.ts">
      <description>Rate limiting helper using in-memory store</description>
      <functions>
        - isRateLimited(key: string, limit: number, windowSec: number): Promise&lt;boolean&gt;
        - getRateLimitInfo(key: string): Promise&lt;{remaining: number, resetAt: Date}&gt;
      </functions>
      <notes>
        - Use Map or LRU cache for MVP
        - Redis integration can be added later
      </notes>
    </file>

    <file path="apps/web/src/app/api/auth/resend-verification/route.ts">
      <description>Custom endpoint for resending verification emails</description>
      <implementation-notes>
        - Extract email from request body
        - Check rate limit (3/hour per email)
        - Find user in database
        - Generate new token via better-auth
        - Send email via existing email service
        - Return appropriate response
      </implementation-notes>
    </file>
  </files-to-create>

  <files-to-modify>
    <file path="apps/web/src/lib/auth.ts">
      <modification>
        <description>Optionally enable email verification requirement</description>
        <change>
          Change `requireEmailVerification: false` to `true` when ready for production
        </change>
        <notes>
          - Keep as false during development for easier testing
          - Enable before production deployment
        </notes>
      </modification>
    </file>

    <file path="apps/web/src/lib/email.ts">
      <modification>
        <description>Enhance verification email template</description>
        <change>
          - Add explicit 24-hour expiry notice
          - Add "Didn't request this?" message
          - Improve email styling/branding
        </change>
        <notes>Optional - current template is functional</notes>
      </modification>
    </file>

    <file path="apps/web/src/emails/verification-email.tsx">
      <modification>
        <description>Enhance React Email template</description>
        <change>
          - Add expiry notice (24 hours)
          - Add HYVVE branding/logo
          - Add "Didn't request this?" footer
        </change>
      </modification>
    </file>

    <file path="apps/web/src/components/auth/sign-up-form.tsx">
      <modification>
        <description>Update success message after registration</description>
        <change>
          - Clarify verification email sent
          - Add link to /verify-email page
          - Mention checking spam folder
        </change>
        <notes>Minor improvement - not critical</notes>
      </modification>
    </file>
  </files-to-modify>

  <test-files-to-create>
    <test-file path="apps/web/src/lib/utils/email-verification.test.ts">
      <description>Unit tests for token validation</description>
      <test-cases>
        - Valid token format
        - Invalid token format
        - Token expiry check (expired/not expired)
        - Token generation
      </test-cases>
    </test-file>

    <test-file path="apps/web/src/lib/utils/rate-limit.test.ts">
      <description>Unit tests for rate limiting</description>
      <test-cases>
        - Within rate limit
        - Exceeded rate limit
        - Rate limit reset after window
        - Multiple emails tracked independently
      </test-cases>
    </test-file>

    <test-file path="apps/web/src/app/api/auth/verify-email.test.ts">
      <description>Integration tests for verification endpoint</description>
      <test-cases>
        - Successful verification with valid token
        - Expired token returns error
        - Invalid token returns error
        - User emailVerified status updated
        - Token deleted after verification
        - Token reuse prevented
      </test-cases>
    </test-file>

    <test-file path="apps/web/src/app/api/auth/resend-verification.test.ts">
      <description>Integration tests for resend endpoint</description>
      <test-cases>
        - Successful resend for unverified user
        - Rate limiting enforced after 3 attempts
        - No error revealed for non-existent email
        - No resend for already verified user
        - New token replaces old token
      </test-cases>
    </test-file>

    <test-file path="apps/web/tests/e2e/email-verification.spec.ts">
      <description>End-to-end tests for complete verification flow</description>
      <scenarios>
        <scenario name="Successful Verification">
          1. Navigate to /verify-email?token={validToken}
          2. Page loads and auto-verifies
          3. Success message displayed
          4. "Get Started" button visible
          5. Auto-redirect countdown shown
          6. Redirect to dashboard after 3 seconds
        </scenario>
        <scenario name="Expired Token">
          1. Navigate with expired token
          2. Error message displayed
          3. Resend button visible
          4. Click resend
          5. Success message shown
        </scenario>
        <scenario name="Resend with Rate Limiting">
          1. Click resend 3 times rapidly
          2. Fourth attempt shows rate limit error
          3. Countdown timer displayed
          4. Button re-enabled after countdown
        </scenario>
        <scenario name="Email Client Quick Links">
          1. Navigate to verification pending page
          2. "Open Gmail" button visible
          3. "Open Outlook" button visible
          4. Buttons open correct URLs
        </scenario>
      </scenarios>
    </test-file>
  </test-files-to-create>

  <dependencies>
    <internal-dependencies>
      <dependency>
        <name>Story 01.2 - Email/Password Registration</name>
        <status>DONE</status>
        <provides>
          - Email service (sendVerificationEmail)
          - Auth configuration with email plugin
          - Verification email template
          - Token generation via better-auth
        </provides>
      </dependency>
      <dependency>
        <name>Story 01.1 - better-auth Setup</name>
        <status>DONE</status>
        <provides>
          - better-auth configuration
          - Prisma adapter integration
          - API route handlers
        </provides>
      </dependency>
    </internal-dependencies>

    <external-dependencies>
      <dependency name="better-auth">
        <version>^1.4.4</version>
        <status>installed</status>
        <used-for>Email verification plugin, token management</used-for>
      </dependency>
      <dependency name="resend">
        <version>^6.5.2</version>
        <status>installed</status>
        <used-for>Email delivery</used-for>
      </dependency>
      <dependency name="react-email">
        <version>^5.0.5</version>
        <status>installed</status>
        <used-for>Email templates</used-for>
      </dependency>
      <dependency name="@react-email/components">
        <version>^1.0.1</version>
        <status>installed</status>
        <used-for>Email component library</used-for>
      </dependency>
      <dependency name="zod">
        <version>^4.1.13</version>
        <status>installed</status>
        <used-for>Request validation</used-for>
      </dependency>
    </external-dependencies>

    <environment-variables>
      <variable name="BETTER_AUTH_SECRET">
        <description>JWT signing secret for better-auth</description>
        <status>configured</status>
      </variable>
      <variable name="BETTER_AUTH_URL">
        <description>Base URL for better-auth callbacks</description>
        <status>configured</status>
      </variable>
      <variable name="NEXT_PUBLIC_URL">
        <description>Public URL for verification links</description>
        <status>configured</status>
      </variable>
      <variable name="RESEND_API_KEY">
        <description>Resend API key for email delivery</description>
        <status>configured (using 'test' for local dev)</status>
      </variable>
    </environment-variables>
  </dependencies>

  <known-limitations>
    <limitation id="LIM-1">
      <description>Rate limiting uses in-memory store</description>
      <impact>Rate limits reset on server restart</impact>
      <mitigation>Upgrade to Redis-backed store in production</mitigation>
      <priority>low</priority>
    </limitation>

    <limitation id="LIM-2">
      <description>Email verification currently disabled by default</description>
      <impact>Users can sign in without verifying email during testing</impact>
      <mitigation>Enable requireEmailVerification: true before production</mitigation>
      <priority>high</priority>
    </limitation>

    <limitation id="LIM-3">
      <description>Email change functionality not implemented</description>
      <impact>"Wrong email?" link is placeholder</impact>
      <mitigation>Implement in future story</mitigation>
      <priority>low</priority>
    </limitation>

    <limitation id="LIM-4">
      <description>In-app banner is optional</description>
      <impact>Unverified users may not be reminded to verify</impact>
      <mitigation>Can be implemented in Story 01.8 or later</mitigation>
      <priority>low</priority>
    </limitation>
  </known-limitations>

  <out-of-scope>
    <item>Magic link authentication with 6-digit code (shown in wireframe but not in this story)</item>
    <item>Two-factor authentication (2FA) - Growth feature</item>
    <item>Email change functionality - Future story</item>
    <item>SMS verification as alternative - Not in MVP</item>
    <item>In-app verification banner - Optional, can defer to Story 01.8</item>
  </out-of-scope>

  <integration-notes>
    <integration-point name="Better-Auth Plugin">
      <description>
        The emailAndPassword plugin in better-auth handles token generation and storage automatically.
        We need to:
        1. Ensure sendVerificationEmail callback is configured (already done)
        2. Implement UI for verification page
        3. Call better-auth verification endpoint from client
      </description>
      <reference>apps/web/src/lib/auth.ts</reference>
    </integration-point>

    <integration-point name="Email Service">
      <description>
        Existing email service (sendVerificationEmail) is already configured and tested.
        For resend functionality, we can reuse this service with a new token.
      </description>
      <reference>apps/web/src/lib/email.ts</reference>
    </integration-point>

    <integration-point name="Sign-Up Flow">
      <description>
        After successful registration in Story 01.2, user receives verification email.
        Sign-up form should redirect to /verify-email page with email in query params
        or show success message with link to verification page.
      </description>
      <reference>apps/web/src/components/auth/sign-up-form.tsx</reference>
    </integration-point>

    <integration-point name="Sign-In Flow">
      <description>
        Story 01.4 (Sign-In) will need to check emailVerified status.
        If requireEmailVerification: true, unverified users should be blocked from signing in
        and redirected to /verify-email page.
      </description>
      <reference>Future Story 01.4</reference>
    </integration-point>
  </integration-notes>

  <traceability>
    <requirement-mapping>
      <mapping>
        <requirement-id>FR-1.1</requirement-id>
        <requirement-text>Email/password registration with verification</requirement-text>
        <acceptance-criteria>AC-1, AC-2, AC-3, AC-4</acceptance-criteria>
        <tech-spec-section>Email Verification Flow</tech-spec-section>
      </mapping>
      <mapping>
        <requirement-id>NFR-S1</requirement-id>
        <requirement-text>Secure password and token handling</requirement-text>
        <acceptance-criteria>AC-1, AC-5</acceptance-criteria>
        <tech-spec-section>Security - Token Generation</tech-spec-section>
      </mapping>
      <mapping>
        <requirement-id>NFR-S7</requirement-id>
        <requirement-text>Rate limiting on auth endpoints</requirement-text>
        <acceptance-criteria>AC-6</acceptance-criteria>
        <tech-spec-section>Security - Rate Limiting</tech-spec-section>
      </mapping>
    </requirement-mapping>

    <epic-mapping>
      <epic-id>EPIC-01</epic-id>
      <epic-section>Authentication System - Email Verification</epic-section>
      <story-contribution>
        Implements complete email verification flow as part of registration process.
        Enables secure account activation and validates user email addresses.
      </story-contribution>
    </epic-mapping>
  </traceability>

  <developer-notes>
    <note priority="high">
      Token validation and storage are handled automatically by better-auth.
      Focus on implementing UI states and resend functionality.
    </note>

    <note priority="high">
      For local development, verification emails are logged to console (RESEND_API_KEY='test').
      Copy the verification link from console to test the flow.
    </note>

    <note priority="medium">
      The wireframe shows a 6-digit code input option (magic link). This is OUT OF SCOPE for this story.
      Only implement token-based verification via email link.
    </note>

    <note priority="medium">
      Auto-redirect after successful verification should wait 3 seconds to allow user to see success message.
      User can also click "Get Started" button to redirect immediately.
    </note>

    <note priority="low">
      In-app verification banner is optional. Can be implemented later in Story 01.8 or as a separate task.
    </note>

    <note priority="low">
      "Wrong email?" link is a placeholder. Email change functionality is out of scope for MVP.
    </note>

    <note priority="low">
      Rate limiting uses in-memory store for MVP. Consider Redis-backed implementation for production.
    </note>
  </developer-notes>

  <success-criteria>
    <criterion>All acceptance criteria are met and tested</criterion>
    <criterion>Verification page created and accessible at /verify-email</criterion>
    <criterion>All three states (pending, success, error) render correctly</criterion>
    <criterion>Token validation works with expired/invalid tokens</criterion>
    <criterion>User emailVerified field is updated on successful verification</criterion>
    <criterion>Resend functionality works with rate limiting enforced</criterion>
    <criterion>Email client quick links (Gmail, Outlook) work correctly</criterion>
    <criterion>Auto-redirect after success works (3 second countdown)</criterion>
    <criterion>Build passes with no TypeScript errors</criterion>
    <criterion>Code follows existing patterns from Story 01.2</criterion>
    <criterion>UI matches AU-05 wireframe design</criterion>
  </success-criteria>

  <reference-documentation>
    <document>
      <title>Story 01-3: Implement Email Verification</title>
      <path>docs/stories/01-3-implement-email-verification.md</path>
      <type>story-definition</type>
    </document>
    <document>
      <title>Epic 01: Authentication System</title>
      <path>docs/epics/EPIC-01-authentication.md</path>
      <type>epic-definition</type>
    </document>
    <document>
      <title>Epic Technical Specification: Authentication System</title>
      <path>docs/sprint-artifacts/tech-spec-epic-01.md</path>
      <type>technical-specification</type>
    </document>
    <document>
      <title>Story 01-2: Email/Password Registration (Previous Story)</title>
      <path>docs/stories/01-2-implement-email-password-registration.md</path>
      <type>story-definition</type>
    </document>
    <document>
      <title>AU-05 Email Verification Wireframe</title>
      <path>docs/design/wireframes/Finished wireframes and html files/au-05_email_verification/</path>
      <type>wireframe</type>
    </document>
  </reference-documentation>
</story-context>
