<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>01-5</story-id>
    <epic-id>EPIC-01</epic-id>
    <title>Implement Google OAuth</title>
    <generated-date>2025-12-02</generated-date>
    <status>ready-for-dev</status>
  </metadata>

  <!-- =================================================================== -->
  <!-- STORY OVERVIEW -->
  <!-- =================================================================== -->
  <story-overview>
    <description>
      Implement Google OAuth as a social sign-in provider using better-auth's built-in social
      authentication support. Users can sign in with their Google account, which creates a new
      user account or links to an existing account if the email matches.
    </description>

    <business-value>
      Provides frictionless onboarding experience aligned with the "90/5 Promise" of minimal
      user involvement. Google OAuth eliminates password creation friction and reduces time
      to first workspace creation.
    </business-value>

    <scope>
      <in-scope>
        - Google OAuth provider configuration in better-auth
        - "Sign in with Google" button UI on sign-in and sign-up pages
        - OAuth callback handling at /api/auth/callback/google
        - User account creation from Google profile (email, name, image)
        - Account linking for existing email/password users
        - Secure OAuth token storage in accounts table
        - Error handling for OAuth failures and cancellations
      </in-scope>

      <out-of-scope>
        - GitHub, Microsoft OAuth providers (Growth features)
        - Account unlinking functionality (Settings feature)
        - Google Calendar/Drive API integration (requires additional scopes)
        - SAML/SSO for enterprise (Enterprise tier)
      </out-of-scope>
    </scope>

    <dependencies>
      <dependency status="done">Story 01.1 - Install and Configure better-auth</dependency>
      <dependency status="external">Google Cloud Console OAuth 2.0 setup</dependency>
      <dependency status="required">Environment variables: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET</dependency>
    </dependencies>
  </story-overview>

  <!-- =================================================================== -->
  <!-- ACCEPTANCE CRITERIA -->
  <!-- =================================================================== -->
  <acceptance-criteria>
    <criterion id="AC-1">
      <title>Configure Google OAuth Provider</title>
      <given>better-auth is installed and configured</given>
      <when>adding Google OAuth provider configuration</when>
      <then>
        - Google OAuth provider added to better-auth config in lib/auth.ts
        - Provider configuration includes clientId, clientSecret, and callback URL
        - Scopes include openid, email, profile
        - Environment variables GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET used
      </then>
      <implementation-notes>
        Add socialProviders.google configuration to existing better-auth setup.
        Use better-auth's built-in google provider from 'better-auth/providers'.
        Callback URL format: {BETTER_AUTH_URL}/api/auth/callback/google
      </implementation-notes>
    </criterion>

    <criterion id="AC-2">
      <title>Add "Sign in with Google" Button</title>
      <given>user is on the sign-in or registration page</given>
      <when>viewing authentication options</when>
      <then>
        - "Sign in with Google" button with Google logo/icon displayed
        - Button styled per HYVVE design system (reference wireframes AU-01, AU-02)
        - Button positioned below email/password form with "OR" divider
        - Button has hover and loading states
        - Clicking button initiates OAuth flow
      </then>
      <implementation-notes>
        Enable the existing disabled Google button in sign-in-form.tsx and sign-up-form.tsx.
        Update button to call authClient.signIn.social({ provider: 'google' }) from better-auth/react.
        Consider using mcp__magic__logo_search for Google icon SVG.
      </implementation-notes>
    </criterion>

    <criterion id="AC-3">
      <title>Handle OAuth Callback</title>
      <given>user authorizes the app on Google</given>
      <when>Google redirects back to callback URL</when>
      <then>
        - Callback handled at /api/auth/callback/google
        - Authorization code exchanged for access + refresh tokens
        - Google user profile fetched (email, name, picture)
        - Tokens stored in accounts table
        - User redirected to dashboard or onboarding
      </then>
      <implementation-notes>
        better-auth handles OAuth callback automatically via API route.
        OAuth flow: button click → Google consent → callback with code → exchange tokens →
        fetch profile → create/link account → create session → redirect.
      </implementation-notes>
    </criterion>

    <criterion id="AC-4">
      <title>Create or Link User Account</title>
      <given>OAuth callback succeeds and user profile is retrieved</given>
      <when>determining account creation/linking</when>
      <then>
        Case 1: New User (email not in database)
        - Create new User record with email from Google
        - Set emailVerified = true (Google verified)
        - Set name from Google profile
        - Set image from Google profile picture
        - Set passwordHash = null (OAuth-only account)
        - Create Account record linking to Google

        Case 2: Existing User with Same Email
        - Find existing User by email
        - Create Account record linking user to Google provider
        - Show message: "Google account linked to existing account"

        Case 3: Existing User Already Linked to Google
        - Find existing Account by provider + providerAccountId
        - Update access/refresh tokens if changed
        - Proceed to session creation
      </then>
      <implementation-notes>
        better-auth handles account linking automatically via Prisma adapter.
        Ensure User.emailVerified is set to true for OAuth users.
      </implementation-notes>
    </criterion>

    <criterion id="AC-5">
      <title>Store OAuth Tokens Securely</title>
      <given>OAuth callback provides access and refresh tokens</given>
      <when>storing tokens</when>
      <then>
        - Access token stored in accounts.accessToken
        - Refresh token stored in accounts.refreshToken (if provided)
        - Token expiration stored in accounts.expiresAt
        - Tokens stored as TEXT type (long strings)
        - better-auth handles token refresh automatically
      </then>
      <implementation-notes>
        Tokens stored via Prisma Account model (already defined in schema).
        Database-level encryption for tokens at rest.
        Never expose tokens to client-side JavaScript.
      </implementation-notes>
    </criterion>

    <criterion id="AC-6">
      <title>Support Account Linking for Existing Email Users</title>
      <given>user has existing email/password account</given>
      <when>signing in with Google using same email</when>
      <then>
        - Detect email match with existing user
        - Link Google account to existing user (create Account record)
        - Show success message: "Your Google account has been linked"
        - User can now sign in with either email/password or Google
        - Both methods access the same user account and workspaces
      </then>
      <implementation-notes>
        better-auth Prisma adapter handles account linking automatically.
        Edge case: User signs up with Google first, then tries password reset → allow setting password.
      </implementation-notes>
    </criterion>

    <criterion id="AC-7">
      <title>Error Handling</title>
      <given>OAuth flow encounters errors</given>
      <when>errors occur</when>
      <then>
        - User cancels on Google consent screen → redirect to sign-in with message "Sign-in cancelled"
        - Invalid OAuth state parameter → show error, prevent CSRF
        - Google API error → log error, show user-friendly message
        - Network timeout → retry once, then show error
        - Missing required scopes → show error "Email permission required"
      </then>
      <error-messages>
        - "Unable to sign in with Google. Please try again."
        - "Your Google account email is required for sign-in."
        - "Something went wrong. Please try again or use email sign-in."
      </error-messages>
    </criterion>
  </acceptance-criteria>

  <!-- =================================================================== -->
  <!-- TECHNICAL ARCHITECTURE -->
  <!-- =================================================================== -->
  <technical-architecture>
    <components>
      <component name="better-auth server config">
        <file>apps/web/src/lib/auth.ts</file>
        <responsibility>Configure Google OAuth provider with credentials and scopes</responsibility>
        <changes>
          - Import google provider from 'better-auth/providers'
          - Add socialProviders.google configuration object
          - Configure clientId, clientSecret, redirectURI
          - Set scopes: openid, email, profile
        </changes>
      </component>

      <component name="better-auth client">
        <file>apps/web/src/lib/auth-client.ts</file>
        <responsibility>Client-side OAuth initiation</responsibility>
        <changes>
          - Export signIn.social() method for OAuth flow
          - Handle redirect to Google consent screen
        </changes>
      </component>

      <component name="Sign-In Form">
        <file>apps/web/src/components/auth/sign-in-form.tsx</file>
        <responsibility>Display Google sign-in button</responsibility>
        <changes>
          - Enable currently disabled Google button (line 100-126)
          - Remove disabled prop
          - Add onClick handler to call authClient.signIn.social({ provider: 'google' })
          - Handle loading state during OAuth redirect
        </changes>
      </component>

      <component name="Sign-Up Form">
        <file>apps/web/src/components/auth/sign-up-form.tsx</file>
        <responsibility>Display Google sign-up button</responsibility>
        <changes>
          - Add Google OAuth button (similar to sign-in form)
          - Position above email/password form with OR divider
          - Call authClient.signIn.social({ provider: 'google' })
        </changes>
      </component>

      <component name="OAuth Callback Route">
        <file>apps/web/src/app/api/auth/[...all]/route.ts</file>
        <responsibility>Handle OAuth callback automatically</responsibility>
        <changes>
          - No changes needed (better-auth handles automatically)
          - Callback endpoint: /api/auth/callback/google
        </changes>
      </component>
    </components>

    <data-models>
      <model name="User">
        <location>packages/db/prisma/schema.prisma</location>
        <fields>
          <field name="id">UUID - Primary key</field>
          <field name="email">String - Unique, from Google profile</field>
          <field name="emailVerified">Boolean - Set to true for OAuth users</field>
          <field name="name">String - From Google profile displayName</field>
          <field name="image">String - Google profile picture URL</field>
          <field name="passwordHash">String nullable - Set to null for OAuth-only accounts</field>
        </fields>
        <notes>
          User created on first Google sign-in if email doesn't exist.
          If email exists, Account record links Google to existing User.
        </notes>
      </model>

      <model name="Account">
        <location>packages/db/prisma/schema.prisma</location>
        <fields>
          <field name="id">UUID - Primary key</field>
          <field name="userId">String - Foreign key to User</field>
          <field name="provider">String - Set to "google"</field>
          <field name="providerAccountId">String - Google user ID (sub claim)</field>
          <field name="accessToken">Text - OAuth access token</field>
          <field name="refreshToken">Text nullable - OAuth refresh token</field>
          <field name="expiresAt">DateTime - Token expiration</field>
        </fields>
        <notes>
          Unique constraint on [provider, providerAccountId].
          Tokens stored as TEXT to accommodate long strings.
          better-auth handles token refresh automatically.
        </notes>
      </model>

      <model name="Session">
        <location>packages/db/prisma/schema.prisma</location>
        <fields>
          <field name="id">UUID - Primary key</field>
          <field name="userId">String - Foreign key to User</field>
          <field name="token">String - Session token (JWT)</field>
          <field name="expiresAt">DateTime - Session expiration (7 days)</field>
          <field name="activeWorkspaceId">String nullable - Multi-tenant support</field>
        </fields>
        <notes>
          Created after successful OAuth flow.
          JWT includes userId, sessionId, workspaceId claims.
        </notes>
      </model>
    </data-models>

    <api-endpoints>
      <endpoint>
        <path>/api/auth/signin/google</path>
        <method>GET</method>
        <description>Initiates Google OAuth flow</description>
        <handled-by>better-auth (automatic)</handled-by>
        <flow>
          1. Generate OAuth state parameter (CSRF protection)
          2. Redirect to Google consent screen
          3. Include scopes: openid, email, profile
        </flow>
      </endpoint>

      <endpoint>
        <path>/api/auth/callback/google</path>
        <method>GET</method>
        <description>OAuth callback after user authorizes</description>
        <handled-by>better-auth (automatic)</handled-by>
        <query-params>
          <param name="code">Authorization code from Google</param>
          <param name="state">CSRF protection token</param>
        </query-params>
        <flow>
          1. Validate state parameter
          2. Exchange authorization code for tokens
          3. Fetch user profile from Google
          4. Create or link User account
          5. Create Account record
          6. Create Session
          7. Set session cookie (HTTP-only)
          8. Redirect to dashboard
        </flow>
      </endpoint>
    </api-endpoints>

    <workflows>
      <workflow name="Google OAuth Sign-In Flow">
        <step num="1">User clicks "Sign in with Google" button</step>
        <step num="2">Client calls authClient.signIn.social({ provider: 'google' })</step>
        <step num="3">Redirect to /api/auth/signin/google</step>
        <step num="4">better-auth generates OAuth state, redirects to Google</step>
        <step num="5">User sees Google consent screen (email, profile permissions)</step>
        <step num="6">User authorizes app</step>
        <step num="7">Google redirects to /api/auth/callback/google with code</step>
        <step num="8">better-auth validates state, exchanges code for tokens</step>
        <step num="9">better-auth fetches user profile from Google</step>
        <step num="10">
          Account Linking Logic:
          - If email exists: Find User, create Account linking Google
          - If email new: Create User (emailVerified=true), create Account
          - If already linked: Update tokens
        </step>
        <step num="11">Create Session with JWT token</step>
        <step num="12">Set session cookie (HTTP-only, secure)</step>
        <step num="13">Redirect to /dashboard</step>
      </workflow>

      <workflow name="Account Linking for Existing User">
        <step num="1">Existing user (email/password) clicks "Sign in with Google"</step>
        <step num="2">OAuth flow completes, Google profile email matches existing User</step>
        <step num="3">better-auth finds existing User by email</step>
        <step num="4">Create new Account record linking User.id to Google provider</step>
        <step num="5">User now has two authentication methods (email/password + Google)</step>
        <step num="6">Show success toast: "Your Google account has been linked"</step>
        <step num="7">Proceed to dashboard</step>
      </workflow>
    </workflows>
  </technical-architecture>

  <!-- =================================================================== -->
  <!-- IMPLEMENTATION GUIDANCE -->
  <!-- =================================================================== -->
  <implementation-guidance>
    <google-cloud-setup>
      <title>Google Cloud Console Configuration</title>
      <instructions>
        1. Navigate to https://console.cloud.google.com/apis/credentials
        2. Create OAuth 2.0 Client ID (Application type: Web application)
        3. Configure authorized redirect URIs:
           - Development: http://localhost:3000/api/auth/callback/google
           - Production: https://app.hyvve.ai/api/auth/callback/google
        4. Configure OAuth consent screen:
           - App name: HYVVE
           - User support email: support@hyvve.ai
           - Logo: HYVVE logo (upload)
           - Privacy policy URL: https://hyvve.ai/privacy
           - Terms of Service URL: https://hyvve.ai/terms
        5. Add test users during development (app in "Testing" status)
        6. Copy Client ID and Client Secret to .env.local
        7. Submit for verification before production launch
      </instructions>
      <scopes>
        - openid: Required for OAuth 2.0
        - email: User email address
        - profile: User name and profile picture
      </scopes>
      <testing-notes>
        While app is in "Testing" status, only added test users can authorize.
        Add developer Google accounts as test users.
      </testing-notes>
    </google-cloud-setup>

    <environment-setup>
      <title>Environment Variables</title>
      <file>.env.local</file>
      <variables>
        <variable>
          <name>GOOGLE_CLIENT_ID</name>
          <format>xxx-xxx.apps.googleusercontent.com</format>
          <source>Google Cloud Console → Credentials → OAuth 2.0 Client ID</source>
        </variable>
        <variable>
          <name>GOOGLE_CLIENT_SECRET</name>
          <format>GOCSPX-xxx</format>
          <source>Google Cloud Console → Credentials → OAuth 2.0 Client ID</source>
        </variable>
        <variable>
          <name>BETTER_AUTH_URL</name>
          <value-dev>http://localhost:3000</value-dev>
          <value-prod>https://app.hyvve.ai</value-prod>
          <notes>Base URL for OAuth callbacks</notes>
        </variable>
      </variables>
      <validation>
        Verify environment variables are loaded:
        console.log('Google OAuth configured:', !!process.env.GOOGLE_CLIENT_ID)
      </validation>
    </environment-setup>

    <code-changes>
      <change priority="1">
        <file>apps/web/src/lib/auth.ts</file>
        <description>Add Google OAuth provider configuration</description>
        <code-snippet>
// Add import at top of file
import { google } from 'better-auth/providers'

// Add to betterAuth() config (after emailAndPassword section)
socialProviders: {
  google: {
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    redirectURI: `${process.env.BETTER_AUTH_URL}/api/auth/callback/google`,
  },
}
        </code-snippet>
        <notes>
          Uncomment existing socialProviders section (lines 52-55).
          Ensure environment variables are set before starting app.
        </notes>
      </change>

      <change priority="2">
        <file>apps/web/src/components/auth/sign-in-form.tsx</file>
        <description>Enable Google sign-in button</description>
        <code-snippet>
// Replace disabled button (lines 100-126) with:
import { authClient } from '@/lib/auth-client'

const [isGoogleLoading, setIsGoogleLoading] = useState(false)

const handleGoogleSignIn = async () => {
  setIsGoogleLoading(true)
  try {
    await authClient.signIn.social({
      provider: 'google',
      callbackURL: '/dashboard',
    })
    // Redirect happens automatically
  } catch (error) {
    console.error('Google sign-in error:', error)
    setError('NETWORK_ERROR')
    setIsGoogleLoading(false)
  }
}

&lt;Button
  type="button"
  variant="outline"
  className="w-full"
  onClick={handleGoogleSignIn}
  disabled={isGoogleLoading || isSubmitting}
&gt;
  {isGoogleLoading ? (
    &lt;&gt;
      &lt;Loader2 className="w-4 h-4 mr-2 animate-spin" /&gt;
      Connecting to Google...
    &lt;/&gt;
  ) : (
    &lt;&gt;
      &lt;svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"&gt;
        {/* Google icon SVG paths */}
      &lt;/svg&gt;
      Continue with Google
    &lt;/&gt;
  )}
&lt;/Button&gt;
        </code-snippet>
        <notes>
          Remove disabled prop and title="Coming soon in Story 01.5".
          Keep existing Google icon SVG (lines 107-124).
          Add loading state to prevent double-clicks.
        </notes>
      </change>

      <change priority="3">
        <file>apps/web/src/components/auth/sign-up-form.tsx</file>
        <description>Add Google sign-up button (similar to sign-in)</description>
        <location>Before the form opening tag, after page header</location>
        <code-snippet>
// Add after line 97 (after page header div)
&lt;div className="space-y-3"&gt;
  &lt;Button
    type="button"
    variant="outline"
    className="w-full"
    onClick={handleGoogleSignUp}
    disabled={isGoogleLoading || isSubmitting}
  &gt;
    {isGoogleLoading ? (
      &lt;&gt;
        &lt;Loader2 className="w-4 h-4 mr-2 animate-spin" /&gt;
        Connecting to Google...
      &lt;/&gt;
    ) : (
      &lt;&gt;
        &lt;svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"&gt;
          {/* Google icon SVG */}
        &lt;/svg&gt;
        Continue with Google
      &lt;/&gt;
    )}
  &lt;/Button&gt;
&lt;/div&gt;

{/* Divider */}
&lt;div className="relative"&gt;
  &lt;div className="absolute inset-0 flex items-center"&gt;
    &lt;span className="w-full border-t" /&gt;
  &lt;/div&gt;
  &lt;div className="relative flex justify-center text-xs uppercase"&gt;
    &lt;span className="bg-white px-2 text-gray-500"&gt;Or sign up with email&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;
        </code-snippet>
        <notes>
          Add handleGoogleSignUp function (same as sign-in).
          OAuth flow is identical for sign-up and sign-in.
        </notes>
      </change>
    </code-changes>

    <testing-strategy>
      <unit-tests>
        <test>Validate Google provider configuration object structure</test>
        <test>Verify OAuth state parameter generation</test>
        <test>Test account linking logic for 3 cases (new, existing, already linked)</test>
      </unit-tests>

      <integration-tests>
        <test>Mock Google OAuth callback with test authorization code</test>
        <test>Verify User creation from Google profile data</test>
        <test>Test account linking for existing email/password user</test>
        <test>Verify OAuth tokens stored in accounts table</test>
        <test>Test session creation after successful OAuth</test>
      </integration-tests>

      <e2e-tests>
        <test>Sign in with Google as new user → account created, redirected to dashboard</test>
        <test>Sign in with Google with existing email → accounts linked</test>
        <test>Cancel OAuth flow on Google → redirected to sign-in with message</test>
        <test>Sign in, sign out, sign in again with Google → session management works</test>
      </e2e-tests>

      <manual-testing>
        <checklist>
          <item>Click "Sign in with Google" redirects to Google consent screen</item>
          <item>Authorize app on Google redirects back and signs in</item>
          <item>User profile (name, email, image) populated correctly</item>
          <item>Can sign out and sign in again with Google</item>
          <item>Can link Google account to existing email/password account</item>
          <item>Error messages displayed for OAuth failures</item>
          <item>Google button matches wireframe design (AU-01, AU-02)</item>
        </checklist>
      </manual-testing>
    </testing-strategy>
  </implementation-guidance>

  <!-- =================================================================== -->
  <!-- EXISTING CODE CONTEXT -->
  <!-- =================================================================== -->
  <existing-code-context>
    <file path="apps/web/src/lib/auth.ts">
      <summary>
        better-auth server configuration with Prisma adapter, session settings, and
        email/password authentication. OAuth socialProviders section is commented out
        (lines 52-55) and ready to be enabled.
      </summary>
      <key-sections>
        <section lines="7-11">Prisma adapter configuration</section>
        <section lines="14-21">Session configuration (7 days, daily refresh)</section>
        <section lines="36-42">Email/password authentication (emailVerified=false for testing)</section>
        <section lines="52-55">Commented socialProviders.google (ready to uncomment)</section>
      </key-sections>
      <notes>
        Email verification is currently disabled (requireEmailVerification: false) for easier testing.
        This may need to be enabled in future stories or production.
      </notes>
    </file>

    <file path="apps/web/src/lib/auth-client.ts">
      <summary>
        better-auth React client with exported helper functions for signUp, signIn, signOut.
        Already exports authClient which includes signIn.social() method for OAuth.
      </summary>
      <key-sections>
        <section lines="15-17">authClient creation with baseURL</section>
        <section lines="24-35">signUp helper function</section>
        <section lines="43-53">signIn helper function</section>
        <section lines="66">useSession hook export</section>
      </key-sections>
      <notes>
        authClient.signIn.social() method is available from better-auth/react.
        No additional code needed in this file for OAuth.
      </notes>
    </file>

    <file path="apps/web/src/components/auth/sign-in-form.tsx">
      <summary>
        Sign-in form with email/password fields, error handling, and a disabled Google button
        placeholder. Button is styled and positioned correctly per wireframes but currently
        disabled with title "Coming soon in Story 01.5".
      </summary>
      <key-sections>
        <section lines="99-127">Disabled Google sign-in button with icon</section>
        <section lines="129-137">OR divider between social and email/password</section>
        <section lines="140-266">Email/password sign-in form</section>
      </key-sections>
      <changes-required>
        - Remove disabled prop from Google button
        - Add onClick handler to call authClient.signIn.social({ provider: 'google' })
        - Add loading state for Google sign-in
        - Handle OAuth errors (show in error banner)
      </changes-required>
    </file>

    <file path="apps/web/src/components/auth/sign-up-form.tsx">
      <summary>
        Sign-up form with email/password fields, password strength indicator, terms checkbox.
        Currently does NOT have a Google button - needs to be added above the form.
      </summary>
      <key-sections>
        <section lines="69-102">Success message after registration</section>
        <section lines="104-243">Email/password registration form</section>
      </key-sections>
      <changes-required>
        - Add Google sign-up button before form (similar to sign-in form)
        - Add OR divider
        - Add handleGoogleSignUp function
        - Position button per wireframe AU-02
      </changes-required>
    </file>

    <file path=".env.example">
      <summary>
        Example environment variables file. Already includes placeholders for
        GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET (lines 19-20).
      </summary>
      <key-sections>
        <section lines="17-20">Better-auth configuration (SECRET, URL, Google OAuth)</section>
      </key-sections>
      <notes>
        Developers need to copy .env.example to .env.local and fill in Google OAuth credentials.
      </notes>
    </file>
  </existing-code-context>

  <!-- =================================================================== -->
  <!-- DESIGN REFERENCES -->
  <!-- =================================================================== -->
  <design-references>
    <wireframe id="AU-01">
      <title>Login Page</title>
      <location>docs/design/wireframes/Finished wireframes and html files/au-01_login_page/</location>
      <description>
        Shows "Sign in with Google" button below email/password form with OR divider.
        Button has Google icon on left, full width, outline style.
      </description>
      <assets>
        <asset type="html">code.html</asset>
        <asset type="png">screen.png</asset>
      </assets>
      <relevance>
        Primary reference for Google button styling and positioning on sign-in page.
      </relevance>
    </wireframe>

    <wireframe id="AU-02">
      <title>Register Page</title>
      <location>docs/design/wireframes/Finished wireframes and html files/au-02_register/</location>
      <description>
        Shows "Sign in with Google" button on registration page, positioned above email/password
        form with OR divider below it.
      </description>
      <assets>
        <asset type="html">code.html</asset>
        <asset type="png">screen.png</asset>
      </assets>
      <relevance>
        Primary reference for Google button on sign-up page. Button appears first before form.
      </relevance>
    </wireframe>

    <design-tokens>
      <color name="primary-action">#FF6B6B</color>
      <color name="text-primary">#000000</color>
      <color name="text-secondary">#6B7280</color>
      <color name="border">#E5E7EB</color>
      <spacing name="button-padding">12px 16px</spacing>
      <font name="button-text">14px, 500 weight</font>
    </design-tokens>
  </design-references>

  <!-- =================================================================== -->
  <!-- SECURITY CONSIDERATIONS -->
  <!-- =================================================================== -->
  <security>
    <csrf-protection>
      <description>
        OAuth state parameter prevents CSRF attacks during OAuth flow.
        better-auth generates and validates state automatically.
      </description>
      <implementation>
        State parameter included in OAuth redirect URL, validated on callback.
      </implementation>
    </csrf-protection>

    <token-storage>
      <description>
        OAuth access and refresh tokens stored in accounts table.
        Tokens are sensitive and should never be exposed to client.
      </description>
      <best-practices>
        - Store tokens as TEXT type (long strings)
        - Use database-level encryption at rest
        - Never include tokens in API responses
        - Use tokens server-side only for future Google API calls
      </best-practices>
    </token-storage>

    <session-management>
      <description>
        Session token stored in HTTP-only cookie (XSS protection).
        JWT includes userId, sessionId, workspaceId claims.
      </description>
      <settings>
        - Cookie name: hyvve.session
        - HTTP-only: true
        - Secure: true (production)
        - SameSite: lax
        - Max-Age: 7 days (default) or 30 days (remember me)
      </settings>
    </session-management>

    <account-linking-security>
      <description>
        When linking Google account to existing email/password user, verify email ownership.
        Google has already verified the email, so linking is safe.
      </description>
      <considerations>
        - Google email is verified by Google (trustworthy)
        - No additional email verification needed for OAuth users
        - User can have multiple authentication methods (email/password + Google)
      </considerations>
    </account-linking-security>
  </security>

  <!-- =================================================================== -->
  <!-- ERROR HANDLING -->
  <!-- =================================================================== -->
  <error-handling>
    <error-scenario type="user-cancellation">
      <trigger>User clicks "Cancel" on Google consent screen</trigger>
      <handling>
        - OAuth callback receives error parameter
        - Redirect to /sign-in with query param ?error=cancelled
        - Show toast: "Sign-in cancelled. Please try again."
      </handling>
      <implementation>
        better-auth handles automatically, check for error query param on sign-in page.
      </implementation>
    </error-scenario>

    <error-scenario type="invalid-state">
      <trigger>OAuth state parameter mismatch (CSRF attempt)</trigger>
      <handling>
        - better-auth validates state parameter
        - Returns 403 Forbidden if invalid
        - Log security event
        - Show error: "Security validation failed. Please try again."
      </handling>
    </error-scenario>

    <error-scenario type="google-api-error">
      <trigger>Google OAuth API returns error (rate limit, service down)</trigger>
      <handling>
        - Catch error in OAuth callback
        - Log error details for debugging
        - Redirect to sign-in with error message
        - Show toast: "Unable to sign in with Google. Please try again or use email sign-in."
      </handling>
    </error-scenario>

    <error-scenario type="missing-email-scope">
      <trigger>User denies email permission on Google consent screen</trigger>
      <handling>
        - OAuth callback receives error: access_denied
        - Show message: "Email permission is required to create an account."
        - Provide option to retry OAuth flow
      </handling>
    </error-scenario>

    <error-scenario type="network-timeout">
      <trigger>Network timeout during OAuth token exchange</trigger>
      <handling>
        - Retry token exchange once (exponential backoff)
        - If retry fails, redirect to sign-in with error
        - Show toast: "Connection timed out. Please check your internet and try again."
      </handling>
    </error-scenario>
  </error-handling>

  <!-- =================================================================== -->
  <!-- TECH SPEC TRACEABILITY -->
  <!-- =================================================================== -->
  <traceability>
    <tech-spec-reference>
      <file>docs/sprint-artifacts/tech-spec-epic-01.md</file>
      <sections>
        <section line="256">Google Cloud OAuth dependency</section>
        <section line="173-179">Google OAuth Flow workflow</section>
        <section line="99-113">Account data model</section>
        <section line="145-146">OAuth API endpoints</section>
        <section line="306-307">AC-4.1 and AC-4.2 (OAuth initiation and account linking)</section>
      </sections>
    </tech-spec-reference>

    <epic-reference>
      <file>docs/epics/EPIC-01-authentication.md</file>
      <sections>
        <section line="131-152">Story 01.5 - Implement Google OAuth</section>
        <section line="220-226">Wireframe references (AU-01, AU-02)</section>
        <section line="239-245">Environment variables required</section>
      </sections>
    </epic-reference>

    <prd-reference>
      <requirement>FR-1.3 - Social Authentication (Google OAuth)</requirement>
      <description>
        Users can sign in with Google account for frictionless onboarding.
        Target: &lt;3 minutes from signup to workspace creation.
      </description>
    </prd-reference>

    <architecture-reference>
      <adr>ADR-005 - better-auth Selection</adr>
      <rationale>
        better-auth chosen for native organization support and built-in OAuth providers.
        Google OAuth implementation aligns with this decision.
      </rationale>
    </architecture-reference>
  </traceability>

  <!-- =================================================================== -->
  <!-- DEFINITION OF DONE -->
  <!-- =================================================================== -->
  <definition-of-done>
    <criteria>
      <item>All acceptance criteria (AC-1 through AC-7) met and tested</item>
      <item>Google OAuth provider configured in better-auth (lib/auth.ts)</item>
      <item>"Sign in with Google" button enabled on sign-in page (sign-in-form.tsx)</item>
      <item>"Sign in with Google" button added to sign-up page (sign-up-form.tsx)</item>
      <item>OAuth callback handled correctly at /api/auth/callback/google</item>
      <item>New users created with email, name, image from Google profile</item>
      <item>Existing users can link Google account (account linking works)</item>
      <item>OAuth tokens stored securely in accounts table</item>
      <item>Error cases handled gracefully (cancellation, API errors, timeouts)</item>
      <item>Unit tests written for account linking logic (3 cases)</item>
      <item>Integration tests written for OAuth callback flow</item>
      <item>E2E test covers full Google sign-in flow (new user, existing user)</item>
      <item>UI matches wireframes AU-01 and AU-02</item>
      <item>Environment variables documented in .env.example</item>
      <item>Google Cloud Console setup documented (OAuth consent, credentials)</item>
      <item>Code reviewed and approved</item>
      <item>Merged to main branch</item>
      <item>Sprint status updated to "done" in sprint-status.yaml</item>
    </criteria>
  </definition-of-done>

  <!-- =================================================================== -->
  <!-- RISKS AND MITIGATIONS -->
  <!-- =================================================================== -->
  <risks>
    <risk id="RISK-1">
      <description>Google OAuth app requires verification for production</description>
      <impact>High - Cannot go live without verified app</impact>
      <likelihood>High</likelihood>
      <mitigation>
        Submit verification during EPIC-01 development.
        Use test users for development phase.
        Verification process takes 2-6 weeks (plan accordingly).
      </mitigation>
    </risk>

    <risk id="RISK-2">
      <description>User confusion about account linking</description>
      <impact>Medium - Support requests, user frustration</impact>
      <likelihood>Medium</likelihood>
      <mitigation>
        Clear messaging when linking accounts: "Your Google account has been linked".
        Document account linking in help center.
        Show linked accounts in user settings (future feature).
      </mitigation>
    </risk>

    <risk id="RISK-3">
      <description>Google API rate limits during development</description>
      <impact>Low - Slows development</impact>
      <likelihood>Low</likelihood>
      <mitigation>
        Use test user accounts sparingly.
        Avoid excessive OAuth flows during testing.
        Request rate limit increase if needed.
      </mitigation>
    </risk>

    <risk id="RISK-4">
      <description>OAuth state parameter vulnerability (CSRF)</description>
      <impact>High - Security breach</impact>
      <likelihood>Low</likelihood>
      <mitigation>
        better-auth handles CSRF protection automatically.
        Verify in security review before production.
        Include security tests for state validation.
      </mitigation>
    </risk>
  </risks>

  <!-- =================================================================== -->
  <!-- OPEN QUESTIONS -->
  <!-- =================================================================== -->
  <open-questions>
    <question id="Q1">
      <text>Should we request additional Google scopes (e.g., calendar, drive)?</text>
      <owner>Product</owner>
      <answer>No - only profile scopes (openid, email, profile) for MVP. Additional scopes in future modules.</answer>
      <status>resolved</status>
    </question>

    <question id="Q2">
      <text>What happens if user changes email on Google after linking?</text>
      <owner>Engineering</owner>
      <answer>Google providerAccountId (sub) is stable and won't change. Email change won't break link. User's HYVVE email remains unchanged unless they update it in settings.</answer>
      <status>resolved</status>
    </question>

    <question id="Q3">
      <text>Do we support unlinking Google account?</text>
      <owner>Product</owner>
      <answer>Not in MVP - future settings feature. User can always add/remove authentication methods in Account Settings (Epic 03).</answer>
      <status>resolved</status>
    </question>

    <question id="Q4">
      <text>Should we auto-refresh Google access tokens?</text>
      <owner>Engineering</owner>
      <answer>Yes - better-auth handles token refresh automatically using refresh_token. No additional code needed.</answer>
      <status>resolved</status>
    </question>
  </open-questions>

  <!-- =================================================================== -->
  <!-- ADDITIONAL NOTES -->
  <!-- =================================================================== -->
  <additional-notes>
    <note category="performance">
      OAuth flow adds ~500-1000ms due to Google redirect and token exchange.
      This is acceptable for sign-in UX and aligns with "90/5 Promise" of minimal friction.
    </note>

    <note category="compatibility">
      better-auth v1.0+ required for OAuth support.
      Tested with better-auth 1.0.0 and Prisma 6.x.
    </note>

    <note category="future-enhancements">
      Potential future enhancements (post-MVP):
      - GitHub OAuth (growth feature)
      - Microsoft OAuth (enterprise feature)
      - Apple Sign In (mobile apps)
      - Account unlinking in settings
      - Connected accounts management page
    </note>

    <note category="development-tips">
      During development:
      - Add your Google account as test user in Google Cloud Console
      - Use ngrok or similar for testing OAuth callback on localhost
      - Check better-auth debug logs for OAuth flow issues
      - Verify redirect URI matches exactly in Google Cloud Console
    </note>
  </additional-notes>
</story-context>
