<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>08.4</story-id>
    <story-title>Implement Document Upload and Extraction Pipeline</story-title>
    <epic>EPIC-08 - Business Onboarding &amp; Foundation Modules</epic>
    <status>ready-for-dev</status>
    <points>5</points>
    <priority>P1</priority>
    <dependencies>Story 08.3 (Onboarding Wizard UI)</dependencies>
    <generated-date>2025-12-04</generated-date>
  </metadata>

  <summary>
    <description>
      Implement the document upload and AI-powered extraction pipeline that allows users to upload existing business documents
      (business plans, market research, brand guides, pitch decks) during the onboarding wizard. The system parses these documents,
      extracts key business information using AI, maps the extracted data to validation/planning/branding fields, and identifies
      what information is missing.
    </description>

    <business-value>
      Enables users with existing documentation to accelerate their onboarding by pre-populating validation, planning, and branding
      data, while also highlighting gaps that need to be filled through the AI agent workflows. This reduces time-to-value and
      demonstrates the platform's intelligence.
    </business-value>
  </summary>

  <acceptance-criteria>
    <section name="File Upload Component">
      <criterion>Create file upload component with drag-and-drop functionality</criterion>
      <criterion>Support PDF, DOCX, MD file types</criterion>
      <criterion>Implement file validation: Maximum size 10MB per file, file type validation, clear error messages</criterion>
      <criterion>Display upload progress indicator</criterion>
      <criterion>Allow multiple file uploads (up to 5 files)</criterion>
      <criterion>Show preview of uploaded files with filename, size, type</criterion>
    </section>

    <section name="Document Extraction Endpoint">
      <criterion>Create /api/businesses/:id/documents POST endpoint</criterion>
      <criterion>Parse uploaded documents by file type: PDF, DOCX, MD</criterion>
      <criterion>Use AI agent to extract key business information (business model, financials, market analysis, customer profiles, brand elements)</criterion>
      <criterion>Map extracted data to appropriate fields in ValidationSession, PlanningSession, BrandingSession</criterion>
      <criterion>Identify missing sections and gaps</criterion>
      <criterion>Store raw file in storage (Supabase Storage or local for MVP)</criterion>
      <criterion>Create OnboardingDocument record with extraction results</criterion>
    </section>

    <section name="Extraction Results Display">
      <criterion>Display extraction results in structured format</criterion>
      <criterion>Show confidence scores for each extracted section (High >85%, Medium 60-85%, Low &lt;60%)</criterion>
      <criterion>Display gap analysis showing what's missing</criterion>
      <criterion>Allow manual correction of extracted data before accepting</criterion>
      <criterion>Provide side-by-side view: extracted data vs. source document sections</criterion>
    </section>

    <section name="Data Integration">
      <criterion>Pre-populate ValidationSession with extracted validation data</criterion>
      <criterion>Pre-populate PlanningSession with extracted planning data</criterion>
      <criterion>Pre-populate BrandingSession with extracted branding data</criterion>
      <criterion>Mark extracted fields with source: "document" metadata</criterion>
      <criterion>Allow user to review and approve pre-populated data</criterion>
      <criterion>Update OnboardingDocument.extractionStatus to "complete" on success</criterion>
    </section>
  </acceptance-criteria>

  <database-context>
    <model name="OnboardingDocument">
      <location>packages/db/prisma/schema.prisma:706-727</location>
      <fields>
        <field name="id" type="String" default="cuid()">Primary key</field>
        <field name="businessId" type="String">Foreign key to Business</field>
        <field name="fileName" type="String">Original filename</field>
        <field name="fileUrl" type="String">Storage URL for document</field>
        <field name="fileType" type="String">File type: pdf, docx, md</field>
        <field name="fileSize" type="Int">File size in bytes</field>
        <field name="extractedData" type="Json">AI extraction results with confidence scores</field>
        <field name="extractionStatus" type="String" default="pending">Status: pending, processing, complete, error</field>
        <field name="extractionError" type="String">Error message if extraction fails</field>
        <field name="uploadedAt" type="DateTime">Upload timestamp</field>
      </fields>
      <indexes>
        <index fields="businessId">For querying documents by business</index>
      </indexes>
    </model>

    <model name="Business">
      <location>packages/db/prisma/schema.prisma:542-580</location>
      <relevant-fields>
        <field name="id">Business identifier</field>
        <field name="workspaceId">Tenant context</field>
        <field name="onboardingStatus">Current onboarding phase (WIZARD, VALIDATION, etc.)</field>
        <field name="onboardingProgress">Progress percentage 0-100</field>
      </relevant-fields>
    </model>

    <model name="ValidationSession">
      <location>packages/db/prisma/schema.prisma:583-626</location>
      <extractable-fields>
        <field name="ideaDescription">JSON with problem/solution/customer</field>
        <field name="tam">Total Addressable Market data</field>
        <field name="sam">Serviceable Available Market data</field>
        <field name="som">Serviceable Obtainable Market data</field>
        <field name="competitors">Array of competitor objects</field>
        <field name="icps">Ideal Customer Profiles</field>
      </extractable-fields>
    </model>

    <model name="PlanningSession">
      <location>packages/db/prisma/schema.prisma:649-674</location>
      <extractable-fields>
        <field name="canvas">Business Model Canvas JSON</field>
        <field name="financials">Financial projections JSON</field>
      </extractable-fields>
    </model>

    <model name="BrandingSession">
      <location>packages/db/prisma/schema.prisma:677-704</location>
      <extractable-fields>
        <field name="positioning">Brand archetype, values, personality</field>
        <field name="voiceGuidelines">Tone, vocabulary, messaging templates</field>
        <field name="visualIdentity">Colors, typography, logo concept</field>
      </extractable-fields>
    </model>
  </database-context>

  <api-patterns>
    <pattern name="Next.js API Route Structure">
      <example-file>apps/web/src/app/api/businesses/route.ts</example-file>
      <key-patterns>
        <pattern>Use getSession() for authentication</pattern>
        <pattern>Validate workspaceId from session.session.activeWorkspaceId</pattern>
        <pattern>Use Zod schemas for request validation</pattern>
        <pattern>Return standardized response: { success: boolean, data?: any, error?: string, message?: string }</pattern>
        <pattern>Include proper HTTP status codes: 200, 201, 400, 401, 409, 500</pattern>
        <pattern>Log errors with console.error before returning</pattern>
      </key-patterns>
    </pattern>

    <pattern name="File Upload Handling">
      <library>react-dropzone (not yet installed, needs adding)</library>
      <validation>
        <rule>Max file size: 10MB (10 * 1024 * 1024 bytes)</rule>
        <rule>Accepted types: application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/markdown</rule>
        <rule>Max files: 5 per upload</rule>
      </validation>
      <storage-strategy>
        <mvp>Local file system: ./uploads/business-documents/</mvp>
        <production>Supabase Storage bucket: business-documents</production>
      </storage-strategy>
    </pattern>

    <pattern name="Document Parsing Libraries">
      <pdf>pdf-parse (needs installation)</pdf>
      <docx>mammoth (needs installation)</docx>
      <markdown>marked (needs installation)</markdown>
    </pattern>

    <pattern name="AI Extraction Service">
      <approach>Use BYOAI provider from workspace AIProviderConfig</approach>
      <prompt-structure>
        <instruction>Extract structured business data from document text</instruction>
        <categories>
          <category name="business_model">Value proposition, customer segments, revenue streams, cost structure</category>
          <category name="market_analysis">TAM/SAM/SOM, competitors, customer profiles/personas</category>
          <category name="financial_data">Revenue projections, cost projections, unit economics, funding requirements</category>
          <category name="brand_elements">Brand positioning, core values, voice/tone, visual identity</category>
        </categories>
        <output-format>JSON with confidence scores and source references</output-format>
      </prompt-structure>
    </pattern>
  </api-patterns>

  <component-patterns>
    <pattern name="Form Component Structure">
      <example>apps/web/src/components/onboarding/WizardStepDetails.tsx</example>
      <structure>
        <use-client>Components with forms must be 'use client' directives</use-client>
        <form-library>react-hook-form with @hookform/resolvers/standard-schema</form-library>
        <validation>Zod schemas from @/lib/validations/</validation>
        <ui-components>
          <component>Button from @/components/ui/button</component>
          <component>Input from @/components/ui/input</component>
          <component>Label from @/components/ui/label</component>
          <component>Textarea from @/components/ui/textarea</component>
        </ui-components>
        <error-display>Show field-level errors with aria-invalid and aria-describedby</error-display>
      </structure>
    </pattern>

    <pattern name="File Upload Component">
      <location>apps/web/src/components/business/document-upload.tsx (to create)</location>
      <dependencies>
        <dep>react-dropzone for drag-and-drop</dep>
        <dep>lucide-react for icons (Upload, FileText, X, Check)</dep>
        <dep>@/components/ui/progress for upload progress</dep>
        <dep>@/components/ui/alert for error messages</dep>
      </dependencies>
      <state-management>
        <state>files: File[] - Selected files</state>
        <state>uploading: boolean - Upload in progress</state>
        <state>uploadProgress: Record&lt;string, number&gt; - Per-file progress</state>
        <state>extractionResults: ExtractionResult[] - AI extraction results</state>
        <state>errors: Record&lt;string, string&gt; - Validation errors</state>
      </state-management>
    </pattern>

    <pattern name="Extraction Results Display">
      <location>apps/web/src/components/business/extraction-results.tsx (to create)</location>
      <sections>
        <section name="summary">Overall extraction summary with stats</section>
        <section name="confidence-badges">Visual indicators for high/medium/low confidence</section>
        <section name="extracted-data">Categorized extracted fields with edit capabilities</section>
        <section name="gap-analysis">Missing fields and recommendations</section>
        <section name="actions">Accept/Reject/Edit buttons</section>
      </sections>
      <confidence-colors>
        <high color="green">85-100%: Auto-populated</high>
        <medium color="yellow">60-85%: Flagged for review</medium>
        <low color="red">&lt;60%: Marked as incomplete</low>
      </confidence-colors>
    </pattern>
  </component-patterns>

  <validation-schemas>
    <schema name="Document Upload Validation">
      <location>apps/web/src/lib/validations/onboarding.ts (extend existing)</location>
      <schema-definition>
        <![CDATA[
export const documentUploadSchema = z.object({
  files: z.array(z.instanceof(File))
    .min(1, 'At least one file is required')
    .max(5, 'Maximum 5 files allowed')
    .refine(
      (files) => files.every(f => f.size <= 10 * 1024 * 1024),
      'Each file must be less than 10MB'
    )
    .refine(
      (files) => files.every(f =>
        ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/markdown'].includes(f.type)
      ),
      'Only PDF, DOCX, and MD files are allowed'
    ),
})

export type DocumentUploadData = z.infer<typeof documentUploadSchema>
        ]]>
      </schema-definition>
    </schema>
  </validation-schemas>

  <implementation-steps>
    <phase name="Phase 1: File Upload UI">
      <step>1. Install dependencies: react-dropzone, pdf-parse, mammoth, marked</step>
      <step>2. Create DocumentUpload component with drag-and-drop zone</step>
      <step>3. Implement file validation (size, type)</step>
      <step>4. Add file preview list with remove capability</step>
      <step>5. Implement upload progress indicator</step>
      <step>6. Add to onboarding wizard Step 4</step>
    </phase>

    <phase name="Phase 2: API Endpoint &amp; Document Parsing">
      <step>1. Create /api/businesses/[id]/documents/route.ts</step>
      <step>2. Implement multipart form data handling with formidable or multer</step>
      <step>3. Create document parsing service (PDF, DOCX, MD)</step>
      <step>4. Implement local file storage (MVP approach)</step>
      <step>5. Create OnboardingDocument database records</step>
      <step>6. Add error handling and validation</step>
    </phase>

    <phase name="Phase 3: AI Extraction Service">
      <step>1. Create document-extraction.service.ts</step>
      <step>2. Implement document type inference (business plan, market research, etc.)</step>
      <step>3. Build AI extraction prompt template</step>
      <step>4. Integrate with BYOAI provider from workspace config</step>
      <step>5. Parse AI response and calculate confidence scores</step>
      <step>6. Save extracted data to OnboardingDocument.extractedData</step>
    </phase>

    <phase name="Phase 4: Extraction Results UI">
      <step>1. Create ExtractionResults component</step>
      <step>2. Display extracted data by category (validation, planning, branding)</step>
      <step>3. Show confidence indicators and source references</step>
      <step>4. Implement gap analysis display</step>
      <step>5. Add manual edit capabilities for extracted fields</step>
      <step>6. Create accept/reject workflow</step>
    </phase>

    <phase name="Phase 5: Data Integration">
      <step>1. Implement pre-population of ValidationSession fields</step>
      <step>2. Implement pre-population of PlanningSession fields</step>
      <step>3. Implement pre-population of BrandingSession fields</step>
      <step>4. Add metadata tracking (source: "document")</step>
      <step>5. Update OnboardingDocument.extractionStatus on completion</step>
      <step>6. Add unit and integration tests</step>
    </phase>
  </implementation-steps>

  <file-paths>
    <frontend>
      <component>apps/web/src/components/business/document-upload.tsx</component>
      <component>apps/web/src/components/business/extraction-results.tsx</component>
      <component>apps/web/src/components/business/extraction-summary.tsx</component>
      <component>apps/web/src/components/business/gap-analysis.tsx</component>
      <validation>apps/web/src/lib/validations/onboarding.ts (extend)</validation>
      <types>apps/web/src/types/document-extraction.ts</types>
    </frontend>

    <api>
      <route>apps/web/src/app/api/businesses/[id]/documents/route.ts</route>
      <service>apps/web/src/lib/services/document-extraction.service.ts</service>
      <service>apps/web/src/lib/services/document-parser.service.ts</service>
      <service>apps/web/src/lib/services/file-storage.service.ts</service>
      <utils>apps/web/src/lib/utils/document-types.ts</utils>
    </api>

    <tests>
      <test>apps/web/src/components/business/__tests__/document-upload.test.tsx</test>
      <test>apps/web/src/components/business/__tests__/extraction-results.test.tsx</test>
      <test>apps/web/src/lib/services/__tests__/document-extraction.test.ts</test>
      <test>apps/web/src/lib/services/__tests__/document-parser.test.ts</test>
      <test>apps/web/src/app/api/businesses/[id]/documents/__tests__/route.test.ts</test>
    </tests>
  </file-paths>

  <external-dependencies>
    <npm-packages>
      <package name="react-dropzone" version="^14.2.3">Drag-and-drop file upload</package>
      <package name="pdf-parse" version="^1.1.1">PDF text extraction</package>
      <package name="mammoth" version="^1.8.0">DOCX text extraction</package>
      <package name="marked" version="^14.1.4">Markdown parsing</package>
    </npm-packages>

    <existing-dependencies>
      <package>zod (already installed): Schema validation</package>
      <package>react-hook-form (already installed): Form management</package>
      <package>@hyvve/db (workspace): Database access</package>
      <package>lucide-react (already installed): Icons</package>
    </existing-dependencies>
  </external-dependencies>

  <anti-hallucination-strategy>
    <requirement>All extracted market data must include source references (page/section)</requirement>
    <requirement>Claims without sources marked as "unverified"</requirement>
    <requirement>User review required before accepting extracted data</requirement>
    <requirement>Confidence scores prevent auto-population of low-confidence data (&lt;60%)</requirement>
    <requirement>Gap analysis highlights missing information prominently</requirement>
  </anti-hallucination-strategy>

  <testing-requirements>
    <unit-tests>
      <test>File validation logic (size, type, count)</test>
      <test>Document parsing (PDF, DOCX, MD)</test>
      <test>Confidence score calculation</test>
      <test>Gap analysis generation</test>
      <test>OnboardingDocument CRUD operations</test>
    </unit-tests>

    <integration-tests>
      <test>Upload endpoint with valid files</test>
      <test>Upload endpoint with invalid files (too large, wrong type)</test>
      <test>Extraction pipeline end-to-end</test>
      <test>Data mapping to ValidationSession/PlanningSession/BrandingSession</test>
      <test>Error handling (parsing errors, AI extraction errors)</test>
    </integration-tests>

    <e2e-tests>
      <test>User uploads business plan PDF</test>
      <test>System extracts and displays results</test>
      <test>User reviews and approves extracted data</test>
      <test>Data pre-populates validation/planning/branding forms</test>
      <test>User uploads multiple documents</test>
      <test>User corrects extracted data</test>
    </e2e-tests>

    <edge-cases>
      <case>Document with no extractable data</case>
      <case>Document with mixed content (partial business plan)</case>
      <case>Very large document (near 10MB limit)</case>
      <case>Corrupted file</case>
      <case>Duplicate file upload</case>
      <case>User uploads then abandons wizard</case>
    </edge-cases>
  </testing-requirements>

  <tech-spec-reference>
    <document>docs/archive/foundation-phase/sprint-artifacts/tech-spec-epic-08.md</document>
    <relevant-sections>
      <section>AD-08.3: Anti-Hallucination via ValidationSource Table (lines 521-542)</section>
      <section>AD-08.4: Business Plan Documents Stored in Supabase Storage (lines 544-558)</section>
      <section>Document Extraction Service (lines 198-329 in story file)</section>
      <section>Storage Strategy (lines 392-443 in story file)</section>
    </relevant-sections>
  </tech-spec-reference>

  <related-stories>
    <dependency>08.3 - Implement Onboarding Wizard UI (DONE)</dependency>
    <handoff-to>08.5 - Implement Validation Team Agno Configuration (uses extracted data)</handoff-to>
    <handoff-to>08.12 - Implement Planning Team Agno Configuration (uses extracted data)</handoff-to>
    <handoff-to>08.17 - Implement Branding Team Agno Configuration (uses extracted data)</handoff-to>
  </related-stories>

  <definition-of-done>
    <item>File upload component with drag-and-drop works on all browsers</item>
    <item>File validation prevents invalid uploads</item>
    <item>Upload progress indicator displays accurately</item>
    <item>Documents stored in local file system (MVP approach)</item>
    <item>OnboardingDocument records created successfully</item>
    <item>Document extraction parses PDF, DOCX, MD correctly</item>
    <item>AI extraction returns structured data with confidence scores</item>
    <item>Gap analysis identifies missing sections</item>
    <item>Extraction results display in UI with confidence indicators</item>
    <item>User can manually correct extracted data</item>
    <item>Extracted data pre-populates session models correctly</item>
    <item>All acceptance criteria met</item>
    <item>Unit tests passing (>80% coverage)</item>
    <item>Integration tests passing</item>
    <item>E2E test passing (upload → extract → review → accept)</item>
    <item>Code reviewed and approved</item>
    <item>No TypeScript errors</item>
    <item>No ESLint warnings</item>
    <item>Documentation updated (API docs, component docs)</item>
    <item>Deployed to development environment</item>
    <item>Tested with real business documents (3+ different types)</item>
  </definition-of-done>

  <notes>
    <note type="MVP-scope">Use local file storage for MVP; Supabase Storage integration can be added later</note>
    <note type="AI-provider">Leverage existing BYOAI configuration from Epic 06 for document extraction</note>
    <note type="user-experience">Show upload progress for large files; provide clear error messages for invalid files</note>
    <note type="resumability">Support resuming extraction if page is refreshed (save state to DB)</note>
    <note type="future-enhancement">OCR for scanned PDFs (out of scope for MVP)</note>
  </notes>
</story-context>
