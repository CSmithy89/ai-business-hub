<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story-id>04-3</story-id>
  <title>Implement Approval Router Service</title>
  <epic>EPIC-04 - Approval Queue System</epic>
  <status>review</status>
  <implementation-date>2025-12-03</implementation-date>

  <summary>
    Implemented ApprovalRouterService that routes approval requests based on confidence scores.
    The service orchestrates the complete approval creation workflow: confidence calculation,
    status/review type determination, due date calculation, default approver assignment,
    database persistence, event emission, and audit logging.
  </summary>

  <implementation>
    <files-created>
      <file>
        <path>apps/api/src/approvals/dto/create-approval.dto.ts</path>
        <purpose>DTO for creating approval requests with validation</purpose>
        <key-features>
          - Validates approval type, title, and required fields
          - Accepts confidence factors array for scoring
          - Supports optional priority, description, preview data
          - Validates priority enum values (low, medium, high, urgent)
        </key-features>
      </file>

      <file>
        <path>apps/api/src/approvals/services/approval-router.service.ts</path>
        <purpose>Core approval routing service based on confidence scores</purpose>
        <key-features>
          - Calculates confidence using ConfidenceCalculatorService
          - Routes based on score: &gt;85% auto_approved, 60-85% quick review, &lt;60% full review
          - Calculates due dates from priority (urgent: 4h, high: 24h, medium: 48h, low: 72h)
          - Finds default approver (first admin/owner in workspace)
          - Creates ApprovalItem with all metadata
          - Emits approval.approved for auto-approved items
          - Emits approval.requested for pending items
          - Logs routing decisions to audit trail
        </key-features>
      </file>

      <file>
        <path>apps/api/src/approvals/services/approval-router.service.spec.ts</path>
        <purpose>Comprehensive unit tests for ApprovalRouterService</purpose>
        <key-features>
          - Tests high confidence (>85%) routes to auto_approved
          - Tests medium confidence (60-85%) routes to pending/quick
          - Tests low confidence (&lt;60%) routes to pending/full
          - Tests all priority levels calculate correct due dates
          - Tests default approver lookup (owner preferred over admin)
          - Tests null assignedToId when no admin/owner exists
          - Tests event emission for both auto-approved and pending
          - Tests audit logging for all routing decisions
          - Tests optional parameters are included correctly
        </key-features>
      </file>
    </files-created>

    <files-modified>
      <file>
        <path>apps/api/src/approvals/approvals.module.ts</path>
        <changes>
          - Added ApprovalRouterService to providers array
          - Exported ApprovalRouterService for use in other modules
          - Updated module documentation
        </changes>
      </file>

      <file>
        <path>docs/archive/foundation-phase/sprint-artifacts/sprint-status.yaml</path>
        <changes>
          - Updated story status from 'drafted' to 'review'
        </changes>
      </file>
    </files-modified>
  </implementation>

  <technical-decisions>
    <decision>
      <topic>Confidence Thresholds</topic>
      <choice>Hardcoded thresholds (85% auto, 60% quick)</choice>
      <rationale>
        Used hardcoded thresholds matching the spec. ConfidenceCalculatorService
        already supports workspace-specific thresholds from WorkspaceSettings,
        which will be used when calculating confidence. Routing thresholds are
        kept simple for now.
      </rationale>
      <future-enhancement>
        Could make routing thresholds configurable per workspace in future if needed.
      </future-enhancement>
    </decision>

    <decision>
      <topic>Priority to Due Date Mapping</topic>
      <choice>Constant mapping: urgent=4h, high=24h, medium=48h, low=72h</choice>
      <rationale>
        Simple, predictable due date calculation based on priority level.
        Uses client-side calculation from current time.
      </rationale>
      <consideration>
        Does not account for timezone or business hours. This is acceptable
        for v1 but could be enhanced later with workspace timezone support.
      </consideration>
    </decision>

    <decision>
      <topic>Default Approver Assignment</topic>
      <choice>First admin/owner sorted by role (owner &lt; admin alphabetically)</choice>
      <rationale>
        Simple deterministic assignment. Prefers owner over admin.
        Returns null if no admin/owner exists (approval unassigned).
      </rationale>
      <future-enhancement>
        Could implement round-robin, workload balancing, or skill-based routing.
      </future-enhancement>
    </decision>

    <decision>
      <topic>Event Emission Strategy</topic>
      <choice>Different events for auto-approved vs pending</choice>
      <rationale>
        - Auto-approved items emit 'approval.approved' with decidedById='system'
        - Pending items emit 'approval.requested' with assignment details
        This allows downstream systems to handle each case appropriately.
      </rationale>
    </decision>

    <decision>
      <topic>Review Type Determination</topic>
      <choice>Derived from confidence score during routing</choice>
      <rationale>
        Review type (auto/quick/full) is determined at routing time based on
        confidence score and stored in the response. Not persisted to database
        as it can be derived from confidenceScore.
      </rationale>
    </decision>

    <decision>
      <topic>Service Method Signature</topic>
      <choice>Individual parameters instead of DTO object</choice>
      <rationale>
        Used explicit parameters (workspaceId, requestedBy, type, title, factors, options)
        instead of a single DTO object. This makes the required vs optional
        parameters clearer and allows for better type safety.
      </rationale>
    </decision>
  </technical-decisions>

  <dependencies>
    <service>
      <name>ConfidenceCalculatorService</name>
      <usage>Calculates confidence score from factors</usage>
      <story>04-1</story>
    </service>

    <service>
      <name>PrismaService</name>
      <usage>Database operations for approval creation and approver lookup</usage>
      <story>00-4</story>
    </service>

    <service>
      <name>EventBusService</name>
      <usage>Event emission (stub - Epic 05)</usage>
      <note>Currently a stub that logs events to console</note>
    </service>

    <service>
      <name>AuditLogService</name>
      <usage>Audit trail logging (stub - Story 04-9)</usage>
      <note>Currently a stub that logs to console</note>
    </service>

    <model>
      <name>ApprovalItem</name>
      <fields-used>
        - workspaceId (tenant isolation)
        - type (approval category)
        - title, description (display)
        - confidenceScore (routing decision)
        - confidenceFactors (JSON array)
        - aiRecommendation, aiReasoning (from calculator)
        - status (auto_approved or pending)
        - priority (low/medium/high/urgent)
        - assignedToId (default approver)
        - dueAt (calculated from priority)
        - sourceModule, sourceId (traceability)
        - requestedBy (user/agent who requested)
      </fields-used>
    </model>
  </dependencies>

  <testing>
    <unit-tests>
      <coverage>
        - All confidence threshold boundaries (85%, 60%)
        - All priority levels (urgent, high, medium, low)
        - Default approver lookup (owner preferred, admin fallback, null case)
        - Event emission for both auto-approved and pending
        - Audit logging for all routing decisions
        - Optional parameters handling
      </coverage>
      <test-count>11 test cases</test-count>
      <mocking-strategy>
        - Mocked PrismaService for database operations
        - Mocked ConfidenceCalculatorService for score calculation
        - Mocked EventBusService for event verification
        - Mocked AuditLogService for audit log verification
      </mocking-strategy>
    </unit-tests>

    <integration-tests>
      <status>Not implemented in this story</status>
      <note>
        Integration tests mentioned in story spec but not created.
        Will be added in future story if needed for end-to-end testing
        with real services and database.
      </note>
    </integration-tests>
  </testing>

  <routing-logic>
    <routing-matrix>
      <threshold score="&gt;85" status="auto_approved" review-type="auto">
        <description>Immediate execution, no human review needed</description>
        <event>approval.approved (decidedById: system)</event>
      </threshold>

      <threshold score="60-85" status="pending" review-type="quick">
        <description>1-click approval, minimal review</description>
        <event>approval.requested</event>
      </threshold>

      <threshold score="&lt;60" status="pending" review-type="full">
        <description>Full review with AI reasoning required</description>
        <event>approval.requested</event>
        <additional>aiReasoning field populated from ConfidenceCalculatorService</additional>
      </threshold>
    </routing-matrix>

    <priority-mapping>
      <priority level="urgent" hours="4">
        <use-case>Critical actions, immediate attention</use-case>
      </priority>

      <priority level="high" hours="24">
        <use-case>Important actions, same-day review</use-case>
      </priority>

      <priority level="medium" hours="48" default="true">
        <use-case>Standard actions</use-case>
      </priority>

      <priority level="low" hours="72">
        <use-case>Non-critical, can wait</use-case>
      </priority>
    </priority-mapping>
  </routing-logic>

  <api-usage-example>
    <description>
      While this story doesn't expose new API endpoints, the service will be used
      internally by other modules (e.g., content creation, email sending).
    </description>

    <example>
      <context>Content creation service requesting approval</context>
      <code><![CDATA[
// In content creation service
const approvalItem = await this.approvalRouter.routeApproval(
  'workspace-uuid',
  'agent-uuid',
  'content',
  'Blog post: AI in Business',
  [
    {
      factor: 'historical_accuracy',
      score: 85,
      weight: 0.25,
      explanation: '85% of similar posts were approved',
      concerning: false,
    },
    {
      factor: 'content_quality',
      score: 70,
      weight: 0.3,
      explanation: 'Grammar and readability scores',
      concerning: false,
    },
    {
      factor: 'brand_alignment',
      score: 65,
      weight: 0.25,
      explanation: 'Some tone inconsistencies',
      concerning: true,
    },
    {
      factor: 'user_preference',
      score: 80,
      weight: 0.2,
      explanation: 'User has approved similar content',
      concerning: false,
    },
  ],
  {
    description: 'Approval for publishing blog post',
    previewData: {
      contentType: 'blog_post',
      wordCount: 1500,
      excerpt: '...',
    },
    sourceModule: 'content',
    sourceId: 'blog-post-uuid',
    priority: 'medium',
  },
);

// Result: Confidence = 73.75 → pending/quick review
      ]]></code>
    </example>
  </api-usage-example>

  <validation>
    <acceptance-criteria>
      <criterion status="✓">ApprovalRouterService created with routeApproval method</criterion>
      <criterion status="✓">Confidence score thresholds implemented correctly (&gt;85%, 60-85%, &lt;60%)</criterion>
      <criterion status="✓">Status and review type determination logic working</criterion>
      <criterion status="✓">Priority to due date mapping implemented for all 4 priorities</criterion>
      <criterion status="✓">Default approver lookup from workspace members</criterion>
      <criterion status="✓">Auto-approved items created with status 'auto_approved'</criterion>
      <criterion status="✓">Pending items created with correct review type (quick/full)</criterion>
      <criterion status="✓">Event emission for approval.requested (pending items)</criterion>
      <criterion status="✓">Event emission for approval.approved (auto-approved items)</criterion>
      <criterion status="✓">Audit logging for all routing decisions</criterion>
      <criterion status="✓">Service exported from ApprovalsModule</criterion>
      <criterion status="✓">Unit tests written (11 test cases)</criterion>
    </acceptance-criteria>

    <typescript-compilation>
      <status>To be verified by running: cd apps/api &amp;&amp; npm run build</status>
    </typescript-compilation>

    <test-execution>
      <status>To be verified by running: cd apps/api &amp;&amp; npm test approval-router</status>
    </test-execution>
  </validation>

  <notes>
    <note category="stub-services">
      EventBusService and AuditLogService are stubs. Full implementations
      coming in Epic 05 (Event Bus) and Story 04-9 (Audit Trail).
    </note>

    <note category="multi-tenant">
      All operations are scoped by workspaceId for tenant isolation.
      Approval creation, approver lookup, event emission, and audit logging
      all include workspace context.
    </note>

    <note category="performance">
      - Default approver lookup uses indexed query on [workspaceId, role]
      - Single database write for approval creation
      - Async event emission (non-blocking)
      - Async audit logging (non-blocking)
    </note>

    <note category="error-handling">
      Service relies on NestJS exception handling. Database errors from
      Prisma will propagate as exceptions. ConfidenceCalculatorService
      throws BadRequestException for invalid factors.
    </note>

    <note category="idempotency">
      Not required for this story. Each call to routeApproval creates
      a new approval item. Future enhancement could add idempotency keys.
    </note>

    <note category="timezone">
      Due date calculation uses client-side time without timezone handling.
      This is acceptable for v1. Future enhancement could use workspace
      timezone from WorkspaceSettings.
    </note>
  </notes>

  <next-steps>
    <story id="04-4">
      <title>Create Approval Queue Dashboard</title>
      <description>
        Build the frontend dashboard that displays approval items using
        the ApprovalRouterService created in this story.
      </description>
    </story>
  </next-steps>
</story-context>
