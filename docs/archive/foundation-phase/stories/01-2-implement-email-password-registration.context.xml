<?xml version="1.0" encoding="UTF-8"?>
<story-context story-id="01-2" generated="2025-12-02">
  <metadata>
    <story-title>Implement Email/Password Registration</story-title>
    <epic>EPIC-01 Authentication System</epic>
    <priority>P0</priority>
    <points>3</points>
    <status>ready-for-dev</status>
    <previous-story>01-1-install-and-configure-better-auth (DONE)</previous-story>
  </metadata>

  <requirements>
    <user-story>
      As a new user, I want to register with my email and password so that I can create an account on the platform.
    </user-story>

    <acceptance-criteria>
      <criterion id="AC-1">Create sign-up page at /sign-up</criterion>
      <criterion id="AC-2">Validate email format and password strength (client-side and server-side)</criterion>
      <criterion id="AC-3">Hash password with Argon2id (better-auth default)</criterion>
      <criterion id="AC-4">Send email verification link after registration</criterion>
      <criterion id="AC-5">Create unverified user in database (emailVerified: false)</criterion>
      <criterion id="AC-6">Show success message with verification instructions</criterion>
      <criterion id="AC-7">Rate limit: 3 registration attempts per hour per IP address</criterion>
      <criterion id="AC-8">Handle duplicate email registration gracefully with "Email already in use" error</criterion>
      <criterion id="AC-9">Display password strength indicator during input</criterion>
      <criterion id="AC-10">Support terms acceptance checkbox requirement</criterion>
    </acceptance-criteria>

    <validation-rules>
      <email-validation>
        - Valid email format (RFC 5322)
        - Zod schema: z.string().email()
        - Normalize to lowercase before storage
      </email-validation>

      <password-validation>
        - Minimum 8 characters
        - At least one uppercase letter (A-Z)
        - At least one lowercase letter (a-z)
        - At least one number (0-9)
        - Zod schema:
          z.string()
            .min(8, "Password must be at least 8 characters")
            .regex(/[A-Z]/, "Password must contain uppercase letter")
            .regex(/[a-z]/, "Password must contain lowercase letter")
            .regex(/[0-9]/, "Password must contain number")
      </password-validation>

      <password-strength-indicator>
        - Weak: 0-2 criteria met (red)
        - Medium: 3 criteria met (yellow)
        - Strong: All 4 criteria met (green)
      </password-strength-indicator>
    </validation-rules>

    <api-contract>
      <endpoint>
        <path>POST /api/auth/sign-up/email</path>
        <request-body>
          {
            "email": "string",      // Valid email format
            "password": "string",   // Min 8 chars, uppercase, lowercase, number
            "name": "string"        // Full name
          }
        </request-body>
        <response-success>
          {
            "user": {
              "id": "string",
              "email": "string",
              "name": "string",
              "emailVerified": false
            },
            "session": null  // No session until email verified
          }
        </response-success>
        <error-codes>
          - EMAIL_IN_USE (409): Email already registered
          - INVALID_EMAIL (400): Email format invalid
          - WEAK_PASSWORD (400): Password doesn't meet requirements
          - RATE_LIMITED (429): Too many registration attempts
        </error-codes>
      </endpoint>
    </api-contract>
  </requirements>

  <technical-spec>
    <database-operations>
      <user-creation>
        Create unverified user:
        await prisma.user.create({
          data: {
            email: validatedEmail.toLowerCase(),
            passwordHash: await argon2.hash(password), // Handled by better-auth
            name: name,
            emailVerified: false,
          }
        });
      </user-creation>

      <verification-token>
        - Generate secure token (32 bytes, base64url encoded)
        - Store in VerificationToken table with 24-hour expiry
        - Token format: identifier = email, token = random string
      </verification-token>
    </database-operations>

    <email-integration>
      <service>Resend API</service>
      <template>Include verification link with token</template>
      <link-format>{NEXT_PUBLIC_URL}/verify-email?token={token}</link-format>
      <delivery-target>&lt; 5 seconds</delivery-target>
      <local-development>
        For local development without Resend API key:
        - Log verification URL to console
        - Or use email stubbing service like MailHog
      </local-development>
    </email-integration>

    <security>
      <password-hashing>
        - Algorithm: Argon2id (better-auth default)
        - Parameters: Memory cost, iterations configured by better-auth
        - Target hash time: 200-500ms (deliberate slowness for security)
      </password-hashing>

      <rate-limiting>
        - Implementation: Redis-backed token bucket (or in-memory for MVP)
        - Limit: 3 attempts per hour per IP address
        - Response: 429 status with Retry-After header
      </rate-limiting>
    </security>

    <better-auth-integration>
      The emailAndPassword plugin must be added to auth.ts configuration:

      import { emailAndPassword } from 'better-auth/plugins'

      export const auth = betterAuth({
        database: prismaAdapter(prisma),
        plugins: [
          organization({ ... }),
          emailAndPassword({
            requireEmailVerification: true,
            sendVerificationEmail: async ({ user, token }) => {
              await sendEmail({
                to: user.email,
                subject: "Verify your email",
                html: verificationEmailTemplate({ token })
              });
            }
          })
        ]
      });
    </better-auth-integration>
  </technical-spec>

  <existing-code>
    <current-auth-configuration>
      <!-- File: apps/web/src/lib/auth.ts -->
      <![CDATA[
import { betterAuth } from 'better-auth'
import { prismaAdapter } from 'better-auth/adapters/prisma'
import { organization } from 'better-auth/plugins'
import { prisma } from '@hyvve/db'

export const auth = betterAuth({
  // Database adapter using Prisma
  database: prismaAdapter(prisma, {
    provider: 'postgresql',
  }),

  // Session configuration
  session: {
    expiresIn: 60 * 60 * 24 * 7,      // 7 days (default)
    updateAge: 60 * 60 * 24,          // Refresh daily
    cookieCache: {
      enabled: true,
      maxAge: 60 * 15,                // 15 minutes (access token lifetime)
    },
  },

  // Security settings
  secret: process.env.BETTER_AUTH_SECRET!,
  baseURL: process.env.BETTER_AUTH_URL!,

  // Plugins for multi-tenant organization support
  plugins: [
    organization({
      allowUserToCreateOrganization: true,
      // Role definitions will be fully implemented in Epic 02
    }),
  ],

  // Advanced options
  advanced: {
    cookiePrefix: 'hyvve',
    crossSubDomainCookies: {
      enabled: false,                 // Single domain for MVP
    },
  },

  // Email configuration (will be added in Story 01.2)
  // emailAndPassword: { ... }

  // OAuth configuration (will be added in Story 01.5)
  // socialProviders: {
  //   google: { ... }
  // }
})

// Export type-safe auth client
export type Auth = typeof auth
      ]]>
    </current-auth-configuration>

    <api-route-handler>
      <!-- File: apps/web/src/app/api/auth/[...all]/route.ts -->
      API route handler already exists from Story 01-1.
      The better-auth library will automatically handle the /api/auth/sign-up/email endpoint
      once the emailAndPassword plugin is configured.
    </api-route-handler>

    <prisma-models>
      <!-- From packages/db/prisma/schema.prisma -->
      User model:
      - id: String @id @default(uuid())
      - email: String @unique
      - emailVerified: Boolean @default(false)
      - name: String?
      - passwordHash: String?
      - createdAt: DateTime @default(now())
      - updatedAt: DateTime @updatedAt

      VerificationToken model:
      - id: String @id @default(uuid())
      - identifier: String
      - token: String @unique
      - expiresAt: DateTime
      - createdAt: DateTime @default(now())
      - @@unique([identifier, token])
    </prisma-models>
  </existing-code>

  <wireframe-reference>
    <wireframe-id>AU-02 Register</wireframe-id>
    <location>docs/design/wireframes/Finished wireframes and html files/au-02_register/sign_up/</location>
    <files>
      - code.html: Full HTML implementation with Tailwind CSS
      - screen.png: Visual reference screenshot
    </files>

    <design-elements>
      <layout>
        - Two-column layout (split-screen)
        - Left panel: Branding section with HYVVE logo, tagline, gradient background
        - Right panel: Registration form with centered content
        - Mobile: Single column, form only
      </layout>

      <branding-section>
        - HYVVE logo with icon (hexagon layers)
        - Heading: "Empower Your Business with AI."
        - Subheading: "Automate, analyze, and accelerate your operations..."
        - Footer: Copyright notice
        - Background: Gradient from primary/10 to transparent
      </branding-section>

      <form-structure>
        1. Page heading: "Create your account"
        2. Subheading: "Start your 14-day free trial. No credit card required."
        3. Social login buttons (Google, Microsoft) - 2-column grid
        4. Divider with "or" text
        5. Form fields:
           - Full Name (text input)
           - Work Email (email input)
           - Password (password input with show/hide toggle)
           - Password strength indicator (progress bar + label)
           - Company Name (optional text input)
        6. Checkboxes:
           - Terms acceptance (required)
           - Marketing updates (optional)
        7. Submit button: "Create Account"
        8. Sign-in link: "Already have an account? Sign in"
      </form-structure>

      <password-strength-indicator>
        - Visual: Horizontal progress bar (1/4 width shown in wireframe)
        - Color coding: Green for "Strong", Yellow for "Medium", Red for "Weak"
        - Text label next to bar showing strength level
        - Positioned directly below password input
      </password-strength-indicator>

      <styling>
        - Primary color: #FF6B6B (coral red)
        - Secondary color: #20B2AA (light sea green)
        - Font: Inter (display), JetBrains Mono (code)
        - Border radius: 8px (md)
        - Input height: 44px (h-11)
        - Button padding: py-2.5 px-4
        - Dark mode support with CSS classes
      </styling>
    </design-elements>

    <interaction-patterns>
      - Password visibility toggle button (eye icon)
      - Real-time password strength calculation
      - Form validation on blur and submit
      - Loading state on submit button during API call
      - Focus states with primary color ring
      - Hover states on buttons and links
    </interaction-patterns>
  </wireframe-reference>

  <dependencies>
    <npm-packages>
      Already installed from Story 01-1:
      - better-auth ^1.4.4
      - @hyvve/db (workspace package with Prisma client)

      Additional packages needed:
      - resend ^3.0.0 (email service)
      - react-email ^2.0.0 (email templates)
      - @react-email/components ^0.0.12 (email components)
      - zod ^3.23.0 (validation schemas)

      Note: Argon2id is built into better-auth, no separate package needed.
    </npm-packages>

    <environment-variables>
      Already configured from Story 01-1:
      - BETTER_AUTH_SECRET
      - BETTER_AUTH_URL

      New variables needed:
      - RESEND_API_KEY (from https://resend.com)
      - NEXT_PUBLIC_URL (base URL for verification links)

      For local development without Resend:
      - Set RESEND_API_KEY to "test" and log emails to console
    </environment-variables>
  </dependencies>

  <implementation-guidance>
    <step-by-step>
      <step number="1">
        <title>Update auth.ts with emailAndPassword plugin</title>
        <details>
          - Import emailAndPassword from 'better-auth/plugins'
          - Add to plugins array with requireEmailVerification: true
          - Implement sendVerificationEmail callback
          - For local dev, log verification URL to console if no Resend key
        </details>
      </step>

      <step number="2">
        <title>Create email service (lib/email.ts)</title>
        <details>
          - Initialize Resend client with API key
          - Create sendVerificationEmail function
          - Create verificationEmailTemplate using React Email
          - Handle errors gracefully (log and continue)
          - For local dev, provide console fallback
        </details>
      </step>

      <step number="3">
        <title>Create validation schemas (lib/validations/auth.ts)</title>
        <details>
          - Define signUpSchema with Zod
          - Email validation: z.string().email()
          - Password validation with regex patterns
          - Name validation: z.string().min(1)
          - Export reusable schemas
        </details>
      </step>

      <step number="4">
        <title>Create password strength utilities</title>
        <details>
          - Function to calculate password strength (0-4 score)
          - Check each criterion: length, uppercase, lowercase, number
          - Return score and label ("Weak", "Medium", "Strong")
          - Return color class for UI styling
        </details>
      </step>

      <step number="5">
        <title>Create password strength indicator component</title>
        <details>
          - File: components/auth/password-strength-indicator.tsx
          - Props: password string, show strength label
          - Calculate strength on password change
          - Render progress bar with color coding
          - Display criteria checklist (optional enhancement)
        </details>
      </step>

      <step number="6">
        <title>Create auth layout component</title>
        <details>
          - File: components/auth/auth-layout.tsx
          - Two-column layout matching wireframe
          - Left: Branding section with HYVVE logo and tagline
          - Right: Children (form content)
          - Responsive: Single column on mobile
          - Reusable for all auth pages (sign-in, sign-up, etc.)
        </details>
      </step>

      <step number="7">
        <title>Create sign-up form component</title>
        <details>
          - File: components/auth/sign-up-form.tsx
          - Use React Hook Form with Zod resolver
          - Fields: name, email, password, terms checkbox
          - Real-time password strength indicator
          - Client-side validation with error messages
          - Submit handler calling better-auth sign-up
          - Loading state during submission
          - Success message after registration
        </details>
      </step>

      <step number="8">
        <title>Create sign-up page</title>
        <details>
          - File: app/(auth)/sign-up/page.tsx
          - Use AuthLayout wrapper
          - Render SignUpForm component
          - Add Google OAuth button (placeholder for Story 01.5)
          - Add "Already have account? Sign in" link
          - Match wireframe design exactly
        </details>
      </step>

      <step number="9">
        <title>Implement rate limiting (optional for MVP)</title>
        <details>
          - For MVP: Can defer to Story 01.4 or later
          - For full implementation:
            - Use Redis or in-memory store
            - Track attempts by IP address
            - Return 429 after 3 attempts per hour
            - Add Retry-After header
        </details>
      </step>

      <step number="10">
        <title>Add environment variables</title>
        <details>
          - Update .env.local with RESEND_API_KEY
          - Update .env.local with NEXT_PUBLIC_URL
          - Update .env.example with documentation
          - For local dev: Document console fallback option
        </details>
      </step>

      <step number="11">
        <title>Test the registration flow</title>
        <details>
          - Submit valid registration
          - Verify user created in database (emailVerified: false)
          - Check verification email sent (or logged to console)
          - Test duplicate email error handling
          - Test weak password rejection
          - Test invalid email format
          - Verify password strength indicator updates
        </details>
      </step>
    </step-by-step>

    <file-structure>
      Files to create:
      - apps/web/src/app/(auth)/sign-up/page.tsx
      - apps/web/src/components/auth/sign-up-form.tsx
      - apps/web/src/components/auth/password-strength-indicator.tsx
      - apps/web/src/components/auth/auth-layout.tsx
      - apps/web/src/lib/email.ts
      - apps/web/src/lib/validations/auth.ts
      - apps/web/src/lib/utils/password-strength.ts
      - apps/web/src/emails/verification-email.tsx

      Files to modify:
      - apps/web/src/lib/auth.ts (add emailAndPassword plugin)
      - apps/web/.env.local (add RESEND_API_KEY, NEXT_PUBLIC_URL)
      - apps/web/.env.example (document new variables)
      - apps/web/package.json (add dependencies)
    </file-structure>

    <client-side-integration>
      better-auth provides a client-side helper for sign-up:

      import { createAuthClient } from 'better-auth/react'

      const authClient = createAuthClient({
        baseURL: process.env.NEXT_PUBLIC_URL
      })

      // In form submit handler:
      const { data, error } = await authClient.signUp.email({
        email: formData.email,
        password: formData.password,
        name: formData.name,
      })

      if (error) {
        // Handle error (EMAIL_IN_USE, WEAK_PASSWORD, etc.)
      } else {
        // Show success message
      }
    </client-side-integration>

    <error-handling>
      Common errors to handle:
      - EMAIL_IN_USE (409): "This email is already registered. Try signing in instead."
      - INVALID_EMAIL (400): "Please enter a valid email address."
      - WEAK_PASSWORD (400): "Password must meet all strength requirements."
      - RATE_LIMITED (429): "Too many registration attempts. Please try again later."
      - Network errors: "Unable to connect. Please check your internet connection."
      - Server errors: "Something went wrong. Please try again."
    </error-handling>
  </implementation-guidance>

  <acceptance-tests>
    <test id="TEST-1" criterion="AC-1">
      Navigate to /sign-up
      Verify page renders with all form fields
      Verify layout matches AU-02 wireframe
    </test>

    <test id="TEST-2" criterion="AC-2">
      Enter invalid email format
      Verify client-side validation error shown
      Submit form with invalid email
      Verify server-side validation error returned
    </test>

    <test id="TEST-3" criterion="AC-2">
      Enter password with only 6 characters
      Verify "must be at least 8 characters" error
      Enter password without uppercase letter
      Verify "must contain uppercase letter" error
      Enter password without lowercase letter
      Verify "must contain lowercase letter" error
      Enter password without number
      Verify "must contain number" error
    </test>

    <test id="TEST-4" criterion="AC-3">
      Submit valid registration form
      Verify password is hashed (not stored as plaintext)
      Verify hash starts with $argon2id$ prefix
    </test>

    <test id="TEST-5" criterion="AC-4">
      Submit valid registration form
      Verify verification email sent (check Resend dashboard or console log)
      Verify email contains verification link with token
      Verify link format: {NEXT_PUBLIC_URL}/verify-email?token={token}
    </test>

    <test id="TEST-6" criterion="AC-5">
      Submit valid registration form
      Query database for new user record
      Verify user.emailVerified === false
      Verify user.email is lowercase normalized
    </test>

    <test id="TEST-7" criterion="AC-6">
      Submit valid registration form
      Verify success message displayed
      Verify message includes "Please check your email to verify your account"
      Verify message includes link to resend verification email
    </test>

    <test id="TEST-8" criterion="AC-7">
      Attempt to register 3 times from same IP
      Verify 4th attempt returns 429 status
      Verify Retry-After header included
      Verify error message shown to user
    </test>

    <test id="TEST-9" criterion="AC-8">
      Register with email test@example.com
      Attempt to register again with same email
      Verify 409 status returned
      Verify error message: "Email already in use"
      Verify user is not prompted to "try signing in instead"
    </test>

    <test id="TEST-10" criterion="AC-9">
      Type password with 5 characters
      Verify strength indicator shows "Weak" (red)
      Type password with 8 characters, all lowercase
      Verify strength indicator shows "Medium" (yellow)
      Type password with 8+ characters, uppercase, lowercase, number
      Verify strength indicator shows "Strong" (green)
    </test>

    <test id="TEST-11" criterion="AC-10">
      Attempt to submit form without checking terms checkbox
      Verify form validation prevents submission
      Verify error message shown near checkbox
      Check terms checkbox and submit
      Verify form submits successfully
    </test>

    <test id="TEST-12">
      Submit registration form
      Verify "Create Account" button shows loading state
      Verify button is disabled during submission
      Verify button text changes to "Creating account..." (optional)
    </test>

    <test id="TEST-13">
      Submit registration with no internet connection
      Verify network error message shown
      Verify user can retry submission
    </test>
  </acceptance-tests>

  <architecture-alignment>
    <adr-references>
      - ADR-005: better-auth selected for authentication
        Implementation: Using emailAndPassword plugin for registration

      - NFR-S1: Argon2id for password hashing
        Implementation: Provided by better-auth default configuration

      - NFR-S7: Rate limiting implementation
        Implementation: Redis-backed token bucket (or in-memory for MVP)
    </adr-references>

    <tech-spec-alignment>
      This story implements:
      - APIs and Interfaces: POST /api/auth/sign-up/email endpoint
      - Data Models: User creation with emailVerified: false
      - Security: Password hashing, rate limiting
      - Dependencies: Resend email integration
      - Wireframe Reference: AU-02 Register wireframe
    </tech-spec-alignment>

    <epic-alignment>
      Story 01.2 is the second story in EPIC-01 Authentication System.

      Prerequisites:
      - Story 01.1 (DONE): better-auth installed and configured

      Enables:
      - Story 01.3: Email Verification (requires verification token generation)
      - Story 01.4: Sign-In (shares validation logic and UI patterns)
    </epic-alignment>
  </architecture-alignment>

  <notes>
    <implementation-tips>
      1. Start with auth.ts plugin configuration first
      2. Create validation schemas before building form
      3. Build password strength indicator as isolated component
      4. Test email sending locally with console logging first
      5. Get Resend API key from resend.com (free tier available)
      6. Use React Hook Form for better form state management
      7. Match wireframe styling exactly (colors, spacing, fonts)
      8. Consider using shadcn/ui components (Input, Button, Checkbox)
    </implementation-tips>

    <local-development-without-resend>
      For developers without Resend API key:

      In lib/email.ts:
      if (!process.env.RESEND_API_KEY || process.env.RESEND_API_KEY === 'test') {
        console.log('ðŸ“§ Verification Email (Local Dev Mode)');
        console.log(`To: ${to}`);
        console.log(`Subject: ${subject}`);
        console.log(`Verification Link: ${verificationLink}`);
        return { success: true };
      }

      This allows story completion without external dependencies.
    </local-development-without-resend>

    <shadcn-ui-components>
      Recommended shadcn/ui components to install:
      - Input (for text fields)
      - Button (for submit and social buttons)
      - Checkbox (for terms acceptance)
      - Label (for form labels)
      - Card (optional, for auth layout container)

      Install with: npx shadcn-ui@latest add input button checkbox label
    </shadcn-ui-components>

    <google-oauth-placeholder>
      The wireframe shows "Continue with Google" button.
      For this story, render the button but disable it with tooltip:
      "Google sign-in coming soon"

      Full OAuth implementation is in Story 01.5.
    </google-oauth-placeholder>
  </notes>

  <traceability>
    <requirement-mapping>
      | Acceptance Criterion | Tech Spec Section | Test ID |
      |---------------------|-------------------|---------|
      | AC-1: Sign-up page | UI Components, File Structure | TEST-1 |
      | AC-2: Validation | Validation Rules, Security | TEST-2, TEST-3 |
      | AC-3: Password hashing | Security - Password Hashing | TEST-4 |
      | AC-4: Verification email | Email Integration | TEST-5 |
      | AC-5: Unverified user | Database Operations | TEST-6 |
      | AC-6: Success message | UI Components | TEST-7 |
      | AC-7: Rate limiting | Security - Rate Limiting | TEST-8 |
      | AC-8: Duplicate email | Error Codes, API Endpoint | TEST-9 |
      | AC-9: Strength indicator | Validation Rules, UI Components | TEST-10 |
      | AC-10: Terms checkbox | UI Components | TEST-11 |
    </requirement-mapping>

    <story-dependencies>
      <upstream>
        - 01-1: better-auth configuration (DONE)
      </upstream>

      <downstream>
        - 01-3: Email verification flow
        - 01-4: Sign-in implementation
        - 01-8: Auth UI components consolidation
      </downstream>
    </story-dependencies>
  </traceability>
</story-context>
