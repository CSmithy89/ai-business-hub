<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story-id>01-6</story-id>
  <title>Implement Password Reset Flow</title>
  <epic>EPIC-01 - Authentication System</epic>
  <generated-date>2025-12-02</generated-date>

  <overview>
    <description>
      Implement complete password reset flow allowing users to request password reset
      via email and set a new password using a secure time-limited token. This includes
      the forgot password page, reset password page, email integration, and session
      invalidation on successful reset.
    </description>

    <acceptance-criteria>
      <criterion>Create forgot password page at /forgot-password</criterion>
      <criterion>Generate secure reset token (1hr expiry)</criterion>
      <criterion>Send password reset email via Resend</criterion>
      <criterion>Create reset page at /reset-password</criterion>
      <criterion>Validate token and update password</criterion>
      <criterion>Invalidate all existing sessions on reset</criterion>
      <criterion>Rate limit: 3 attempts per hour</criterion>
    </acceptance-criteria>
  </overview>

  <technical-context>
    <architecture>
      <component name="better-auth">
        <purpose>Authentication library with built-in password reset functionality</purpose>
        <location>apps/web/src/lib/auth.ts</location>
        <configuration>
          - forgetPassword plugin for reset token generation
          - resetPassword plugin for password update
          - sendResetPassword callback for email integration
          - expiresIn: 3600 seconds (1 hour)
        </configuration>
      </component>

      <component name="email-service">
        <purpose>Send password reset emails via Resend</purpose>
        <location>apps/web/src/lib/email.ts</location>
        <status>Already implemented in Story 01-2</status>
        <function>sendPasswordResetEmail(email: string, token: string)</function>
      </component>

      <component name="prisma-database">
        <purpose>Store reset tokens and manage sessions</purpose>
        <models>
          - User: passwordHash field for password storage
          - Session: All sessions deleted on password reset
          - VerificationToken: Store reset tokens with expiry
        </models>
      </component>
    </architecture>

    <existing-implementation>
      <file path="apps/web/src/lib/auth.ts">
        <status>Needs update</status>
        <changes>
          - Add forgetPassword callback configuration
          - Add resetPassword callback configuration
          - Integrate with sendPasswordResetEmail
        </changes>
      </file>

      <file path="apps/web/src/lib/email.ts">
        <status>Ready to use</status>
        <note>sendPasswordResetEmail function already implemented</note>
      </file>

      <file path="apps/web/src/app/forgot-password/page.tsx">
        <status>Placeholder exists</status>
        <changes>Replace with full implementation including form and state management</changes>
      </file>
    </existing-implementation>

    <api-endpoints>
      <endpoint method="POST" path="/api/auth/forget-password">
        <description>Request password reset token</description>
        <request>{ email: string }</request>
        <response>{ success: boolean }</response>
        <rate-limit>3 requests per hour</rate-limit>
      </endpoint>

      <endpoint method="POST" path="/api/auth/reset-password">
        <description>Submit new password with token</description>
        <request>{ token: string, password: string }</request>
        <response>{ success: boolean }</response>
      </endpoint>
    </api-endpoints>
  </technical-context>

  <design-references>
    <wireframe id="AU-03" name="Forgot Password">
      <location>docs/design/wireframes/Finished wireframes and html files/au-03_forgot_password/code.html</location>
      <states>
        <state>Initial form with email input</state>
        <state>Submitting (loading spinner)</state>
        <state>Success (check your email message)</state>
        <state>Error (email not found)</state>
        <state>Rate limited (too many requests)</state>
        <state>Resend available (after timeout)</state>
      </states>
      <design-elements>
        - Centered layout with max-width card
        - HYVVE logo at top
        - Email input field
        - "Send Reset Link" button
        - "Back to sign in" link
        - Error/success messages
        - Material Symbols icons
      </design-elements>
    </wireframe>

    <wireframe id="AU-04" name="Password Reset">
      <location>docs/design/wireframes/Finished wireframes and html files/au-04_password_reset/code.html</location>
      <states>
        <state>Reset form with requirements</state>
        <state>All requirements met (ready to submit)</state>
        <state>Success (password reset successful)</state>
        <state>Expired link</state>
        <state>Invalid link</state>
      </states>
      <design-elements>
        - New password input with show/hide toggle
        - Password strength indicator (weak/medium/strong)
        - Password requirements checklist:
          * At least 8 characters
          * One uppercase letter
          * One lowercase letter
          * One number
          * One special character
        - Confirm password input
        - Passwords match/don't match indicator
        - "Reset Password" button
        - Success state with checkmark
        - Auto-redirect countdown
      </design-elements>
    </wireframe>

    <style-guide>
      <colors>
        - primary: #FF6B6B (coral red)
        - secondary: #20B2AA (turquoise)
        - success: #10B981 (green)
        - warning: #F59E0B (amber)
        - error: #EF4444 (red)
        - background-light: #FFFBF5 (cream)
        - surface-light: #FFFFFF (white)
        - border-light: #E5E5E5 (light gray)
        - text-primary: #1a1a1a (dark)
        - text-secondary: #6B7280 (medium gray)
      </colors>

      <typography>
        - Font: Inter
        - Headings: bold, tracking-tight
        - Body: normal weight
        - Labels: medium weight, text-sm
      </typography>

      <spacing>
        - Card padding: p-8 sm:p-12
        - Form gaps: gap-4 to gap-8
        - Input height: h-11 or h-12
        - Border radius: rounded-md (8px) to rounded-lg (12px)
      </spacing>
    </style-guide>
  </design-references>

  <implementation-guidance>
    <password-validation>
      <requirements>
        - Minimum 8 characters
        - At least one uppercase letter (A-Z)
        - At least one lowercase letter (a-z)
        - At least one number (0-9)
        - At least one special character (!@#$%^&amp;*()_+-=[]{}|;:,."&lt;&gt;?)
      </requirements>

      <strength-calculation>
        <level name="weak">0-2 requirements met</level>
        <level name="medium">3-4 requirements met</level>
        <level name="strong">5 requirements met</level>
      </strength-calculation>

      <implementation>
        Create utility function:
        - calculatePasswordStrength(password: string): 'weak' | 'medium' | 'strong'
        - Use regex patterns for each requirement
        - Return strength level based on count
      </implementation>
    </password-validation>

    <rate-limiting>
      <strategy>In-memory rate limiting for MVP</strategy>
      <implementation>
        - Use Map to track attempts by email
        - Structure: Map&lt;email, { count: number, resetAt: number }&gt;
        - Limit: 3 attempts per hour
        - Reset counter after 1 hour
        - Cleanup old entries periodically
      </implementation>
      <future-enhancement>Move to Redis for distributed systems</future-enhancement>
    </rate-limiting>

    <error-handling>
      <security-consideration>
        Always show success message when email submitted, regardless of whether
        user exists. This prevents email enumeration attacks.
      </security-consideration>

      <error-states>
        <error type="invalid-token">
          <message>Invalid or expired reset link</message>
          <action>Offer to request new reset link</action>
        </error>

        <error type="expired-token">
          <message>Reset link expired</message>
          <action>Show "Request New Reset Link" button</action>
        </error>

        <error type="rate-limited">
          <message>Too many requests. Please wait X minutes</message>
          <action>Disable form, show countdown</action>
        </error>

        <error type="network-error">
          <message>Something went wrong. Please try again</message>
          <action>Show retry button</action>
        </error>
      </error-states>
    </error-handling>

    <session-invalidation>
      <requirement>
        On successful password reset, invalidate ALL existing sessions for the user.
        This forces re-authentication on all devices for security.
      </requirement>

      <implementation>
        better-auth handles this automatically in resetPassword callback when configured.
        No additional code needed - just enable the feature in configuration.
      </implementation>
    </session-invalidation>
  </implementation-guidance>

  <component-structure>
    <component name="PasswordStrengthIndicator">
      <props>
        <prop name="password" type="string" description="Current password value"/>
      </props>
      <functionality>
        - Calculate strength level (weak/medium/strong)
        - Display color-coded progress bar
        - Show strength label
        - Update in real-time
      </functionality>
    </component>

    <component name="PasswordRequirements">
      <props>
        <prop name="password" type="string" description="Current password value"/>
      </props>
      <functionality>
        - Check each requirement individually
        - Display checklist with check/circle icons
        - Green for met requirements
        - Gray for unmet requirements
      </functionality>
    </component>

    <component name="PasswordInput">
      <props>
        <prop name="value" type="string" description="Input value"/>
        <prop name="onChange" type="function" description="Change handler"/>
        <prop name="label" type="string" description="Input label"/>
        <prop name="placeholder" type="string" description="Placeholder text"/>
        <prop name="error" type="string" optional="true" description="Error message"/>
      </props>
      <functionality>
        - Text input with type="password"
        - Show/hide toggle with eye icon
        - Proper labeling for accessibility
        - Error state styling
      </functionality>
    </component>
  </component-structure>

  <testing-considerations>
    <manual-testing>
      <test name="happy-path">
        1. Visit /forgot-password
        2. Enter valid email
        3. Submit form
        4. Check console for reset email (dev mode)
        5. Copy reset URL from console
        6. Visit reset URL
        7. Enter new password meeting requirements
        8. Confirm password
        9. Submit form
        10. Verify redirect to sign-in
        11. Sign in with new password
      </test>

      <test name="rate-limiting">
        1. Request reset 3 times rapidly
        2. Verify 4th attempt shows rate limit error
        3. Wait for timeout or reset
        4. Verify can request again
      </test>

      <test name="expired-token">
        1. Request password reset
        2. Wait more than 1 hour (or manually expire in DB)
        3. Try to use reset link
        4. Verify expired token message shown
      </test>

      <test name="invalid-token">
        1. Visit /reset-password?token=invalid
        2. Verify invalid token message shown
      </test>

      <test name="password-validation">
        1. Try weak password
        2. Verify requirements not met
        3. Try progressively stronger passwords
        4. Verify strength indicator updates
        5. Verify submission blocked until strong
      </test>
    </manual-testing>

    <edge-cases>
      - Email with uppercase letters (should normalize)
      - Multiple rapid submissions
      - Browser back button during reset
      - Closing window during submission
      - Network timeout
      - Token reuse attempt
    </edge-cases>
  </testing-considerations>

  <dependencies>
    <story id="01-1" status="complete">
      <name>Install and Configure better-auth</name>
      <provides>Auth configuration and API routes</provides>
    </story>

    <story id="01-2" status="complete">
      <name>Implement Email/Password Registration</name>
      <provides>Email service with sendPasswordResetEmail function</provides>
    </story>
  </dependencies>

  <blocking-issues>
    <issue>None - all dependencies complete</issue>
  </blocking-issues>
</story-context>
