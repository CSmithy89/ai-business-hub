<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story>
    <id>13-6-confidence-breakdown-system</id>
    <epic>EPIC-13</epic>
    <title>Confidence Breakdown System</title>
    <priority>P2</priority>
    <points>4</points>
  </story>

  <tech-spec>
    <file>/home/chris/projects/work/Ai Bussiness Hub/docs/archive/foundation-phase/sprint-artifacts/tech-spec-epic-13.md</file>
    <section>Story 13.6: Confidence Breakdown System (lines 860-1031)</section>
  </tech-spec>

  <requirements>
    <summary>
      Add confidence breakdown visualization to approval items showing:
      - 4 confidence factors with progress bars (Content Quality, Brand Alignment, Recipient Match, Timing Score)
      - Color-coded factor bars (green >80%, yellow 60-80%, red &lt;60%)
      - AI reasoning section for low-confidence items (&lt;60%)
      - Suggested actions based on low factors
      - Collapsible UI for high-confidence items (>85%)
    </summary>

    <acceptance-criteria>
      <criterion id="AC1">ConfidenceBreakdown component added to approval detail modal</criterion>
      <criterion id="AC2">Four factor bars displayed: Content Quality, Brand Alignment, Recipient Match, Timing Score</criterion>
      <criterion id="AC3">Each factor shows progress bar, percentage, weight, and explanation</criterion>
      <criterion id="AC4">Progress bars color-coded: green (>80%), yellow (60-80%), red (&lt;60%)</criterion>
      <criterion id="AC5">Overall weighted calculation displayed prominently</criterion>
      <criterion id="AC6">AI Reasoning section shown for low-confidence items (&lt;60%)</criterion>
      <criterion id="AC7">Suggested Actions section shown with recommended next steps</criterion>
      <criterion id="AC8">Backend API endpoint /api/approvals/:id/confidence returns factor data</criterion>
    </acceptance-criteria>
  </requirements>

  <architecture>
    <components>
      <component>
        <name>ConfidenceBreakdown</name>
        <path>apps/web/src/components/approval/ConfidenceBreakdown.tsx</path>
        <type>Client Component</type>
        <description>Main orchestration component that fetches and displays confidence data</description>
      </component>
      <component>
        <name>ConfidenceFactorBar</name>
        <path>apps/web/src/components/approval/ConfidenceFactorBar.tsx</path>
        <type>Client Component</type>
        <description>Individual factor progress bar with color coding and details</description>
      </component>
      <component>
        <name>AIReasoning</name>
        <path>apps/web/src/components/approval/AIReasoning.tsx</path>
        <type>Client Component</type>
        <description>Displays detailed reasoning for low-confidence items</description>
      </component>
      <component>
        <name>SuggestedActions</name>
        <path>apps/web/src/components/approval/SuggestedActions.tsx</path>
        <type>Client Component</type>
        <description>Action recommendations based on confidence factors</description>
      </component>
    </components>

    <api-endpoints>
      <endpoint>
        <method>GET</method>
        <path>/api/approvals/:id/confidence</path>
        <file>apps/web/src/app/api/approvals/[id]/confidence/route.ts</file>
        <description>Returns confidence factor breakdown and suggested actions</description>
        <response>
          {
            "factors": [
              {
                "factor": "Content Quality",
                "score": 85,
                "weight": 0.35,
                "explanation": "Content is well-structured and professional"
              }
            ],
            "suggestedActions": [
              {
                "id": "review-brand",
                "action": "Review Brand Guidelines",
                "reason": "Brand Alignment scored 72%",
                "priority": "high"
              }
            ],
            "overallScore": 78
          }
        </response>
      </endpoint>
    </api-endpoints>

    <hooks>
      <hook>
        <name>useConfidenceBreakdown</name>
        <path>apps/web/src/hooks/use-confidence-breakdown.ts</path>
        <description>React Query hook for fetching confidence data</description>
      </hook>
    </hooks>

    <types>
      <interface>
        <name>ConfidenceFactor</name>
        <location>packages/shared/src/types/agent.ts or new confidence.ts</location>
        <definition>
          {
            "factor": "string",
            "score": "number (0-100)",
            "weight": "number (0-1)",
            "explanation": "string"
          }
        </definition>
      </interface>
      <interface>
        <name>SuggestedAction</name>
        <definition>
          {
            "id": "string",
            "action": "string",
            "reason": "string",
            "priority": "high | medium | low"
          }
        </definition>
      </interface>
    </types>
  </architecture>

  <existing-code>
    <file path="apps/web/src/components/approval/approval-card.tsx">
      <purpose>Existing approval card component - shows structure for displaying approval items</purpose>
      <relevance>Contains ConfidenceIndicator, ConfidenceBadge, AIReasoningSection - patterns to follow</relevance>
    </file>
    <file path="packages/shared/src/types/agent.ts">
      <purpose>Agent types - may need to extend with confidence types</purpose>
      <relevance>Reference for type definitions and structure</relevance>
    </file>
  </existing-code>

  <dependencies>
    <package name="@tanstack/react-query" version="5.x" purpose="Data fetching hook" />
    <package name="shadcn/ui" components="Accordion, Progress, Badge, Card, Skeleton" />
    <package name="tailwindcss" purpose="Styling with dark mode support" />
    <package name="lucide-react" purpose="Icons for UI elements" />
  </dependencies>

  <implementation-notes>
    <note>Use mock data calculation based on existing approval.confidenceScore</note>
    <note>Generate 4 factors with realistic scores that average to overall score</note>
    <note>Vary factor weights: Content Quality (0.35), Brand Alignment (0.25), Recipient Match (0.25), Timing (0.15)</note>
    <note>Generate suggested actions for factors scoring below 70%</note>
    <note>Use Accordion from shadcn/ui for collapsible section</note>
    <note>Default accordion state: open for confidence &lt;85%, closed for â‰¥85%</note>
    <note>Implement loading skeleton states during data fetch</note>
    <note>Add error boundary for graceful error handling</note>
  </implementation-notes>

  <design-specs>
    <colors>
      <score-colors>
        <range min="81" max="100" bg="bg-green-500" text="text-green-700" dark="dark:bg-green-600 dark:text-green-100" />
        <range min="60" max="80" bg="bg-yellow-500" text="text-yellow-700" dark="dark:bg-yellow-600 dark:text-yellow-100" />
        <range min="0" max="59" bg="bg-red-500" text="text-red-700" dark="dark:bg-red-600 dark:text-red-100" />
      </score-colors>
      <priority-badges>
        <priority level="high" classes="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" />
        <priority level="medium" classes="bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" />
        <priority level="low" classes="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" />
      </priority-badges>
    </colors>
    <layout>
      <progress-bar height="12px" rounded="rounded-full" animated="true" />
      <responsive>
        <desktop>Two-column layout for factors</desktop>
        <mobile>Single column, stacked</mobile>
      </responsive>
    </layout>
  </design-specs>

  <coding-standards>
    <typescript>
      <rule>Use strict mode</rule>
      <rule>Define all interfaces in types file</rule>
      <rule>Use proper return types for all functions</rule>
    </typescript>
    <react>
      <rule>Use functional components with hooks</rule>
      <rule>Add 'use client' directive for client components</rule>
      <rule>Implement loading skeleton states</rule>
      <rule>Use Error Boundary wrapper</rule>
    </react>
    <imports>
      <order>
        <step>1. External packages (react, tanstack/react-query, etc.)</step>
        <step>2. Internal packages (@/components/ui, @/hooks, etc.)</step>
        <step>3. Relative imports (./ConfidenceFactorBar, etc.)</step>
      </order>
    </imports>
    <styling>
      <rule>Use Tailwind utility classes</rule>
      <rule>Follow dark mode patterns with dark: variants</rule>
      <rule>Use responsive breakpoints: sm:, md:, lg:</rule>
      <rule>Use cn() utility for conditional classes</rule>
    </styling>
  </coding-standards>

  <testing-requirements>
    <unit-tests>
      <test component="ConfidenceFactorBar">Renders with correct color for each score range</test>
      <test component="ConfidenceBreakdown">Fetches and displays confidence data</test>
      <test component="ConfidenceBreakdown">Shows loading skeleton during fetch</test>
      <test component="AIReasoning">Conditionally renders for low scores</test>
      <test component="SuggestedActions">Renders action cards with priority badges</test>
    </unit-tests>
    <integration-tests>
      <test>API route returns correct data structure</test>
      <test>API route validates session and workspace</test>
      <test>Component integration with approval modal</test>
    </integration-tests>
  </testing-requirements>

  <definition-of-done>
    <item>All 4 components created and working</item>
    <item>API endpoint returns mock confidence data</item>
    <item>React Query hook implemented</item>
    <item>Integration with approval card complete</item>
    <item>TypeScript type check passes (pnpm turbo type-check)</item>
    <item>ESLint passes (pnpm turbo lint)</item>
    <item>Dark mode tested</item>
    <item>Mobile responsive tested</item>
    <item>Loading states work</item>
    <item>Error states handled</item>
  </definition-of-done>

  <related-stories>
    <story id="13-1">Agent Card Components - provides patterns for status indicators</story>
    <story id="13-2">Agent Detail Modal - similar modal structure</story>
    <story id="04-6">AI Reasoning Display - approval system context</story>
  </related-stories>
</story-context>
