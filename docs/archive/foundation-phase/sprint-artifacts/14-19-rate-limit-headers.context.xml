<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>14</epicId>
    <storyId>19</storyId>
    <title>Rate Limit Header Implementation</title>
    <status>drafted</status>
    <generatedAt>2025-12-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/archive/foundation-phase/sprint-artifacts/14-19-rate-limit-headers.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>As an API consumer</asA>
    <iWant>I want every rate-limited endpoint to emit standard X-RateLimit-* headers</iWant>
    <soThat>so that I can adjust request volume before hitting hard limits</soThat>
    <tasks>- [ ] AC1: Export the shared generateRateLimitHeaders helper
- [ ] AC2: Attach headers for auth endpoints invoking checkRateLimit
- [ ] AC3: Attach headers for workspace/API endpoints using rate limiting
- [ ] AC4: Add automated tests verifying header emission
- [ ] AC5: Document the header behavior in story/docs</tasks>
  </story>

  <acceptanceCriteria>
1. Export the shared generateRateLimitHeaders() helper from lib/utils/rate-limit.ts.
2. Attach headers for auth endpoints that invoke checkRateLimit.
3. Attach headers for workspace/API endpoints that use rate limiting.
4. Add automated tests verifying header emission for representative routes.
5. Document the header behavior in the relevant story/docs.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <item>
        <path>docs/archive/foundation-phase/sprint-artifacts/epic-12-retrospective.md</path>
        <title>Epic 12 Retrospective</title>
        <section>Tech Debt Items Added to EPIC-14</section>
        <snippet>Added 14-19: Rate Limit Headers - ensure endpoints emit standard X-RateLimit-* headers.</snippet>
      </item>
      <item>
        <path>docs/archive/foundation-phase/sprint-artifacts/tech-spec-epic-14.md</path>
        <title>Epic 14 Technical Specification</title>
        <section>Testing Track & Tech Debt</section>
        <snippet>Epic 14 covers testing gaps; rate-limit headers ensure clients can manage request volume.</snippet>
      </item>
    </docs>
    <code>
      <item>
        <path>apps/web/src/lib/utils/rate-limit.ts</path>
        <kind>utility</kind>
        <symbol>generateRateLimitHeaders</symbol>
        <lines>n/a</lines>
        <reason>Target helper to export and reuse for header formatting.</reason>
      </item>
      <item>
        <path>apps/web/src/__tests__/rate-limit.test.ts</path>
        <kind>test</kind>
        <symbol>rate-limit tests</symbol>
        <lines>n/a</lines>
        <reason>Existing test suite to extend for header assertions.</reason>
      </item>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="next" version="15.x" />
        <package name="typescript" version="5.x" />
        <package name="vitest" version="4.x" />
        <package name="@upstash/ratelimit" version="*" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
- Maintain consistency with existing rate limit helper and avoid duplicating header logic.
- Ensure tests cover representative routes (auth + workspace/API) without introducing flaky behavior.
- Preserve existing rate limit semantics; this task adds headers, not new limits.
  </constraints>
  <interfaces></interfaces>
  <tests>
    <standards>Frontend/API tests use Vitest; extend existing rate-limit.test.ts with header assertions.</standards>
    <locations>apps/web/src/__tests__/rate-limit.test.ts</locations>
    <ideas>- Add assertions for X-RateLimit-Limit/Remaining/Reset on representative endpoints.
- Validate helper output format independently in a unit test for generateRateLimitHeaders.</ideas>
  </tests>
</story-context>
