<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>00-6</story-id>
    <story-title>Set Up Shared Types Package</story-title>
    <generated>2025-12-01</generated>
    <epic>EPIC-00 - Project Scaffolding &amp; Core Setup</epic>
    <story-points>2</story-points>
    <priority>P0 - Critical</priority>
  </metadata>

  <story-summary>
    This story creates the `packages/shared` package containing shared TypeScript types
    that will be used across the monorepo. The package provides type definitions for
    authentication (JWT payloads, session types), workspace management (roles, members),
    approval system (approval items), and event bus (event types). These foundational
    types ensure consistency between the Next.js frontend, NestJS backend, and future
    packages. The package follows the monorepo pattern established by packages/db, with
    proper TypeScript configuration and workspace integration.
  </story-summary>

  <acceptance-criteria>
    <criterion id="AC1">
      packages/shared package exists with proper package.json configuration
      - Package name: @hyvve/shared
      - Version: 0.1.0
      - Exports configured for TypeScript module resolution
      - Build script executes TypeScript compilation
    </criterion>

    <criterion id="AC2">
      Type definitions are created in separate files:
      - types/auth.ts - JWT payload, session types
      - types/workspace.ts - Workspace, member types
      - types/approval.ts - Approval item types
      - types/events.ts - Event bus types
    </criterion>

    <criterion id="AC3">
      All types are exported from the package entry point (src/index.ts)
      - Re-exports all types from types/* modules
      - Provides single import point for consuming apps
    </criterion>

    <criterion id="AC4">
      Package.json exports are properly configured for TypeScript and module resolution
      - Main field points to src/index.ts
      - Types field points to src/index.ts
      - Scripts include build and type-check
    </criterion>

    <criterion id="AC5">
      Types are importable in both apps/web and apps/api without errors
      - Import statement works: import { JwtPayload } from '@hyvve/shared'
      - TypeScript autocomplete functions in both apps
      - No module resolution errors
    </criterion>

    <criterion id="AC6">
      Package builds without TypeScript errors
      - pnpm build executes successfully
      - pnpm type-check passes with zero errors
    </criterion>

    <criterion id="AC7">
      JwtPayload, WorkspaceRole, and BaseEvent types are defined and match the tech spec
      - JwtPayload includes: sub, sessionId, workspaceId, email, name, iat, exp
      - WorkspaceRole is union type: 'owner' | 'admin' | 'member' | 'viewer' | 'guest'
      - BaseEvent includes: id, type, source, timestamp, correlationId, tenantId, userId, version, data
    </criterion>
  </acceptance-criteria>

  <technical-requirements>
    <requirement category="package-structure">
      Create the following directory structure:
      packages/shared/
      ├── src/
      │   ├── types/
      │   │   ├── auth.ts
      │   │   ├── workspace.ts
      │   │   ├── approval.ts
      │   │   └── events.ts
      │   └── index.ts
      ├── package.json
      └── tsconfig.json
    </requirement>

    <requirement category="type-definitions">
      Define types according to tech spec:

      auth.ts:
      - interface JwtPayload with fields: sub, sessionId, workspaceId?, email, name, iat, exp
      - Additional auth-related types as needed for session management

      workspace.ts:
      - type WorkspaceRole = 'owner' | 'admin' | 'member' | 'viewer' | 'guest'
      - Additional workspace and member types based on data model

      approval.ts:
      - Approval item types for the approval queue system
      - Status enums, approval actions, routing types

      events.ts:
      - interface BaseEvent with standard event fields
      - Event type patterns and structures for event bus
    </requirement>

    <requirement category="typescript-config">
      Configure tsconfig.json:
      - Extend root tsconfig.json
      - Output directory: ./dist
      - Root directory: ./src
      - Enable declaration and declarationMap
      - Include: src/**/*
      - Exclude: node_modules, dist
    </requirement>

    <requirement category="package-exports">
      Configure package.json exports:
      - Main: ./src/index.ts (for development)
      - Types: ./src/index.ts
      - Scripts: build (tsc), type-check (tsc --noEmit)
      - Dependencies: TypeScript as devDependency
    </requirement>
  </technical-requirements>

  <architecture-context>
    <integration-points>
      The shared types package is a foundational package in the monorepo architecture:

      1. Frontend Integration (apps/web):
         - Import types for client-side validation
         - Type components and hooks
         - Ensure consistency with API contracts

      2. Backend Integration (apps/api):
         - Import types for API endpoint contracts
         - Type NestJS controllers and services
         - Ensure consistency with database models

      3. Future Integration:
         - packages/ui will import types for component props
         - Agent system will import types for event handling
         - Additional apps will consume shared types
    </integration-points>

    <architecture-patterns>
      Multi-tenant architecture considerations:
      - WorkspaceRole defines RBAC roles across the platform
      - JwtPayload includes workspaceId for tenant context
      - BaseEvent includes tenantId for event isolation

      Event-driven architecture:
      - BaseEvent provides standard structure for Redis Streams
      - Event types follow pattern: module.entity.action
      - Events include correlationId for request tracing

      Authentication architecture:
      - JwtPayload structure matches better-auth token format
      - Session types align with better-auth session management
      - Types enable JWT passthrough to AgentOS
    </architecture-patterns>

    <monorepo-position>
      The shared package is consumed by:
      - apps/web (Next.js frontend)
      - apps/api (NestJS backend)
      - packages/ui (shared components - future)
      - agents/ (AgentOS runtime - future)

      The shared package has no dependencies on other workspace packages.
      It depends only on TypeScript as a dev dependency.
    </monorepo-position>
  </architecture-context>

  <existing-code-context>
    <current-package-structure>
      packages/shared currently contains:
      - package.json (placeholder configuration from Story 00.1)
      - .gitkeep (ensures directory exists in git)
      - No src/ directory yet
      - No TypeScript files yet

      This story will create the full package structure.
    </current-package-structure>

    <reference-package-structure>
      packages/db provides a reference pattern:

      packages/db/
      ├── src/
      │   ├── index.ts (exports client and types)
      │   └── tenant-extension.ts (extension logic)
      ├── prisma/ (schema and migrations)
      ├── package.json
      │   - name: @hyvve/db
      │   - main: ./src/index.ts
      │   - types: ./src/index.ts
      │   - scripts: db:generate, build, type-check
      └── tsconfig.json
          - extends: ../../tsconfig.json
          - outDir: ./dist
          - rootDir: ./src

      Follow this pattern for packages/shared with appropriate modifications.
    </reference-package-structure>

    <workspace-configuration>
      pnpm-workspace.yaml includes:
      packages:
        - 'apps/*'
        - 'packages/*'

      This configuration already includes packages/shared.
      No changes to workspace.yaml needed.
    </workspace-configuration>

    <consuming-apps>
      apps/web/package.json and apps/api/package.json need to add:
      dependencies: {
        "@hyvve/shared": "workspace:*"
      }

      This enables importing types:
      import { JwtPayload, WorkspaceRole } from '@hyvve/shared'
    </consuming-apps>
  </existing-code-context>

  <dependencies>
    <npm-packages>
      Required in packages/shared/package.json:

      devDependencies:
        - typescript: ^5.0.0 (for type checking and compilation)
        - @types/node: ^22.0.0 (for Node.js type definitions)

      NO runtime dependencies needed (pure TypeScript types).
      NO Zod schemas in this package (validation happens in consuming apps).
    </npm-packages>

    <story-dependencies>
      Depends on completed stories:
      - Story 00-1: Initialize monorepo with Turborepo (DONE)
        Provides workspace structure and pnpm configuration

      - Story 00-2: Configure Next.js 15 frontend (DONE)
        Creates apps/web that will consume these types

      - Story 00-3: Configure NestJS backend (DONE)
        Creates apps/api that will consume these types
    </story-dependencies>
  </dependencies>

  <implementation-guide>
    <step number="1">
      Create the directory structure:
      - mkdir -p packages/shared/src/types
      - Establish the foundational structure for type definitions
    </step>

    <step number="2">
      Update packages/shared/package.json:
      - Set proper name, version, description
      - Configure main and types fields
      - Add build and type-check scripts
      - Add TypeScript and @types/node as devDependencies
      - Follow pattern from packages/db/package.json
    </step>

    <step number="3">
      Create packages/shared/tsconfig.json:
      - Extend root tsconfig: "extends": "../../tsconfig.json"
      - Set outDir to ./dist
      - Set rootDir to ./src
      - Enable declaration and declarationMap
      - Include src/**/*
      - Exclude node_modules and dist
    </step>

    <step number="4">
      Implement types/auth.ts:
      ```typescript
      /**
       * JWT payload structure for better-auth tokens
       * Used across frontend, backend, and AgentOS
       */
      export interface JwtPayload {
        sub: string;           // User ID
        sessionId: string;     // Session identifier
        workspaceId?: string;  // Current workspace context (optional)
        email: string;         // User email
        name: string;          // User display name
        iat: number;          // Issued at (Unix timestamp)
        exp: number;          // Expires at (Unix timestamp)
      }
      ```

      Add additional auth-related types as needed for session management.
    </step>

    <step number="5">
      Implement types/workspace.ts:
      ```typescript
      /**
       * Workspace role definitions for RBAC
       * Aligned with better-auth organization plugin
       */
      export type WorkspaceRole = 'owner' | 'admin' | 'member' | 'viewer' | 'guest';
      ```

      Add workspace member and invitation types based on Prisma schema.
    </step>

    <step number="6">
      Implement types/approval.ts:
      - Define approval item structure
      - Define approval status enum
      - Define approval action types
      - Define confidence score types
      - Reference EPIC-04 requirements for approval system
    </step>

    <step number="7">
      Implement types/events.ts:
      ```typescript
      /**
       * Base event structure for Redis Streams event bus
       * All events should extend this interface
       */
      export interface BaseEvent {
        id: string;                    // Unique event ID
        type: string;                  // Event type (module.entity.action)
        source: string;                // Service that emitted event
        timestamp: string;             // ISO 8601 timestamp
        correlationId?: string;        // Request correlation ID
        tenantId: string;              // Workspace ID for multi-tenancy
        userId: string;                // User who triggered event
        version: string;               // Event schema version
        data: Record&lt;string, any&gt;;  // Event payload
      }
      ```

      Add event type definitions for core platform events.
    </step>

    <step number="8">
      Create src/index.ts as the package entry point:
      ```typescript
      // Auth types
      export * from './types/auth'

      // Workspace types
      export * from './types/workspace'

      // Approval types
      export * from './types/approval'

      // Event types
      export * from './types/events'
      ```

      This provides a single import point for all types.
    </step>

    <step number="9">
      Add @hyvve/shared to apps/web/package.json:
      ```json
      {
        "dependencies": {
          "@hyvve/shared": "workspace:*"
        }
      }
      ```

      Run pnpm install in apps/web to link the package.
    </step>

    <step number="10">
      Add @hyvve/shared to apps/api/package.json:
      ```json
      {
        "dependencies": {
          "@hyvve/shared": "workspace:*"
        }
      }
      ```

      Run pnpm install in apps/api to link the package.
    </step>

    <step number="11">
      Test type imports in apps/web:
      - Create a test file importing types
      - Verify TypeScript autocomplete works
      - Verify no module resolution errors
      - Run pnpm type-check to confirm
    </step>

    <step number="12">
      Test type imports in apps/api:
      - Create a test file importing types
      - Verify TypeScript autocomplete works
      - Verify no module resolution errors
      - Run pnpm type-check to confirm
    </step>

    <step number="13">
      Verify package builds successfully:
      - Run pnpm build in packages/shared
      - Verify TypeScript compilation succeeds
      - Check that no errors are reported
    </step>

    <step number="14">
      Update root tsconfig project references if needed:
      - Check if root tsconfig.json has project references
      - Add packages/shared if using project references
      - Otherwise, no changes needed (workspace handles it)
    </step>
  </implementation-guide>

  <file-changes-expected>
    <new-files>
      1. packages/shared/src/types/auth.ts
         - JwtPayload interface
         - Auth-related type definitions

      2. packages/shared/src/types/workspace.ts
         - WorkspaceRole type
         - Workspace-related type definitions

      3. packages/shared/src/types/approval.ts
         - Approval system type definitions

      4. packages/shared/src/types/events.ts
         - BaseEvent interface
         - Event-related type definitions

      5. packages/shared/src/index.ts
         - Package entry point
         - Re-exports all types

      6. packages/shared/tsconfig.json
         - TypeScript configuration
         - Extends root config
    </new-files>

    <modified-files>
      1. packages/shared/package.json
         - Update from placeholder to full configuration
         - Add proper scripts and dependencies

      2. apps/web/package.json
         - Add @hyvve/shared dependency

      3. apps/api/package.json
         - Add @hyvve/shared dependency
    </modified-files>

    <deleted-files>
      1. packages/shared/.gitkeep
         - Remove once src/ directory is populated
    </deleted-files>
  </file-changes-expected>

  <testing-requirements>
    <compile-verification>
      1. Run pnpm build in packages/shared:
         - Verify TypeScript compilation succeeds
         - Check that dist/ directory is created
         - Verify .d.ts declaration files are generated

      2. Run pnpm type-check in packages/shared:
         - Verify zero TypeScript errors
         - Check that all types are valid
    </compile-verification>

    <import-verification>
      1. Test imports in apps/web:
         ```typescript
         import { JwtPayload, WorkspaceRole, BaseEvent } from '@hyvve/shared'

         // Should have full TypeScript support and autocomplete
         const payload: JwtPayload = {
           sub: 'user-123',
           sessionId: 'session-456',
           workspaceId: 'workspace-789',
           email: 'user@example.com',
           name: 'Test User',
           iat: Date.now(),
           exp: Date.now() + 86400000
         }
         ```

      2. Test imports in apps/api:
         ```typescript
         import { JwtPayload, WorkspaceRole, BaseEvent } from '@hyvve/shared'

         // Should work in NestJS decorators and services
         async validateJwt(payload: JwtPayload) {
           // TypeScript should recognize all fields
         }
         ```

      3. Verify no module resolution errors:
         - Run pnpm type-check in apps/web (should pass)
         - Run pnpm type-check in apps/api (should pass)
         - Run pnpm type-check in packages/shared (should pass)
    </import-verification>

    <integration-verification>
      1. Verify monorepo build:
         - Run pnpm build from root
         - Verify all packages build successfully
         - Verify Turborepo pipeline executes correctly

      2. Verify workspace linking:
         - Check that @hyvve/shared appears in node_modules of apps
         - Verify it's symlinked (workspace:*) not installed
         - Check pnpm list @hyvve/shared shows correct version
    </integration-verification>

    <type-safety-verification>
      1. Test type enforcement:
         - Try to assign invalid values to typed variables
         - Verify TypeScript errors appear
         - Confirm autocomplete suggests correct fields

      2. Test type exports:
         - Verify all exported types are accessible
         - Check that IDE autocomplete works
         - Confirm type hover shows correct documentation
    </type-safety-verification>
  </testing-requirements>

  <reference-documentation>
    <tech-spec>
      File: docs/archive/foundation-phase/sprint-artifacts/tech-spec-epic-00.md
      Section: "APIs and Interfaces - Shared Type Interfaces"

      Defines exact structure for:
      - JwtPayload interface
      - WorkspaceRole type
      - BaseEvent interface
    </tech-spec>

    <architecture-doc>
      File: docs/architecture.md
      Section: "Project Structure - packages/shared"

      Describes:
      - Package purpose and structure
      - Type organization pattern
      - Integration with other packages
    </architecture-doc>

    <story-file>
      File: docs/archive/foundation-phase/sprint-artifacts/story-00-6-set-up-shared-types-package.md

      Contains:
      - Complete acceptance criteria
      - Task breakdown
      - Type definition examples
      - Technical notes
    </story-file>

    <reference-package>
      File: packages/db/package.json and packages/db/tsconfig.json

      Provides pattern for:
      - Package configuration
      - TypeScript setup
      - Build scripts
      - Workspace integration
    </reference-package>
  </reference-documentation>

  <notes>
    <important>
      - This package contains ONLY TypeScript types, no runtime code
      - NO Zod schemas in this package (validation happens in consuming apps)
      - Keep types simple and focused on structure definition
      - Additional types will be added in future epics as modules are implemented
      - Follow TypeScript naming conventions (PascalCase for interfaces/types)
      - Use JSDoc comments to document types for better IDE support
    </important>

    <future-considerations>
      - EPIC-01 will add more auth-related types
      - EPIC-02 will add workspace member invitation types
      - EPIC-04 will add approval queue types
      - EPIC-05 will add event bus type refinements
      - EPIC-06 will add AI provider types

      The current implementation should be extensible for future additions.
    </future-considerations>

    <common-pitfalls>
      1. Don't add runtime dependencies to this package
      2. Don't include validation logic (that's for consuming apps)
      3. Don't export utilities or functions (only types)
      4. Make sure tsconfig extends root config correctly
      5. Verify workspace:* dependency format in consuming apps
      6. Ensure all types are exported from src/index.ts
    </common-pitfalls>
  </notes>
</story-context>
