<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>kb-04</epicId>
    <storyId>kb-04-1</storyId>
    <title>AI Page Drafts</title>
    <status>drafted</status>
    <generatedAt>2025-12-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/modules/bm-pm/stories/kb-04-1-ai-page-drafts.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>KB user</asA>
    <iWant>AI to draft pages from context</iWant>
    <soThat>documentation is faster to create</soThat>
    <tasks>
- Implement API draft request flow (DTOs + AgentOS invocation)
- Extend Scribe draft generation with citations
- Add AI Draft entry point in KB editor/Scribe panel
- Add API, UI, and agent tests
    </tasks>
  </story>

  <acceptanceCriteria>
1. Given I click "AI Draft" and describe what I need, Scribe generates a page draft.
2. The draft appears in the editor for review and edit before publishing.
3. Drafts include source citations when based on existing KB content.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/modules/bm-pm/epics/epic-kb-04-ai-native-knowledge-base.md</path>
        <title>Epic KB-04: AI-Native Knowledge Base</title>
        <section>Story KB-04.1: AI Page Drafts</section>
        <snippet>Defines AI draft generation with citations and editor insertion after user prompt.</snippet>
      </doc>
      <doc>
        <path>docs/modules/bm-pm/PRD.md</path>
        <title>Core-PM PRD</title>
        <section>Phase 3 - Vision Features / AI-Native KB Features</section>
        <snippet>Specifies AI drafts, Q&amp;A, summaries, and gap detection for the KB.</snippet>
      </doc>
      <doc>
        <path>docs/modules/bm-pm/kb-specification.md</path>
        <title>KB Specification</title>
        <section>F8: AI-Native KB</section>
        <snippet>Lists AI page drafts, smart summarization, Q&amp;A chat, knowledge extraction, and gap detection.</snippet>
      </doc>
      <doc>
        <path>docs/modules/bm-pm/architecture.md</path>
        <title>Core-PM + Knowledge Base Architecture</title>
        <section>Knowledge Base &amp; RAG Architecture</section>
        <snippet>RAG pipeline uses pgvector; KB endpoints include RAG query and semantic search.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-kb-04.md</path>
        <title>Epic KB-04 Technical Specification</title>
        <section>AI Draft Generation Workflow</section>
        <snippet>Drafts generated by Scribe with citations and inserted into editor for review.</snippet>
      </doc>
      <doc>
        <path>agents/platform/scribe/prompts/scribe_system.md</path>
        <title>Scribe System Prompt</title>
        <section>Important Constraints</section>
        <snippet>All content changes require human approval; suggestions only.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/api/src/kb/rag/rag.service.ts</path>
        <kind>service</kind>
        <symbol>RagService.query</symbol>
        <lines>1-120</lines>
        <reason>Provides RAG query results and citations for AI drafts.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/kb/search/search.controller.ts</path>
        <kind>controller</kind>
        <symbol>SearchController.semanticSearch</symbol>
        <lines>1-120</lines>
        <reason>Semantic search endpoint used for retrieval context.</reason>
      </artifact>
      <artifact>
        <path>agents/platform/scribe/tools/rag_tools.py</path>
        <kind>tool</kind>
        <symbol>query_rag</symbol>
        <lines>1-120</lines>
        <reason>Scribe tool for semantic search and citations.</reason>
      </artifact>
      <artifact>
        <path>agents/platform/scribe/tools/kb_tools.py</path>
        <kind>tool</kind>
        <symbol>create_kb_page</symbol>
        <lines>1-120</lines>
        <reason>Drafts can be prepared for page creation with human approval.</reason>
      </artifact>
      <artifact>
        <path>apps/api/src/agentos/agentos.service.ts</path>
        <kind>service</kind>
        <symbol>AgentOSService.invokeAgent</symbol>
        <lines>200-300</lines>
        <reason>AgentOS bridge for invoking Scribe with workspace context.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/kb/editor/PageEditor.tsx</path>
        <kind>component</kind>
        <symbol>PageEditor</symbol>
        <lines>1-200</lines>
        <reason>Editor integration for inserting AI drafts.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/kb/editor/EditorToolbar.tsx</path>
        <kind>component</kind>
        <symbol>EditorToolbar</symbol>
        <lines>1-140</lines>
        <reason>Potential location for AI Draft action entry point.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="@tiptap/react" />
        <package name="yjs" />
        <package name="@hocuspocus/provider" />
        <package name="@nestjs/common" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
- Enforce workspace isolation (`workspaceId`), treat `tenantId` as alias when needed.
- Follow NestJS patterns: DTOs with class-validator, guards (Auth + Tenant + Roles).
- Scribe must operate in suggestion mode with explicit human approval.
- Use existing RAG pipeline for citations; avoid duplicating retrieval logic.
  </constraints>

  <interfaces>
- POST /api/kb/rag/query (RAG query with citations)
- POST /api/kb/search/semantic (semantic search)
- POST /api/kb/pages (create page)
- PATCH /api/kb/pages/:id (update page)
  </interfaces>

  <tests>
    <standards>Use Vitest for web UI components and NestJS test patterns for API modules. Mock external AI provider calls and keep tests deterministic.</standards>
    <locations>apps/web/src/**/__tests__ | apps/web/src/**/*.test.tsx | apps/api/src/**/*.spec.ts</locations>
    <ideas>
- Verify AI Draft flow returns draft content + citations (API).
- Ensure editor inserts draft without auto-publish (UI).
- Validate citations render and link to KB pages (UI).
- Ensure workspace scoping enforced for draft generation (API).
    </ideas>
  </tests>
</story-context>
