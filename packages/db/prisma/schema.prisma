// HYVVE Platform Foundation - Prisma Schema
// Generated: 2025-11-30
// Version: 1.0

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION ENTITIES
// ============================================

model User {
  id            String  @id @default(uuid())
  email         String  @unique
  emailVerified Boolean @default(false) @map("email_verified")
  name          String?
  image         String?
  password      String?

  // Two-Factor Authentication (Story 09-3)
  twoFactorEnabled Boolean @default(false) @map("two_factor_enabled")
  twoFactorSecret  String? @map("two_factor_secret") // Encrypted TOTP secret

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sessions                 Session[]
  accounts                 Account[]
  workspaces               WorkspaceMember[]
  invitationsSent          WorkspaceMember[]     @relation("InvitedBy")
  workspaceInvitationsSent WorkspaceInvitation[] @relation("SentInvitations")
  assignedApprovals        ApprovalItem[]        @relation("AssignedApprovals")
  resolvedApprovals        ApprovalItem[]        @relation("ResolvedApprovals")
  createdApiKeys           ApiKey[]              @relation("CreatedBy")
  backupCodes              BackupCode[]
  trustedDevices           TrustedDevice[]
  preferences              UserPreference?

  @@map("users")
}

model Session {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  token             String   @unique
  expiresAt         DateTime @map("expires_at")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  activeWorkspaceId String?  @map("active_workspace_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model Account {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  providerId            String    @default("credential") @map("provider_id")
  accountId             String    @map("account_id")
  password              String?   @map("password")
  accessToken           String?   @map("access_token") @db.Text
  refreshToken          String?   @map("refresh_token") @db.Text
  idToken               String?   @map("id_token") @db.Text
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?   @map("scope") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([identifier])
  @@index([identifier, expiresAt]) // Optimize queries filtering by identifier and expiry
  @@map("verification")
}

// ============================================
// WORKSPACE / MULTI-TENANT ENTITIES
// ============================================

model Workspace {
  id       String  @id @default(uuid())
  name     String
  slug     String  @unique
  image    String?
  timezone String  @default("UTC")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  members     WorkspaceMember[]
  invitations WorkspaceInvitation[]
  aiProviders AIProviderConfig[]
  approvals   ApprovalItem[]
  apiKeys     ApiKey[]
  auditLogs   AuditLog[]
  events      EventLog[]
  tokenUsage  TokenUsage[]
  settings    WorkspaceSettings?
  customRoles CustomRole[]
  businesses  Business[]
  modules     WorkspaceModule[]
  mcpServers  MCPServerConfig[]
  importJobs  ImportJob[]
  integrationConnections IntegrationConnection[]
  externalLinks ExternalLink[]

  @@index([slug])
  @@index([deletedAt])
  @@map("workspaces")
}

model WorkspaceMember {
  id                String @id @default(uuid())
  userId            String @map("user_id")
  workspaceId       String @map("workspace_id")
  role              String @default("member")
  modulePermissions Json?  @map("module_permissions")

  invitedById String?   @map("invited_by_id")
  invitedAt   DateTime  @default(now()) @map("invited_at")
  acceptedAt  DateTime? @map("accepted_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy User?     @relation("InvitedBy", fields: [invitedById], references: [id])

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

model WorkspaceInvitation {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  email       String
  role        String   @default("member")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  invitedById String   @map("invited_by_id")
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy User      @relation("SentInvitations", fields: [invitedById], references: [id])

  @@unique([workspaceId, email])
  @@index([token])
  @@index([email])
  @@map("workspace_invitations")
}

// ============================================
// BYOAI CONFIGURATION
// ============================================

model AIProviderConfig {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  provider        String
  apiKeyEncrypted String @map("api_key_encrypted") @db.Text
  defaultModel    String @map("default_model")

  isValid         Boolean   @default(false) @map("is_valid")
  lastValidatedAt DateTime? @map("last_validated_at")
  validationError String?   @map("validation_error")

  maxTokensPerDay Int @default(100000) @map("max_tokens_per_day")
  tokensUsedToday Int @default(0) @map("tokens_used_today")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace  Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tokenUsage TokenUsage[]

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([isValid]) // Optimize daily token reset query
  @@map("ai_provider_configs")
}

model TokenUsage {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")
  providerId  String @map("provider_id")

  agentId   String? @map("agent_id")
  sessionId String? @map("session_id")
  model     String

  promptTokens     Int @map("prompt_tokens")
  completionTokens Int @map("completion_tokens")
  totalTokens      Int @map("total_tokens")

  estimatedCost Float @map("estimated_cost")

  requestedAt DateTime @map("requested_at")
  duration    Int

  createdAt DateTime @default(now()) @map("created_at")

  workspace Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  provider  AIProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([providerId])
  @@index([requestedAt])
  @@index([providerId, requestedAt]) // Composite index for provider usage queries
  @@index([workspaceId, requestedAt]) // Composite index for workspace usage queries
  @@map("token_usage")
}

// ============================================
// APPROVAL QUEUE
// ============================================

model ApprovalItem {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  type        String
  title       String
  description String? @db.Text

  confidenceScore   Int     @map("confidence_score")
  confidenceFactors Json?   @map("confidence_factors")
  aiRecommendation  String  @map("ai_recommendation")
  aiReasoning       String? @map("ai_reasoning") @db.Text

  previewUrl      String? @map("preview_url")
  previewData     Json?   @map("preview_data")
  relatedEntities Json?   @map("related_entities")

  sourceModule String? @map("source_module")
  sourceId     String? @map("source_id")

  status   String @default("pending")
  priority String @default("medium")

  requestedBy   String  @map("requested_by")
  assignedToId  String? @map("assigned_to_id")
  escalatedToId String? @map("escalated_to_id")

  dueAt        DateTime  @map("due_at")
  escalatedAt  DateTime? @map("escalated_at")
  resolvedAt   DateTime? @map("resolved_at")
  resolvedById String?   @map("resolved_by_id")

  resolution Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedTo User?     @relation("AssignedApprovals", fields: [assignedToId], references: [id])
  resolvedBy User?     @relation("ResolvedApprovals", fields: [resolvedById], references: [id])

  @@index([workspaceId, status])
  @@index([assignedToId, status])
  @@index([dueAt])
  @@index([status, priority])
  @@map("approval_items")
}

// ============================================
// API KEYS
// ============================================

model ApiKey {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  name        String
  keyHash     String @unique @map("key_hash")
  keyPrefix   String @map("key_prefix")
  permissions Json

  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")

  createdById String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([workspaceId])
  @@index([keyHash])
  @@index([keyPrefix])
  @@map("api_keys")
}

// ============================================
// EVENT BUS / AUDIT
// ============================================

model EventLog {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  eventType     String  @map("event_type")
  source        String
  correlationId String? @map("correlation_id")
  userId        String? @map("user_id")
  version       String  @default("1.0")

  data     Json
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([eventType])
  @@index([correlationId])
  @@index([createdAt])
  @@map("event_logs")
}

model AuditLog {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  action    String
  entity    String
  entityId  String? @map("entity_id")
  userId    String? @map("user_id")
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")
  metadata  Json?

  createdAt DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Platform notification preferences
  emailApprovals        Boolean @default(true) @map("email_approvals")
  emailWorkspaceInvites Boolean @default(true) @map("email_workspace_invites")
  emailAgentErrors      Boolean @default(true) @map("email_agent_errors")
  emailDigest           String  @default("daily") @map("email_digest")

  inAppApprovals        Boolean @default(true) @map("in_app_approvals")
  inAppWorkspaceInvites Boolean @default(true) @map("in_app_workspace_invites")
  inAppAgentUpdates     Boolean @default(true) @map("in_app_agent_updates")

  // PM-specific email preferences
  emailTaskAssigned    Boolean @default(true) @map("email_task_assigned")
  emailTaskMentioned   Boolean @default(true) @map("email_task_mentioned")
  emailDueDateReminder Boolean @default(true) @map("email_due_date_reminder")
  emailAgentCompletion Boolean @default(true) @map("email_agent_completion")
  emailHealthAlert     Boolean @default(true) @map("email_health_alert")

  // PM-specific in-app preferences
  inAppTaskAssigned    Boolean @default(true) @map("in_app_task_assigned")
  inAppTaskMentioned   Boolean @default(true) @map("in_app_task_mentioned")
  inAppDueDateReminder Boolean @default(true) @map("in_app_due_date_reminder")
  inAppAgentCompletion Boolean @default(true) @map("in_app_agent_completion")
  inAppHealthAlert     Boolean @default(true) @map("in_app_health_alert")

  // Quiet hours configuration
  quietHoursStart    String? @map("quiet_hours_start") // HH:MM format
  quietHoursEnd      String? @map("quiet_hours_end") // HH:MM format
  quietHoursTimezone String  @default("UTC") @map("quiet_hours_timezone")

  // Digest settings
  digestEnabled    Boolean   @default(false) @map("digest_enabled")
  digestFrequency  String    @default("daily") @map("digest_frequency") // daily, weekly
  lastDigestSentAt DateTime? @map("last_digest_sent_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

model Notification {
  id          String @id @default(uuid())
  userId      String @map("user_id")
  workspaceId String @map("workspace_id")

  type    String
  title   String
  message String?
  link    String?
  data    Json?

  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, readAt, createdAt]) // Composite index for digest queries
  @@index([workspaceId])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// WORKSPACE SETTINGS
// ============================================

model WorkspaceSettings {
  id          String @id @default(uuid())
  workspaceId String @unique @map("workspace_id")

  approvalTimeoutHours Int @default(48) @map("approval_timeout_hours")
  autoApproveThreshold Int @default(85) @map("auto_approve_threshold")
  quickReviewThreshold Int @default(60) @map("quick_review_threshold")

  defaultInviteRole String @default("member") @map("default_invite_role")

  enableBulkApprovals Boolean @default(true) @map("enable_bulk_approvals")
  enableAgentChat     Boolean @default(true) @map("enable_agent_chat")
  enableTokenTracking Boolean @default(true) @map("enable_token_tracking")

  // Escalation Settings (Story 04-8)
  enableEscalation               Boolean @default(true) @map("enable_escalation")
  escalationCheckIntervalMinutes Int     @default(15) @map("escalation_check_interval_minutes")
  escalationTargetUserId         String? @map("escalation_target_user_id")
  enableEscalationNotifications  Boolean @default(true) @map("enable_escalation_notifications")

  brandPrimaryColor String? @map("brand_primary_color")
  brandLogoUrl      String? @map("brand_logo_url")

  // Agent Model Preferences (Story 06-11)
  // JSON object: { [agentId: string]: { providerId: string, model: string } }
  agentModelPreferences Json? @map("agent_model_preferences")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_settings")
}

// ============================================
// MODULE CONFIGURATION
// ============================================

/// Tracks which modules are enabled for each workspace
model WorkspaceModule {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  /// Module identifier (e.g., 'bm-crm', 'bm-inventory', 'bm-marketing')
  moduleId String @map("module_id")

  /// Whether the module is enabled
  enabled Boolean @default(false)

  /// Module-specific configuration as JSON
  config Json @default("{}")

  /// When the module was last enabled/disabled
  enabledAt  DateTime? @map("enabled_at")
  disabledAt DateTime? @map("disabled_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, moduleId])
  @@index([workspaceId])
  @@index([moduleId])
  @@map("workspace_modules")
}

// ============================================
// MCP SERVER CONFIGURATION
// ============================================

/// MCP (Model Context Protocol) server configurations per workspace
model MCPServerConfig {
  id          String @id @default(uuid())
  workspaceId String @map("workspace_id")

  /// Unique server identifier within workspace
  serverId String @map("server_id")

  /// Display name for the server
  name String

  /// Transport type: 'stdio', 'sse', 'streamable-http'
  transport String

  /// Connection details (command for stdio, URL for SSE/HTTP)
  command String? @db.Text
  url     String? @db.Text

  /// Encrypted API key for authenticated servers
  apiKeyEncrypted String? @map("api_key_encrypted") @db.Text

  /// Additional headers as JSON
  headers Json @default("{}")

  /// Environment variables for the server (encrypted sensitive values)
  envVars Json @default("{}") @map("env_vars")

  /// Tool filtering
  includeTools String[] @default([]) @map("include_tools")
  excludeTools String[] @default([]) @map("exclude_tools")

  /// Permission level: READ, WRITE, EXECUTE (bit flags stored as int)
  permissions Int @default(1) // 1 = READ

  /// Connection settings
  timeoutSeconds Int @default(30) @map("timeout_seconds")
  enabled        Boolean @default(true)

  /// Health status
  lastHealthCheck DateTime? @map("last_health_check")
  healthStatus    String?   @map("health_status") // 'healthy', 'unhealthy', 'unknown'

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, serverId])
  @@index([workspaceId])
  @@map("mcp_server_configs")
}

// ============================================
// TWO-FACTOR AUTHENTICATION (Story 09-3)
// ============================================

model BackupCode {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  code      String // Hashed backup code
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, used])
  @@map("backup_codes")
}

// ============================================
// EVENT BUS METADATA (EPIC-05)
// ============================================

model EventMetadata {
  id            String      @id @default(cuid())
  eventId       String      @unique @map("event_id")
  streamId      String      @map("stream_id") // Redis stream message ID
  type          String
  source        String
  tenantId      String      @map("tenant_id")
  correlationId String?     @map("correlation_id")
  status        EventStatus @default(PENDING)
  attempts      Int         @default(0)
  lastError     String?     @map("last_error")
  processedAt   DateTime?   @map("processed_at")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([tenantId, createdAt])
  @@index([type, status])
  @@index([correlationId])
  @@index([status, createdAt]) // For replay queries by status and time
  @@index([tenantId, status, createdAt]) // For tenant-specific replay queries
  @@map("event_metadata")
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  DLQ
}

/// Tracks event replay jobs for re-processing historical events
/// Story: 05-6 - Implement Event Replay
model ReplayJob {
  id             String          @id @default(cuid())
  status         ReplayJobStatus @default(PENDING)
  progress       Int             @default(0) // 0-100 percentage
  eventsReplayed Int             @default(0) @map("events_replayed")
  totalEvents    Int             @default(0) @map("total_events")
  errors         Int             @default(0)
  startedAt      DateTime?       @map("started_at")
  completedAt    DateTime?       @map("completed_at")
  errorMessage   String?         @map("error_message")
  options        Json            @default("{}") // Replay options (time range, filters)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("replay_job")
}

enum ReplayJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================
// TRUSTED DEVICES (Story 09 - 2FA Enhancement)
// ============================================

/// Trusted devices for 2FA bypass
/// Users can mark devices as "trusted" during 2FA login to skip 2FA for that device
/// Devices are identified by a secure token stored in an HTTP-only cookie
model TrustedDevice {
  id     String @id @default(cuid())
  userId String @map("user_id")

  tokenHash   String @unique @map("token_hash") // SHA-256 hash of the device token
  name        String // User-friendly device name (e.g., "Chrome on Windows")
  fingerprint String // SHA-256 hash of User-Agent + IP for verification
  ipAddress   String @map("ip_address")
  userAgent   String @map("user_agent") @db.Text

  lastUsedAt DateTime  @map("last_used_at")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, tokenHash])
  @@index([expiresAt])
  @@map("trusted_devices")
}

// ============================================
// CUSTOM ROLES (Story 09-14)
// ============================================

/// Custom roles for workspace-specific RBAC
/// Built-in roles (owner, admin, member, viewer, guest) are read-only
/// Custom roles allow workspace owners to define granular permissions
model CustomRole {
  id          String  @id @default(cuid())
  workspaceId String  @map("workspace_id")
  name        String
  description String?
  permissions Json // Array of permission strings (e.g., ["workspace:read", "records:create"])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@map("custom_roles")
}

// ============================================
// BUSINESS ONBOARDING (EPIC-08)
// ============================================

model Business {
  id          String @id @default(cuid())
  workspaceId String @map("workspace_id")
  userId      String @map("user_id") // Creator

  // Basic info
  name        String
  description String?       @db.Text
  industry    String?
  stage       BusinessStage @default(IDEA)

  // Onboarding tracking
  onboardingStatus   OnboardingStatus @default(WIZARD)
  onboardingProgress Int              @default(0) // 0-100

  // Module status
  validationStatus ModuleStatus @default(NOT_STARTED)
  planningStatus   ModuleStatus @default(NOT_STARTED)
  brandingStatus   ModuleStatus @default(NOT_STARTED)

  // Validation outputs
  validationScore          Int? // 0-100
  validationRecommendation ValidationRecommendation?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workspace      Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  validationData ValidationSession?
  planningData   PlanningSession?
  brandingData   BrandingSession?
  documents      OnboardingDocument[]
  projects       Project[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([userId])
  @@map("businesses")
}

// BMV - Validation Session
model ValidationSession {
  id         String @id @default(cuid())
  businessId String @unique @map("business_id")

  // Idea Intake (Story 08.7)
  ideaDescription   String? @db.Text
  problemStatement  String? @db.Text
  targetCustomer    String? @db.Text
  proposedSolution  String? @db.Text
  initialHypothesis Json? // { value_proposition, revenue_model }

  // Market Sizing (Story 08.8)
  tam Json? // { value, formatted, methodology, confidence, sources[] }
  sam Json?
  som Json?

  // Competitor Mapping (Story 08.9)
  competitors     Json? // [{ name, type, pricing, features, strengths, weaknesses, source_url }]
  positioningMap  Json? // { axes: [], positions: [] }
  opportunityGaps Json? // []

  // Customer Discovery (Story 08.10)
  icps Json? // [{ name, company_size, industry, personas[] }]

  // Validation Synthesis (Story 08.11)
  validationScore Int?
  recommendation  ValidationRecommendation?
  strengths       Json?
  risks           Json? // [{ risk, severity, mitigation }]
  nextSteps       Json?

  // Workflow tracking
  completedWorkflows String[] @default([])
  agentSessionId     String?  @map("agent_session_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  business Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sources  ValidationSource[]

  @@index([businessId])
  @@map("validation_sessions")
}

// Anti-hallucination tracking
model ValidationSource {
  id        String @id @default(cuid())
  sessionId String @map("session_id")

  claimType  String   @map("claim_type") // market_size, competitor, customer
  claim      String   @db.Text
  sourceUrl  String   @map("source_url")
  sourceName String   @map("source_name")
  sourceDate DateTime @map("source_date")
  confidence String // high, medium, low

  createdAt DateTime @default(now()) @map("created_at")

  session ValidationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("validation_sources")
}

// BMP - Planning Session
model PlanningSession {
  id         String @id @default(cuid())
  businessId String @unique @map("business_id")

  // Business Model Canvas (Story 08.14)
  canvas Json? // { customer_segments, value_propositions, channels, ... }

  // Financial Projections (Story 08.15)
  financials Json? // { revenue, costs, pnl, cash_flow, unit_economics }

  // Business Plan (Story 08.16)
  businessPlanUrl String? @map("business_plan_url")
  pitchDeckUrl    String? @map("pitch_deck_url")

  // Workflow tracking
  completedWorkflows String[] @default([])
  agentSessionId     String?  @map("agent_session_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("planning_sessions")
}

// BM-Brand - Branding Session
model BrandingSession {
  id         String @id @default(cuid())
  businessId String @unique @map("business_id")

  // Brand Strategy (Story 08.19)
  positioning     Json? // { archetype, values, personality, positioning_statement, taglines }
  voiceGuidelines Json? // { tone, vocabulary_dos, vocabulary_donts, messaging_templates, content_pillars }

  // Visual Identity (Story 08.20)
  visualIdentity Json? // { colors, typography, logo_concept }

  // Generated Assets (Story 08.21)
  generatedAssets Json? // [{ type, name, url, size, format }]
  assetPackageUrl String? @map("asset_package_url")
  guidelinesUrl   String? @map("guidelines_url")

  // Workflow tracking
  completedWorkflows String[] @default([])
  agentSessionId     String?  @map("agent_session_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("branding_sessions")
}

// Document upload tracking
model OnboardingDocument {
  id         String @id @default(cuid())
  businessId String @map("business_id")

  fileName String @map("file_name")
  fileUrl  String @map("file_url")
  fileType String @map("file_type") // pdf, docx, md
  fileSize Int    @map("file_size")

  // Extraction results
  extractedData    Json?   @map("extracted_data")
  extractionStatus String  @default("pending") @map("extraction_status")
  extractionError  String? @map("extraction_error") @db.Text

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("onboarding_documents")
}

// Business Onboarding Enums (Story 08.1)
enum BusinessStage {
  IDEA
  VALIDATION
  MVP
  GROWTH
  SCALE
}

enum OnboardingStatus {
  WIZARD
  VALIDATION
  PLANNING
  BRANDING
  COMPLETE
}

enum ModuleStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETE
}

enum ValidationRecommendation {
  GO
  CONDITIONAL_GO
  PIVOT
  NO_GO
}

// ============================================
// AGENT CHAT PERSISTENCE (P1 Enhancement)
// ============================================

/// Stores chat messages for agent sessions
/// Enables conversation continuity across page reloads/sessions
model AgentChatMessage {
  id        String @id @default(cuid())
  sessionId String @map("session_id")

  // Message content
  role    ChatMessageRole
  agentId String?         @map("agent_id") // Which agent sent this (vera, marco, etc.)
  content String          @db.Text

  // Optional structured data
  metadata Json? // { suggestedActions: [], attachments: [], etc. }

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId, createdAt])
  @@map("agent_chat_messages")
}

/// Links agent sessions to their source (validation, planning, branding)
model AgentSession {
  id String @id @default(cuid())

  // Which module this session belongs to
  moduleType      AgentModuleType @map("module_type")
  moduleSessionId String          @map("module_session_id") // ValidationSession.id, PlanningSession.id, etc.

  // Session metadata
  currentAgent String?            @map("current_agent") // Currently active agent
  workflowStep String?            @map("workflow_step") // Current workflow step
  status       AgentSessionStatus @default(ACTIVE)

  // Timestamps
  startedAt      DateTime  @default(now()) @map("started_at")
  lastActivityAt DateTime  @default(now()) @map("last_activity_at")
  endedAt        DateTime? @map("ended_at")

  @@index([moduleType, moduleSessionId])
  @@index([status, lastActivityAt])
  @@map("agent_sessions")
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum AgentModuleType {
  VALIDATION
  PLANNING
  BRANDING
}

enum AgentSessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

// ============================================
// CORE-PM: PROJECT MANAGEMENT (bm-pm)
// ============================================

/// Project - Root of PM hierarchy, scoped to Business
model Project {
  id          String @id @default(cuid())
  workspaceId String @map("workspace_id")
  businessId  String @map("business_id")

  // Identity
  slug        String
  name        String
  description String? @db.Text

  // Visual Identity
  color      String  @default("#3B82F6")
  icon       String  @default("folder")
  coverImage String? @map("cover_image")

  // Type Classification
  type ProjectType @default(CUSTOM)

  // BMAD Configuration
  bmadTemplateId String? @map("bmad_template_id")
  currentPhase   String? @map("current_phase")

  // Budget
  budget      Decimal? @db.Decimal(12, 2)
  actualSpend Decimal? @map("actual_spend") @db.Decimal(12, 2)

  // Status
  status     ProjectStatus @default(PLANNING)
  startDate  DateTime?     @map("start_date")
  targetDate DateTime?     @map("target_date")

  // Progress (denormalized for performance)
  totalTasks     Int       @default(0) @map("total_tasks")
  completedTasks Int       @default(0) @map("completed_tasks")
  lastActivityAt DateTime? @map("last_activity_at")

  // Settings
  autoApprovalThreshold Float   @default(0.85) @map("auto_approval_threshold")
  suggestionMode        Boolean @default(true) @map("suggestion_mode")

  // Health tracking (PM-05)
  healthScore     Int?      @map("health_score") // Latest health score
  lastHealthCheck DateTime? @map("last_health_check")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  business        Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  phases          Phase[]
  team            ProjectTeam?
  expenses        ProjectExpense[]
  views           SavedView[]
  pages           ProjectPage[]
  risks           RiskEntry[]
  pmRisks         PmRiskEntry[]
  reportSchedules ReportSchedule[]
  importJobs      ImportJob[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([businessId])
  @@index([status])
  @@index([deletedAt])
  @@index([status, lastHealthCheck]) // Health dashboard: projects needing checks
  @@index([healthScore]) // Health dashboard: sort by score
  @@map("projects")
}

/// ProjectExpense - Manual expense entry for MVP budget tracking
model ProjectExpense {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")

  amount      Decimal  @db.Decimal(12, 2)
  description String?  @db.Text
  spentAt     DateTime @default(now()) @map("spent_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([spentAt])
  @@map("project_expenses")
}

/// Phase - Time-boxed work segment within a Project
model Phase {
  id          String  @id @default(cuid())
  projectId   String  @map("project_id")
  name        String
  description String? @db.Text

  // BMAD Mapping
  bmadPhase   BmadPhaseType?
  phaseNumber Int            @map("phase_number")

  // Timeline
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  // Status
  status PhaseStatus @default(UPCOMING)

  // Progress (denormalized)
  totalTasks      Int @default(0) @map("total_tasks")
  completedTasks  Int @default(0) @map("completed_tasks")
  totalPoints     Int @default(0) @map("total_points")
  completedPoints Int @default(0) @map("completed_points")

  // Health tracking (PM-05)
  healthScore     Int?      @map("health_score") // Latest health score (0-100)
  lastHealthCheck DateTime? @map("last_health_check")

  // Checkpoints (PM-05)
  checkpointDate DateTime? @map("checkpoint_date")

  // Completion (PM-05.2)
  completedAt    DateTime? @map("completed_at")
  completionNote String?   @db.Text @map("completion_note")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks        Task[]
  snapshots    PhaseSnapshot[]
  checkpoints  PhaseCheckpoint[]

  @@index([projectId])
  @@index([status])
  @@map("phases")
}

/// Task - Unit of work with assignment and status
model Task {
  id          String @id @default(cuid())
  workspaceId String @map("workspace_id")
  phaseId     String @map("phase_id")
  projectId   String @map("project_id") // Denormalized for queries

  // Basic Info
  taskNumber  Int     @map("task_number") // Sequential per project: PROJ-001
  title       String
  description String? @db.Text // Rich text markdown

  // Classification
  type     TaskType     @default(TASK)
  priority TaskPriority @default(MEDIUM)

  // Assignment
  assignmentType AssignmentType @default(HUMAN) @map("assignment_type")
  assigneeId     String?        @map("assignee_id") // Human user ID
  agentId        String?        @map("agent_id") // Module agent ID

  // Estimation
  storyPoints     Int?   @map("story_points")
  estimatedHours  Float? @map("estimated_hours")
  actualHours     Float? @map("actual_hours")
  confidenceScore Float? @map("confidence_score") // 0-1, from Sage

  // Status
  status  TaskStatus @default(BACKLOG)
  stateId String?    @map("state_id") // Custom state reference

  // Timeline
  dueDate     DateTime? @map("due_date")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Hierarchy
  parentId String? @map("parent_id")

  // Approval
  approvalRequired Boolean        @default(false) @map("approval_required")
  approvalStatus   ApprovalStatus @default(NOT_NEEDED) @map("approval_status")
  approvedBy       String?        @map("approved_by")
  approvedAt       DateTime?      @map("approved_at")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")

  // Relations
  phase       Phase            @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  parent      Task?            @relation("TaskHierarchy", fields: [parentId], references: [id])
  children    Task[]           @relation("TaskHierarchy")
  activities  TaskActivity[]
  relations   TaskRelation[]   @relation("SourceTask")
  relatedTo   TaskRelation[]   @relation("TargetTask")
  attachments TaskAttachment[]
  comments    TaskComment[]
  labels      TaskLabel[]
  externalLinks ExternalLink[]
  timeEntries TimeEntry[]

  @@unique([projectId, taskNumber])
  @@index([workspaceId])
  @@index([phaseId])
  @@index([projectId])
  @@index([status])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([deletedAt])
  @@index([workspaceId, deletedAt, updatedAt])
  @@index([projectId, deletedAt, updatedAt]) // Health check task queries
  @@map("tasks")
}

/// ProjectTeam - Team assigned to a project
model ProjectTeam {
  id         String @id @default(cuid())
  projectId  String @unique @map("project_id")
  leadUserId String @map("lead_user_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members TeamMember[]

  @@index([leadUserId])
  @@map("project_teams")
}

/// TeamMember - Individual member of a project team
model TeamMember {
  id             String  @id @default(cuid())
  teamId         String  @map("team_id")
  userId         String  @map("user_id")
  role           TeamRole @default(DEVELOPER)
  customRoleName String? @map("custom_role_name")

  // Capacity
  hoursPerWeek Float @default(40) @map("hours_per_week")
  productivity Float @default(0.8)

  // Permissions
  canAssignTasks   Boolean @default(false) @map("can_assign_tasks")
  canApproveAgents Boolean @default(false) @map("can_approve_agents")
  canModifyPhases  Boolean @default(false) @map("can_modify_phases")

  // Status
  isActive Boolean  @default(true) @map("is_active")
  joinedAt DateTime @default(now()) @map("joined_at")

  team ProjectTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@map("team_members")
}

/// TaskActivity - Activity log for tasks
model TaskActivity {
  id     String @id @default(cuid())
  taskId String @map("task_id")
  userId String @map("user_id")

  type TaskActivityType
  data Json?

  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@map("task_activities")
}

/// TaskRelation - Relationships between tasks (blocks, depends on, etc.)
model TaskRelation {
  id           String           @id @default(cuid())
  sourceTaskId String           @map("source_task_id")
  targetTaskId String           @map("target_task_id")
  relationType TaskRelationType @map("relation_type")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  sourceTask Task @relation("SourceTask", fields: [sourceTaskId], references: [id], onDelete: Cascade)
  targetTask Task @relation("TargetTask", fields: [targetTaskId], references: [id], onDelete: Cascade)

  @@unique([sourceTaskId, targetTaskId, relationType])
  @@index([sourceTaskId])
  @@index([targetTaskId])
  @@map("task_relations")
}

/// TaskAttachment - Files attached to tasks
model TaskAttachment {
  id     String @id @default(cuid())
  taskId String @map("task_id")

  fileName String @map("file_name")
  fileUrl  String @map("file_url")
  fileType String @map("file_type")
  fileSize Int    @map("file_size")

  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_attachments")
}

/// TaskComment - Comments on tasks
model TaskComment {
  id       String  @id @default(cuid())
  taskId   String  @map("task_id")
  userId   String  @map("user_id")
  content  String  @db.Text
  parentId String? @map("parent_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  task    Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  parent  TaskComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies TaskComment[] @relation("CommentThread")

  @@index([taskId])
  @@index([userId])
  @@index([parentId])
  @@map("task_comments")
}

/// TaskLabel - Labels/tags for tasks
model TaskLabel {
  id     String @id @default(cuid())
  taskId String @map("task_id")

  name  String
  color String @default("#6B7280")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, name])
  @@index([taskId])
  @@index([name]) // Index for label autocomplete/search queries
  @@map("task_labels")
}

/// ImportJob - Tracks CSV/PM tool imports into projects
model ImportJob {
  id          String       @id @default(cuid())
  workspaceId String       @map("workspace_id")
  projectId   String       @map("project_id")
  source      ImportSource
  status      ImportStatus @default(QUEUED)

  totalRows     Int @default(0) @map("total_rows")
  processedRows Int @default(0) @map("processed_rows")
  errorCount    Int @default(0) @map("error_count")
  mappingConfig Json? @map("mapping_config")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  errors    ImportError[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([status])
  @@map("import_jobs")
}

/// ImportError - Row-level errors for imports
model ImportError {
  id          String @id @default(cuid())
  importJobId String @map("import_job_id")
  rowNumber   Int    @map("row_number")
  field       String?
  message     String
  rawRow      Json?  @map("raw_row")

  createdAt DateTime @default(now()) @map("created_at")

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([importJobId])
  @@map("import_errors")
}

/// IntegrationConnection - Stores provider credentials and status
model IntegrationConnection {
  id          String            @id @default(cuid())
  workspaceId String            @map("workspace_id")
  provider    IntegrationProvider
  status      IntegrationStatus @default(CONNECTED)

  encryptedCredentials String @map("encrypted_credentials") @db.Text
  metadata             Json?  @map("metadata")
  lastCheckedAt        DateTime? @map("last_checked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider])
  @@index([workspaceId])
  @@index([status])
  @@map("integration_connections")
}

/// ExternalLink - Links tasks to external items (issues, PRs, tickets)
model ExternalLink {
  id          String            @id @default(cuid())
  workspaceId String            @map("workspace_id")
  taskId      String            @map("task_id")
  provider    IntegrationProvider
  linkType    ExternalLinkType  @map("link_type")
  externalId  String            @map("external_id")
  externalUrl String?           @map("external_url")
  metadata    Json?             @map("metadata")

  createdAt DateTime @default(now()) @map("created_at")

  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider, externalId, linkType])
  @@index([workspaceId])
  @@index([taskId])
  @@map("external_links")
}

/// SavedView - Saved filter/view configurations
model SavedView {
  id        String @id @default(cuid())
  projectId String @map("project_id")
  userId    String @map("user_id")

  name      String
  viewType  ViewType @default(LIST) @map("view_type")
  filters   Json     @default("{}")
  sortBy    String?  @map("sort_by")
  sortOrder String?  @map("sort_order")
  columns   Json?    // For list view column config
  isDefault Boolean  @default(false) @map("is_default")
  isShared  Boolean  @default(false) @map("is_shared")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([projectId, userId]) // Composite index for filtered queries
  @@index([projectId, isDefault]) // For default view lookups
  @@map("saved_views")
}

/// RiskEntry - Risk tracking for projects (enhanced for PM-05 health monitoring)
model RiskEntry {
  id          String  @id @default(cuid())
  workspaceId String  @map("workspace_id")
  projectId   String  @map("project_id")

  title       String
  description String? @db.Text
  category    String? // technical, schedule, resource, external
  severity    RiskSeverity @default(MEDIUM)
  probability RiskProbability @default(POSSIBLE)
  impact      String? @db.Text
  mitigation  String? @db.Text

  // Health monitoring fields (PM-05)
  riskType      String?   @map("risk_type") // DEADLINE_WARNING, BLOCKER_CHAIN, CAPACITY_OVERLOAD, VELOCITY_DROP
  affectedTasks String[]  @map("affected_tasks") // Array of task IDs
  affectedUsers String[]  @map("affected_users") // Array of user IDs
  detectedAt    DateTime? @map("detected_at")
  acknowledgedBy String?  @map("acknowledged_by")
  acknowledgedAt DateTime? @map("acknowledged_at")

  status     RiskStatus @default(IDENTIFIED)
  ownerId    String?    @map("owner_id")
  resolvedAt DateTime?  @map("resolved_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([workspaceId, projectId])
  @@index([projectId])
  @@index([status])
  @@index([status, severity])
  @@index([detectedAt])
  @@index([projectId, status, detectedAt]) // Risk queries with status filter
  @@map("risk_entries")
}

/// PhaseSnapshot - Point-in-time snapshots of phase progress
model PhaseSnapshot {
  id      String @id @default(cuid())
  phaseId String @map("phase_id")

  snapshotDate    DateTime @map("snapshot_date")
  totalTasks      Int      @map("total_tasks")
  completedTasks  Int      @map("completed_tasks")
  totalPoints     Int      @map("total_points")
  completedPoints Int      @map("completed_points")
  velocity        Float?
  burndownData    Json?    @map("burndown_data")

  createdAt DateTime @default(now()) @map("created_at")

  phase Phase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([snapshotDate])
  @@map("phase_snapshots")
}

/// PhaseCheckpoint - Milestone checkpoints within phases (PM-05)
model PhaseCheckpoint {
  id             String   @id @default(cuid())
  phaseId        String   @map("phase_id")
  name           String
  description    String?  @db.Text
  checkpointDate DateTime @map("checkpoint_date")

  // Status
  status      CheckpointStatus @default(PENDING)
  completedAt DateTime?        @map("completed_at")

  // Reminders (used by PM-05.3)
  remindAt3Days Boolean @default(true) @map("remind_at_3_days")
  remindAt1Day  Boolean @default(true) @map("remind_at_1_day")
  remindAtDayOf Boolean @default(true) @map("remind_at_day_of")

  // Sent tracking (to avoid duplicate reminders)
  reminder3DaysSent Boolean @default(false) @map("reminder_3_days_sent")
  reminder1DaySent  Boolean @default(false) @map("reminder_1_day_sent")
  reminderDayOfSent Boolean @default(false) @map("reminder_day_of_sent")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  phase Phase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([checkpointDate])
  @@map("phase_checkpoints")
}

/// HealthScore - Project health calculations (PM-05)
model HealthScore {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  projectId   String   @map("project_id")

  // Score
  score Int         // 0-100
  level HealthLevel
  trend HealthTrend

  // Factor breakdown
  onTimeDelivery Float @map("on_time_delivery") // 0-1
  blockerImpact  Float @map("blocker_impact") // 0-1
  teamCapacity   Float @map("team_capacity") // 0-1
  velocityTrend  Float @map("velocity_trend") // 0-1

  // Metadata
  riskCount   Int    @map("risk_count")
  explanation String @db.Text

  // Timestamps
  calculatedAt DateTime @default(now()) @map("calculated_at")

  @@index([workspaceId, projectId, calculatedAt])
  @@index([projectId, calculatedAt]) // Health score history queries
  @@map("health_scores")
}

// Core-PM Enums
enum ProjectType {
  COURSE
  PODCAST
  BOOK
  NEWSLETTER
  VIDEO_SERIES
  COMMUNITY
  SOFTWARE
  WEBSITE
  CUSTOM
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum BmadPhaseType {
  PHASE_1_BRIEF
  PHASE_2_REQUIREMENTS
  PHASE_3_ARCHITECTURE
  PHASE_4_IMPLEMENTATION
  PHASE_5_TESTING
  PHASE_6_DEPLOYMENT
  PHASE_7_LAUNCH
  OPERATE_MAINTAIN
  OPERATE_ITERATE
  OPERATE_SCALE
}

enum PhaseStatus {
  UPCOMING
  CURRENT
  COMPLETED
  CANCELLED
}

enum CheckpointStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TaskType {
  EPIC
  STORY
  TASK
  SUBTASK
  BUG
  RESEARCH
  CONTENT
  AGENT_REVIEW
}

enum TaskPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
  NONE
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  REVIEW
  AWAITING_APPROVAL
  DONE
  CANCELLED
}

enum ImportSource {
  CSV
  JIRA
  ASANA
  TRELLO
}

enum ImportStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

enum IntegrationProvider {
  GITHUB
  JIRA
  ASANA
  TRELLO
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum ExternalLinkType {
  ISSUE
  PR
  TICKET
}

enum AssignmentType {
  HUMAN
  AGENT
  HYBRID
}

enum ApprovalStatus {
  NOT_NEEDED
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum TeamRole {
  PROJECT_LEAD
  DEVELOPER
  DESIGNER
  QA_ENGINEER
  STAKEHOLDER
  CUSTOM
}

enum HealthLevel {
  EXCELLENT // 85-100
  GOOD      // 70-84
  WARNING   // 50-69
  CRITICAL  // 0-49
}

enum HealthTrend {
  IMPROVING
  STABLE
  DECLINING
}

enum TaskActivityType {
  CREATED
  UPDATED
  STATUS_CHANGED
  ASSIGNED
  UNASSIGNED
  COMMENTED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  LABEL_ADDED
  LABEL_REMOVED
  RELATION_ADDED
  RELATION_REMOVED
  ESTIMATED
  STARTED
  COMPLETED
  REOPENED
  APPROVAL_REQUESTED
  APPROVED
  REJECTED
}

enum TaskRelationType {
  BLOCKS
  BLOCKED_BY
  DEPENDS_ON
  DEPENDENCY_OF
  RELATES_TO
  DUPLICATES
  DUPLICATED_BY
  PARENT_OF
  CHILD_OF
}

enum ViewType {
  LIST
  KANBAN
  CALENDAR
  TIMELINE
  TABLE
}

enum RiskSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RiskProbability {
  VERY_LIKELY
  LIKELY
  POSSIBLE
  UNLIKELY
  RARE
}

enum RiskStatus {
  IDENTIFIED
  ANALYZING
  MITIGATING
  MONITORING
  RESOLVED
  ACCEPTED
}

// ============================================
// KNOWLEDGE BASE (KB) - Part of Core-PM
// ============================================

/// KnowledgePage - Wiki page with hierarchical structure
model KnowledgePage {
  id          String @id @default(cuid())
  tenantId    String @map("tenant_id")
  workspaceId String @map("workspace_id")

  // Hierarchy
  parentId String? @map("parent_id")

  // Content
  title       String
  slug        String  @db.VarChar(255)
  content     Json    // Tiptap/ProseMirror JSON
  contentText String  @map("content_text") @db.Text // Plain text for FTS
  isTemplate  Boolean @default(false) @map("is_template")
  templateCategory String? @map("template_category") @db.VarChar(100)

  // Verification
  isVerified    Boolean   @default(false) @map("is_verified")
  verifiedAt    DateTime? @map("verified_at")
  verifiedById  String?   @map("verified_by_id")
  verifyExpires DateTime? @map("verify_expires")

  // Ownership
  ownerId String @map("owner_id")

  // Analytics
  viewCount    Int       @default(0) @map("view_count")
  lastViewedAt DateTime? @map("last_viewed_at")

  // Favorites (stored as JSON array of user IDs for MVP)
  // In Phase 2, move to separate UserFavorite table
  favoritedBy String[] @default([]) @map("favorited_by")

  // Yjs State (for real-time collaboration - Phase 2)
  yjsState Bytes? @map("yjs_state")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  parent     KnowledgePage?  @relation("PageHierarchy", fields: [parentId], references: [id])
  children   KnowledgePage[] @relation("PageHierarchy")
  versions   PageVersion[]
  embeddings PageEmbedding[]
  projects   ProjectPage[]
  comments   KBPageComment[]
  mentions   PageMention[]
  activities PageActivity[]

  @@unique([tenantId, workspaceId, slug])
  @@index([tenantId])
  @@index([workspaceId])
  @@index([parentId])
  @@index([ownerId])
  @@index([isVerified])
  @@index([isTemplate])
  @@index([updatedAt])
  @@index([deletedAt])
  // Composite indices for verification queries (cron job and stale detection)
  @@index([isVerified, verifyExpires])
  @@index([workspaceId, deletedAt, updatedAt])
  @@map("knowledge_pages")
}

/// PageVersion - Version history for KB pages
model PageVersion {
  id      String @id @default(cuid())
  pageId  String @map("page_id")
  version Int

  // Content snapshot
  content     Json
  contentText String @map("content_text") @db.Text

  // Metadata
  changeNote  String? @map("change_note") @db.VarChar(500)
  createdById String  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")

  page KnowledgePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, version])
  @@index([pageId])
  @@index([createdAt])
  @@map("page_versions")
}

/// PageEmbedding - Vector embeddings for RAG search
/// Note: Requires pgvector extension - CREATE EXTENSION IF NOT EXISTS vector;
model PageEmbedding {
  id         String @id @default(cuid())
  pageId     String @map("page_id")
  chunkIndex Int    @map("chunk_index")

  // Content
  chunkText String @map("chunk_text") @db.Text

  // Vector embedding (pgvector)
  // Note: vector(1536) for OpenAI ada-002 / text-embedding-3-small
  // Using Unsupported for pgvector type - requires raw SQL for operations
  embedding Unsupported("vector(1536)")

  // Metadata
  embeddingModel String   @default("text-embedding-3-small") @map("embedding_model") @db.VarChar(100)
  createdAt      DateTime @default(now()) @map("created_at")

  page KnowledgePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  // Vector index created via migration:
  // CREATE INDEX idx_embedding_vector ON page_embeddings
  //   USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
  @@map("page_embeddings")
}

/// ProjectPage - Many-to-many link between Projects and KB Pages
model ProjectPage {
  id        String  @id @default(cuid())
  projectId String  @map("project_id")
  pageId    String  @map("page_id")
  isPrimary Boolean @default(false) @map("is_primary")
  linkedBy  String  @map("linked_by") // User who created the link

  createdAt DateTime @default(now()) @map("created_at")

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  page    KnowledgePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([projectId, pageId])
  @@index([projectId])
  @@index([pageId])
  @@index([isPrimary])
  @@map("project_pages")
}

/// KBPageComment - Comments on KB pages (renamed to avoid conflict with TaskComment)
model KBPageComment {
  id       String  @id @default(cuid())
  pageId   String  @map("page_id")
  userId   String  @map("user_id")
  content  String  @db.Text
  parentId String? @map("parent_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  page    KnowledgePage   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  parent  KBPageComment?  @relation("KBCommentThread", fields: [parentId], references: [id])
  replies KBPageComment[] @relation("KBCommentThread")

  @@index([pageId])
  @@index([userId])
  @@index([parentId])
  @@map("kb_page_comments")
}

/// PageMention - @mentions, #task references, [[page links]] in KB content
model PageMention {
  id     String @id @default(cuid())
  pageId String @map("page_id")

  // Mention details
  mentionType KBMentionType @map("mention_type")
  targetId    String        @map("target_id") // User ID, Task ID, or Page ID

  // Position (character offset in content)
  position Int

  createdAt DateTime @default(now()) @map("created_at")

  page KnowledgePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([targetId])
  @@index([mentionType])
  @@index([targetId, mentionType]) // Compound index for getUserMentions/getTaskReferences queries
  @@index([pageId, mentionType]) // Compound index for filtering mentions by page and type
  @@map("page_mentions")
}

/// PageActivity - Activity log for KB pages
model PageActivity {
  id     String @id @default(cuid())
  pageId String @map("page_id")
  userId String @map("user_id")

  type KBPageActivityType
  data Json?

  createdAt DateTime @default(now()) @map("created_at")

  page KnowledgePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("page_activities")
}

// Knowledge Base Enums
enum KBMentionType {
  USER // @username
  TASK // #PM-123
  PAGE // [[Page Title]]
}

enum KBPageActivityType {
  CREATED
  UPDATED
  DELETED
  RESTORED
  VIEWED
  VERIFIED
  UNVERIFIED
  VERIFICATION_EXPIRED
  LINKED_TO_PROJECT
  UNLINKED_FROM_PROJECT
  COMMENTED
}

// ============================================
// PM AGENTS (PM-04)
// ============================================

/// AgentConversation - Chat history per agent per project
model AgentConversation {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  projectId   String   @map("project_id")
  userId      String   @map("user_id")
  agentName   String   @map("agent_name") // 'navi', 'sage', 'chrono'

  // Conversation
  role     ConversationRole // 'USER' | 'AGENT'
  message  String           @db.Text
  metadata Json? // Agent response metadata, tool calls, etc.

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([workspaceId, projectId, agentName])
  @@index([userId, agentName])
  @@index([createdAt])
  @@map("agent_conversations")
}

enum ConversationRole {
  USER
  AGENT
}

/// AgentSuggestion - AI-generated suggestions from agents (PM-04-3)
model AgentSuggestion {
  id          String @id @default(cuid())
  workspaceId String @map("workspace_id")
  projectId   String @map("project_id")
  userId      String @map("user_id")
  agentName   String @map("agent_name") // 'navi', 'sage', 'chrono'

  // Suggestion details
  suggestionType SuggestionType @map("suggestion_type")
  status         SuggestionStatus @default(PENDING)

  title       String
  description String? @db.Text
  reasoning   String  @db.Text
  confidence  Float // 0-1
  priority    String  @default("medium") // 'high', 'medium', 'low'

  // Action payload (JSON with action-specific data)
  actionPayload Json @map("action_payload")

  // Snooze and expiration
  snoozedUntil DateTime? @map("snoozed_until")
  expiresAt    DateTime  @map("expires_at")

  // Acceptance/Rejection
  acceptedAt DateTime? @map("accepted_at")
  rejectedAt DateTime? @map("rejected_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, projectId])
  @@index([userId, status])
  @@index([agentName, status])
  @@index([status, createdAt])
  @@index([expiresAt])
  // Compound index for getSuggestions query (workspaceId + userId + status + expiresAt)
  @@index([workspaceId, userId, status, expiresAt])
  @@map("agent_suggestions")
}

enum SuggestionType {
  CREATE_TASK
  UPDATE_TASK
  ASSIGN_TASK
  MOVE_PHASE
  SET_PRIORITY
  SCHEDULE_TASK
  ADD_DEPENDENCY
  REMOVE_BLOCKER
  GENERAL
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  SNOOZED
  EXPIRED
}

// ============================================
// TIME TRACKING (PM-04-8: Chrono Agent)
// ============================================

/// TimeEntry - Time tracking for tasks
model TimeEntry {
  id          String    @id @default(cuid())
  workspaceId String    @map("workspace_id")
  taskId      String    @map("task_id")
  userId      String    @map("user_id")

  description String?   @db.Text

  // Time tracking
  startTime   DateTime? @map("start_time")
  endTime     DateTime? @map("end_time")
  duration    Float     // Hours (calculated or manual)

  // Manual vs timer
  isTimer     Boolean   @default(false) @map("is_timer")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([taskId])
  @@index([userId])
  @@index([startTime])
  @@index([workspaceId, taskId])
  @@index([workspaceId, userId, startTime])
  @@map("time_entries")
}

// ============================================
// PM REPORTING (PM-05.6: Herald Agent)
// ============================================

/// Report - Generated project reports for status, health, and progress
model Report {
  id              String @id @default(cuid())
  workspaceId     String @map("workspace_id")
  projectId       String @map("project_id")

  // Report details
  type            ReportType
  stakeholderType StakeholderType? @map("stakeholder_type")
  title           String
  content         Json // Structured report content

  // Generation metadata
  generatedBy     String   @map("generated_by") // User ID or 'herald_agent'
  generatedAt     DateTime @default(now()) @map("generated_at")

  // Format
  format          ReportFormat @default(MARKDOWN)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([workspaceId, projectId])
  @@index([projectId, generatedAt])
  @@index([type])
  @@index([stakeholderType])
  @@map("reports")
}

// Report Enums
enum ReportType {
  PROJECT_STATUS
  HEALTH_REPORT
  PROGRESS_REPORT
}

enum ReportFormat {
  MARKDOWN
  JSON
}

enum StakeholderType {
  EXECUTIVE
  TEAM_LEAD
  CLIENT
  GENERAL
}

enum ReportFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

/// ReportSchedule - Automated report generation schedule (PM-05.8)
model ReportSchedule {
  id              String @id @default(cuid())
  workspaceId     String @map("workspace_id")
  projectId       String @map("project_id")

  // Schedule configuration
  frequency       ReportFrequency  @map("frequency")
  reportType      ReportType       @map("report_type")
  stakeholderType StakeholderType? @map("stakeholder_type")
  enabled         Boolean @default(true)

  // Schedule tracking
  lastRun         DateTime? @map("last_run")
  nextRun         DateTime  @map("next_run")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  project         Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([projectId])
  @@index([enabled, nextRun])
  @@index([workspaceId, projectId])
  @@map("report_schedules")
}

// ============================================
// USER PREFERENCES
// ============================================

/// UserPreference - User-specific preferences and settings
model UserPreference {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")

  // Daily Briefing Settings (PM-04-2)
  dailyBriefingEnabled Boolean @default(true) @map("daily_briefing_enabled")
  dailyBriefingHour    Int     @default(8) @map("daily_briefing_hour") // 0-23, user's local hour
  timezone             String  @default("UTC") @map("timezone") // IANA timezone (e.g., "America/New_York")
  emailBriefing        Boolean @default(false) @map("email_briefing") // Send briefing via email

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dailyBriefingEnabled, dailyBriefingHour]) // For cron job queries
  @@map("user_preferences")
}

// ============================================
// PM ANALYTICS - PRISM AGENT (PM-08)
// ============================================

/// PmRiskEntry - Risk entries detected by Prism agent (PM-08-3)
model PmRiskEntry {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  tenantId    String   @map("tenant_id")  // RLS - maps to workspaceId

  source      String   // "PRISM", "PULSE", "MANUAL"
  category    String   // "SCHEDULE", "RESOURCE", "SCOPE", "BUDGET"

  probability Float    // 0.0 - 1.0 (from Monte Carlo distribution)
  impact      Float    // 0.0 - 1.0 (normalized severity)

  description String   @db.Text // Natural language risk description
  mitigation  String?  @db.Text // Suggested mitigation steps

  status      String   // "ACTIVE", "MITIGATED", "ACCEPTED", "DISMISSED"

  // Risk details (category-specific)
  targetDate      DateTime?  @map("target_date")       // Expected completion date
  predictedDate   DateTime?  @map("predicted_date")    // Forecast completion date
  delayDays       Int?       @map("delay_days")        // Days of delay (predictedDate - targetDate)

  baselineScope   Int?       @map("baseline_scope")    // Original scope (story points)
  currentScope    Int?       @map("current_scope")     // Current scope (story points)
  scopeIncrease   Float?     @map("scope_increase")    // Percentage increase

  velocityTrend   String?    @map("velocity_trend")    // "UP", "DOWN", "STABLE"
  velocityChange  Float?     @map("velocity_change")   // Percentage change

  // Metadata
  detectedAt  DateTime @default(now()) @map("detected_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@index([detectedAt])
  @@index([projectId, category, status])  // Composite index for risk queries
  @@map("pm_risk_entries")
}
